[[_hqbird_config]]
= Jobs, monitoring and maintenance configuration in FBDataGuard

Please follow these steps:

. Make sure that you have Firebird 2.5.5 or later (Firebird 2.1 is also supported with some limitation), and it is working;
. HQbird FBDataGuard service is installed and running
+
.. You can check it using Services applet in Control Panel (right-click on "`My Computer`", choose "`Manage`", then "`Services and Applications`", "`Services`" and find in the list "`FBDataGuard Agent`"
.. At Linux you can check it with command `ps aux | grep dataguard`.
. Make sure the FBDataGuard port is accessible (8082) and it is not blocked by firewall or any other antivirus tools. If necessary, adjust port in FBDataGuard configuration file (see <<_hqbird_config_fbdataguard_port,Web-console port>>).


== Launch web-console

To open web-console type in your browser or use IP address of your server with installed HQbird ServerSide.

Or you can choose in "`Start`" menu IBSurgeon\HQbird Server Side\Firebird DataGuard\"Launch the DataGuard web console for localhost".

=== Supported browsers

FBDataGuard web interface works correctly with Firefox, Chrome, Safari and Internet Explorer 11.

=== Error message regarding webs-site certificate

If you have configured FBDataGuard to use https, the browser will indicate that this web-site () is not safe, and it will recommend leaving web-site.
This message is caused by the default security certificate for FBDataGuard web-console.

Please ignore this message and click to open FBDataGuard web-console.

It will ask you for username and password (login dialog can be different for Firefox, Safari or Chrome).

.Enter username and password for FBDataGuard web-console.
image::3.1.1.png[]


.Attention!
[IMPORTANT]
====
Default username/password for HQbird FBDataGuard is "**admin"/"strong password**" (without quotes).
====

=== Auto discovery feature of FBDataGuard

At the first launch FBDataGuard will check computer for installed Firebird servers.
FBDataGuard for Windows search registry for Firebird records, FBDataGuard for Linux checks default locations of Firebird installations.

FBDataGuard will show the list of all Firebird copies installed, but only the one instance of Firebird can be monitored by FBDataGuard.
Choose it by clicking btn:[Add Firebird engine to monitoring >>]

If you don't see Firebird instance in auto discovery list, you can choose btn:[Add custom >>] and configure instance parameters manually.

.Auto discovery feature of HQbird.
image::3.1.2.png[]

<<<

== Overview of web-console.

=== Parts of web-console.

image::3.2.1.png[]

 FBDataGuard Web-console contains 5 tabs (in the left side of the screen, usually they are collapsed):

* _Dashboard_ – it is the main tab where administrator can configure HQbird FBDataGuard and see server and databases statuses.
* _Alerts_ – contains the full list of alerts, generated by FBDataGuard.
* _Registration_ – license and registration/activation information.
* _Graphs gallery_ – performance graphs.
* _Performance_ – performance monitoring settings and performance reports.


=== Jobs

Web-console is intended for easy configuration of activities (called **"`jobs`"**) which are fulfilled by HQbird FBDataGuard.

Almost all FBDataGuard jobs have 2 purposes: the first is to monitor for some values and to raise alerts if necessary, and the second is to store historical values into logs, so later it's possible to see the dynamics of important parameters of Firebird server and database.

In this section we will consider general configuration of jobs parameters, but not an analysis of gathered logs.

=== Jobs widgets

General approach is the following: each activity is represented by a "`widget`", which has the following parts:

.Elements of FBDataGuard web-console widget.
image::3.2.2.png[]

Status -- it is indicated with color icon and name.
Status of database is a summary of all included server-level jobs and databases' statuses, and, respectively, status of database is a summary of all database-level jobs.

=== Status types

*CRITICAL* means problems, *OK* means "`Everything is fine`", *WARNING* means some issues which require attention, MAJOR means major issue, *MINOR* – minor issue, *MALFUNCTION* means that jobs was not succeeded (something prevents its execution), *NOT_AVAILABLE* means that job is not available in this server or database version.

*OFF* means that job is not active, *UNKNOWN* means that job is active but was not started yet, so actual results are unknown.

*Job name* indicates the name of activity.

* image:3.2.3.png[] Configuration button opens configuration dialog, which is individual for each job.
* image:3.2.4.png[] Resolved is the link to flush the status to UNKNOWN and forgot errors which were discovered previously. The status will be updated according the current situation after the next execution of the job.

*Last run* shows the time after the last run of this job.

*Period/Schedule to run* shows how often or when the job will be started.

*More>>* is the link which opens the widget and shows more details and suggested action for administrator to resolve the situation.

All jobs in FBDataGuard have default settings, which are very close to recommended values for the 80% of Firebird installations, so after initial configuration server and database will be protected at pretty good level comparing with default installation, however, we recommend additional configuration and tuning for every job.
In the next sections we will consider each job and its configuration.

<<<

== Firebird server configuration in FBDataGuard

=== Firebird server registration

To register auto-discovered server, you need to click at btn:[Add Firebird
engine to monitoring>>] and then adjust auto-discovered settings.

[NOTE]
====
Note: to use Windows Trusted Authentication (by default it's off), you need to be sure that libraries [path]_jaybird30.dll_ and [path]_fbclient.dll_ (from appropriate Firebird version) are in searchable Windows paths.
====

When installing under Windows, if the option to automatically register the master/replica is selected, the server will be added automatically.
In this case, you can skip this step.
If the option to automatically register a replica is selected, then the database will be added in addition.

Let's consider what can you see in the Server dialog (and, normally, you don't need to change them):

* **Installed in**: Firebird installation folder
* **Binary folder**: Firebird bin folder (for Firebird 3 on Windows Binary folder is the same as the installation folder)
* **Log**: location of [path]_firebird.log_
* **Configuration file**: location of [path]_firebird.conf_
* **Aliases**: location of [path]_aliases.conf_ or, for Firebird 3, [path]_databases.conf_ ( *please change it manually, if needed* )
* **Host**: name of the server, usually localhost
* **Port**: network port for Firebird, according [path]_firebird.conf_ settings
* **Use trusted auth**: use trusted authentication, by default it is off
* **SYSDBA login**: name of SYSDBA user, usually it is SYSDBA
* **SYSDBA password**: password for SYSDBA
* **Output directory**: Folder where backups, statistics and gathered logs will be stored


.Register server in HQbird FBDataGuard.
image::3.1.3.png[]

By default "`Output directory`" for Firebird server is [path]_${agent.default-directory}/${server.id}_, it corresponds to [path]_C:\HQbirdData_ in case of a default installation.

It can be not very convenient, so we recommend pointing FBDataGuard output directory to more simple path, usually located at disk where backups are intended to be stored, for example [path]_F:\myserverdata_.

After clicking "`Register`" FBDataGuard will populate default configurations files and immediately start analysis of [path]_firebird.log_.
It can take a while (for example, 1 minute for 100Mb [path]_firebird.log_). After that you will see initial web-console with registered Firebird server:

.HQbird FBDataGuard with registered Firebird server.
image::3.1.4.png[]

FBDataGuard shows alerts and statuses of monitored objects: if everything is fine, it shows green signs, otherwise there will be yellow or red notifications.

Below we will consider in details each monitored objects and its settings.

[NOTE]
====
Note: you cannot delete registered Firebird server in FBDataGuard web-console.
The only way to unregister server is to delete its configuration files.
In general, there is no reason for deleting registered server, until you want completely uninstall FBDataGuard.
====

=== Server: Active server

Server: Active server widget shows summarized status of all server-level jobs and statuses of monitored databases.

image::3.2.5.png[]

**Server: Active server **also indicates Firebird currently running or not and shows detailed version of Firebird and HQbird.

If you click on *configure* link, you will see the same dialog that we have used to register Firebird instance in FBDataGuard, and now it can be used for changing Firebird instance properties:

image::3.2.6.png[]

In general, there is no need to edit Firebird server details after the registration, until you are not reinstalling Firebird – but in this case we recommend reinstalling HQBird too.

=== Server: Replication Log

image::3.2.11.png[]

If you are using HQbird Enterprise, FBDataGuard can check [path]_replication.log_ for errors.
In case of error it sends an appropriate alert (by email) to the administrator.

To enable this job please check "`Enabled`".

image::3.2.12.png[]


* Check period – how often to check [path]_replication.log_ for changes
* Size to roll, bytes -- if [path]_replication.log_ will exceed will value, it will be renamed according date-time pattern
* Date pattern for rolling – how to rename [path]_replication.log_
* Keep NN error messages: how many errors will be stored in the list of the recent errors.


=== Server: Server log

image::3.2.13.png[]

"`Server log`" job periodically checks [path]_firebird.log_ and if it detects that file was changed, log analysis starts.
The embedded analytic engine checks each entry in [path]_firebird.log_ and categorizes them into several categories with different levels of a severity.
According the severity of messages status of job is assigned and appropriate alerts are generated.

Once administrator has reviewed errors and alerts (and performed necessary actions to solve the reason of error), he need to click on *"`Resolved`"* link and FBDataGuard will forget old error messages in [path]_firebird.log_.

In the configuration dialog of "`Server log`" you can enable/disable this job and set the check period (in minutes).

image::3.2.14.png[]

Also this job watches for the size of [path]_firebird.log_ and if its size exceeds "`Size to roll`", FBDataGuard will split [path]_firebird.log_ and rename it according to the date-time pattern.

=== Server: Temp files

image::3.2.15.png[]

"`Server: Temp files`" job is useful to catch and solve performance problems with Firebird database.

While performing SQL queries Firebird stores intermediate results for sorting and merging data flows in temporary files, which are allocated in specified TEMP locations.
FBDataGuard shows at "`Server: Temp files`" widget information about quantity and size of temporary files.

FBDataGuard recognizes locations of TEMP folders and monitors quantity and size of temporary files.
Lack of space can lead to the performance problem or more serious errors, too many (or too large) temporary files can indicate problems with SQL queries quality.

image::3.2.16.png[]

Using configuration dialog you can enable/disable this job, set period and thresholds to the maximum size of temporary files (size of all files) and quantity.

If you see that size of temp files is too high and if there is enough RAM on the server, increase [parameter]``TempCacheLimit`` parameter in [path]_firebird.conf_ to fit all temporary tables into RAM.

Also, HQbird checks other temp files used by Firebird -- if you see extreme values (several Gb) for trace or monitor, the good idea will be check the FIREBIRD_TMP folder for outdated files (with old modification timestamps). Please note -- the screenshot below is not a real alert (i.e., values are Ok), it was created to demonstrate the output in case of large temporary files.

image::3.2.17.png[]

=== Server: Firebird server folder

"`Firebird server folder`" jobs monitors size, occupied by Firebird installation.
It's enabled by default.

image::3.2.18.png[]

There are several threats prevented by this job: maladministration issues when database volumes or external tables are being created in [path]_%Firebird%\Bin_ folder, very big [path]_firebird.log_ which can exhaust all places at drive with Firebird installation, and some other problems.

Also this job monitors and analyses information, gathered by all space-related jobs (including database-level jobs). At the picture below you can see quick representation of space analysis for all drives where Firebird, databases and backups are stored.

Using configuration dialog you can enable/disable this job, set period of checking and thresholds for server folder size.

image::3.2.19.png[]

By default we use 200 Mb is a standard setting for Firebird installation.

If the size of your Firebird is larger, please consider clean-up of old logs and other unwanted artifacts, or increase parameter *Max
                    occupied* (in bytes) to prevent false alerts.

**Note for Linux users**: if you see red warning regarding the inconsistent space information, add locations with database and backups to Disk Space widget:

image::3.2.20.png[]

You can get idea where is your database and backup is actually located with command ``df –h``.

=== Server: HQbird Output Folder

image::3.2.9.png[]

"`HQbird output folder`" monitoring is intended to watch space occupied by reports, logs, stats, metadata repository and other data, gathered and generated by HQbird – this folder by default is [path]_C:\HQbirdData\output_.

For databases unattended for a long time (1-2 years) it is possible that FBDataGuard logs will occupy too much space and lack of space can lead to database outage.
To prevent it for sure, "`HQbird output folder`" is watching for occupied space.

By default "`HQbird output folder`" job is enabled.

Also, if someone has ignored recommendations to put backups`' folders to the explicit locations, it is possible that database backup will be created inside Agent folder.
In this case you'll see CRITICAL status immediately -- FBDataGuard will recognize and warn you regarding wrong configuration.

And, this job is useful for bundles of FBDataGuard and third-party applications.

In the configuration dialog you can enable/disable this job, set check period (by default it is 10 minutes), and set thresholds for alerts.

Thresholds can be set in % of max size occupied by log or using the explicit size in bytes.

FBDataGuard checks both values and raises alert for the first threshold.
If you wish to set % only, you need to set -1 as value to "`Max occupied`".

image::3.2.10.png[]


== Database configuration in FBDataGuard

=== Firebird database registration

To register database in FBDataGuard, you need to click at the symbol "`Settings`" in the right corner of "`Databases`" (there will be a hint "`Add database to monitoring`") and fill the following form:

.Add database to monitoring.
image::3.1.5.png[]



* "`*Database nick name*`" is for your convenience, it is used to refer this database in alerts and email messages.
* "`*DB alias*`" is a database alias from [path]_aliases.conf_ or in [path]_databases.conf_. If you specify both "`DB Alias`" and "`Path to database`", "`DB Alias`" will be used.
* "`*Path to database*`" is the local path to database (remember that FBDataGuard should work at the same computer with Firebird). If you are putting database on external drive, it can raise error "`File... has unknown partition`". To fix it you need to click on "`Configure`" at Server widget and click "`Save`" to make FBDataGuard re-read partitions.
* "`*Crypt key name*`" – if the database is encrypted, specify encryption key name.
* "`*Crypt key value*`" – if the database is encrypted, specify encryption key value.
* "`*Output folder*`" is the folder where FBDataGuard will store backups, logs and statistics for this database. If you do not select HQbirdData folder during the installation, and if you do not specify output folder for the server, it's a good idea to specify "`Output directory`" to some explicit location like [path]_F:\mydatabasedata_.
* "`*Enable advanced monitoring*`" - see <<_hqbird_advanced_monitor_viewer,Advanced Monitor Viewer>>


[NOTE]
====
You can specify exact absolute locations for backups and statistics later in appropriate dialogs.
====

You can see the list of databases available for registration or their aliases by clicking on the link **View database aliases**.

.Available database aliases.
image::3.1.5-1.png[]

You can see the list of databases available for registration or their aliases by clicking on the link **View open databases**.

After registration, FBDataGuard will populate database configuration with default values and then show web-console with registered database:

.HQbird FBDataGuard web console after adding a database.
image::3.1.6.png[]

You can adjust database settings later; now let's proceed with alerts setup.

=== Database: General configuration

FBDataGuard can monitor several databases at the single server (up to 80 databases). For each database the separate widget is created.
At the top widget database status is shown, database nickname (it's specified during database adding and can be changed). Also database widget shows the full path to the database, its size, status of backups and the number of currently connected users.

image::3.2.21.png[]

Using configuration dialog you can set database nickname, path to database and output folder for the database (to store logs and jobs results).

image::3.2.22.png[]

FBDataGuard checks the validity of path to database and it does not allow specifying the wrong path.

Also, for HQbird Enterprise, in the database widget you can see status of the replication and configure replication by clicking on the icon.
Please read more details in the replication configuration section.

Since HQbird 2020, the database widget in HQbird also shows the encryption status of the database.

=== Database: Transactions

"`Database: Transactions`" job is intended to log transactions activity.
It monitors 2 important intervals: difference between Oldest Active Transaction and Next transaction and gap between Oldest Snapshot and Oldest Interesting.

If these intervals are out of the frames of the specified threshold, it means problem with transactions management.

image::3.2.23.png[]

These logs can be analyzed to get helpful insight regarding database performance and application quality (see more information here http://ib-aid.com/en/articles/ibanalyst-what-you-can-see-at-summary-view/).

This job also monitors the implementation limit in Firebird: maximum transactions number in Firebird versions before 3.0 should be less than 2^31^-1.

Near this number database should be backup and restored.
It will throw an alert if transaction number will be close to the restrictions.
Also, the transaction dynamics is shown on the tab "`Graphs gallery`":

image::3.2.24.png[]

=== Database: Lockprint

"`Lockprint`" job monitors the information from the lock table of Firebird.
It is very important for architectures Classic/SuperClassic and useful for SuperServer.

The lock table is an internal Firebird mechanism to organize access to the objects inside Firebird engine.
HQbird monitors the important parameters of the lock table:

image::3.2.25.png[]


* **Check period**, minutes -- how often HQbird analyses lock table. 3 minutes is an optimal interval.
* *Deadlock Scans threshold* -- deadlock scan is a process, started by Firebird engine, in case of a long response delay from the one of the threads. If a number of deadlock scans is high, it means that Firebird is heavily loaded. The value is accumulated since the Firebird engine start. The default value is pretty big – 12345, so if it is exceeded, it means that database performance is poor.
* *Deadlock threshold* -- if Firebird engine finds the true deadlock during the deadlock scans, it increases this value. Please note: true deadlocks are very seldom. Don't confuse them with transactions' conflicts ("`deadlock. Lock conflict on nowait transaction`" etc).
* *Mutex wait threshold* -- Mutex Wait is a parameter of lock table which implicitly indicates the conflicts for the resources. The higher mutex wait, the more competition exists inside the engine for the resources. By default, the mutex wait threshold is set to 18%, but this value is not universal for all databases. The good approach is to watch for the mutex values during 1-2 weeks and then set the highest value seen during this period. Mutex wait graph is available in Mutex Wait gallery.
+
image::3.2.26.png[]
* **Hash slots alerts**. Lock table header has a parameter "`Hash lengths (min/avg/max): 0/0/4`", it shows the lengths in the lock table. It is important to keep these values as low as possible, so HQbird monitors them and suggest, how to improve the situation, if hash length is more than specified in this job.
* *Owners limit.*"`Owners`" is a number of connections established to the specified database. In fact, this is the fastest way to get the actual number of connections to the database with the minimum load to the database -- other ways like request to `MON$ATTACHMENTS` or [constant]``isc_tpb_database`` have various disadvantages. The limit here should be set according the actual peak number of connections. For example, if you are sure that peak number of the connections to your database is 500, set 550 as Owners limit, and if at some moment the load will increase, you will not miss that moment.
+
image::3.2.27.png[]
* **Free owners**. "`Free owners`" is the value between the peak number of owners and current number of owners. If you see ``Free owners = 0``, it means that number of connections grows steadily since the Firebird start. If you see high number of Free owners, it can be sign that many connections were disconnected recently.
* **Lock table size**. The lock table size is an implicit indicator of the load to the system. Normally, lock table size should be stable. Also, it is recommended to set the initial lock table size to the value it has after some active work period -- though the lock table is enlarged on demand, the re-allocation process is a heavy operation and can lead to micro-freezes in database responses. Lock table graph is useful to determine the proper initial value.
+
image::3.2.28.png[]
* **Lock table queue**. Lock table queue does not have the explicit threshold in Lockprint job, but its values are collected and shown in "`Graphs gallery`". Lock table queue is an indicator of a general load.

image::3.2.29.png[]


=== Database: Index statistics recalculation

"`Database: Index statistics recalculation`" is an important job which helps to keep performance of indices at optimal level, and performs additional checking of a database health.

"`Database: Index statistics recalculation`" allows to run re-computing of indices selectivity values.
During this procedure Firebird quickly walks through leaf pages of indices, and renews statistics about selectivity.
By visiting these pages Firebird also verifies their integrity and if index is corrupted, the warning will be thrown.

Also, this job verifies that all indices are active in database.
Inactive or non-activated indices usually indicate corruption and lead to performance degradation.

By default this job is disabled, but we recommend enabling it after careful selecting of indices for the recalculation.

There are three modes in this job: AUTO, ALL, SELECTED.

ALL is the mode where all indices will be checked.

AUTO is the default mode.
It is very similar to ALL, but it also checks the size of database and do not touch indices if database is bigger than 3.6Gb.

image::3.2.30.png[]

SELECTED is the recommended mode.
It allows choosing of indices which should be recomputed or those which should be avoided.

To include indices into the list of recomputed, you need to specify indices names (divided by comma), and to exclude – perform the same in the appropriate field.

As you can see at configuration dialog screenshot, there are fields to enable/disable job, to set update mode, and to include or exclude indices. "`DB
                    size to switch, bytes`" is to set limit where AUTO mode is working. "`Check index activity`" switch should be always on, until you are not performing special manipulations with inactive indices.

[[_hqbird_config_verified_backup]]
=== Database: Verified Backup

"`Database: Verified Backup`" is one of the key jobs to guarantee the safety of data stored in the protected database.
During the development of HQbird we had in mind certain recovery scenario, and this scenario implies that the key goal of database protection is to minimize potential losses of data.
If we have healthy backup, recovery can be concentrated on saving the most recent data (just entered into the database), and it greatly decreases the time of overall outage.

As you will see below, "`Database: Verified Backup`" is not just a wrapper for standard gbak functionality and scheduler, this is a smart job which has many built-in rules to prevent problems with backups and provide suitable interface for backups management.

[IMPORTANT]
====
"`Database: Verified Backup`" is disabled **by
                        default**, but we strongly recommend reviewing of its settings immediately after HQbird setup.
====

image::3.2.31.png[]

Initially "`Database: Verified Backup`" job is shown as Ok, though backup was not tried.
In this case OK means that backup at least scheduled.

Also this job recognizes files according the name pattern (see below information regarding configuration), and shows the totals number of backups.

After the backup will be done, the widget information will be changed: creation time of last successful backup will be shown, and also the time took to actually perform the backup (only 1 minute 12 seconds at the screenshot with example).

image::3.2.32.png[]

Also, the detailed alert will be send to your email and/or HQbird Control Center:

image::3.2.33.png[]

"`Database: Verified Backup`" checks the free space at the drive with backup destination, and if it detects that there is not enough free disk space, CRITICAL alert will be sent, and current backup will be canceled (if necessary).

[NOTE]
====
Be careful – by default backup time is set to **23-00
                        Monday-Sunday**.

By default, database backups will be stored into the output folder that you have specified during installation step! By default, it is [path]_C:\HQbirdData\output\..._

It is very important to carefully review database backups settings and adjust them according the local configuration!
====

Let`'s consider the configuration dialog for backup in more details:

* *"`Enabled`"* is obvious – it enables or disables scheduled backups
* In the *"`Schedule`"* field you can set the time when backup should be run. Scheduler uses CRON expression and this is a right place to apply all the power of CRON (see <<_hqbird_config_cron_expr,CRON Expressions>>).
* *"`Backups folder`"* specifies the folder to store backups. This folder should be at the same computer where database is. By default, it is situated inside database default directory. Usually it's a good idea to set the explicit path to the folders with backups.
* *"`Maximum number of backup files in folder`"* specifies how many previous backups should be stored. FBDataGuard stores backups in revolver order: when the maximum number will be reached (i.e., 5 backups will be created), FBDataGuard will delete the oldest backup and create the new backup. In combination with CRON expressions it gives a powerful ability to create necessary history of backups.
* *"`Backup name pattern`"* specifies how backup files will be named. Also this name pattern allows FBDataGuard to recognize old backups with the same name pattern.
* *"`Backup extension`"* is fbk by default.
* *"`Compress backups`"* specifies should FBDataGuard archive backups after regular Firebird backup. By default, this option is on, but you need to know that FBDataGuard will zip backups`' files which are less than *100 Gb* in size. After that size, the backup compression will be automatically switched off. We recommend to turn this feature on for small databases only.
* *"`Check restore`"* is an important option. If it is on (by default), FBDataGuard will perform test restore of fresh backup, in order to test its validity. It guarantees the quality of created backup and notifies administrator in case of any problems with test restore.
* *"`Remove restored`"* specifies should FBDataGuard delete restored database. By default it is OFF, so you might want to turn it ON, but you need carefully consider – do you really need to keep the copy of test restored database. With each test restore this copy will be overwritten.
* *"`Use multiple cores to backup and test restore`"* - this feature is for HQbird Enterprise only, it allows to backup database and restore test database using multiple CPU cores, so backup can be made 3-5 times faster. We recommend to allocate ½ of CPU cores,
* *"`Send "Ok" report`"* – by default it is off, but it`'s strongly recommended to turn it ON and start to receive notifications about correct backups. This feature will use email settings from alerts system

image::3.2.34.png[]

If we will click on button btn:[More>>], the advanced backup options will appear:

image::3.2.35.png[]

* *"`Backup (gbak) timeout, minutes`"* - maximum time to complete only backup (``gbak -b``) operation, otherwise alert will be generated.
* *"`Restore (gbak) timeout, minutes`"* – maximum time to complete test restore operation.
* *"`Final destination folder for backups`"* - if you need to make backups into the one folder, and then move created backup to another folder (for long-term storage, for example), you can change the value of this parameter from [path]_${backup-directory}_ to the folder where you will keep them. Backup files in both locations are watched by HQbird FBDataGuard, and included into the count of backup copies shown in the widget.
* *"`Copy backup`"* switch and *"`Copy backup to`"* path. If you have network location or plugged USB drive to store database where you want to store copy of backup (in addition to usual backups), FBDataGuard can copy the latest backup there: just turn on "`Copy backup`" switch and specify *"`Copy backup to`"* path. The copied files are not monitored and not included into the number of backup files shown in the widget.
* *"`Execute shell command`"* switch and *"`Shell command`"* path. It is possible to specify custom script or executable after the general backup procedure will be complete. Shell command gets as the path to the fresh database backup as a parameter.
* *"`Optional path to gbak executable`"* - it is possible to specify other gbak tool than standard [path]_gbak_.
* *"`Backups option for gbak`"* - if you need to add some specific options, add them here.
* *"`Restore options for gbak`"* - if you need to add specific options for test restore, add them here.


[TIP]
====
If you are monitoring more than one database, it is highly recommended splitting the runtime of the restores.
====

==== Important Note: Backup to the network locations

Please be aware that for creating and copying backup to the network locations Firebird and FBDataGuard services must be started under the account with sufficient rights.
By default, Firebird and FBDataGuard are started under LocalSystem account, which does not have rights to access network location.

image::3.2.36.png[]

So, to store Firebird backups to the network location on Windows, run Services applet ([path]_services.msc_) and on the tab Log On change "`Log on as`" to the appropriate account (Domain Admin should be fine).

For Linux – add necessary rights for "`firebird`" user.

[[_hqbird_config_incremental_backup]]
=== Database: Incremental Backup

Incremental backup is a job to schedule and manage incremental backups in Firebird.

Please note that we recommend to use incremental backups only in combination with verified backups, since incremental backup performs coping of database pages changed since the last backup (in case of multilevel incremental backup).

HQbird FBDataGuard implements 2 types of multilevel incremental backup: Simple and Advanced incremental backups, and also Dump backup (see <<_hqbird_config_db_dump_backup,Database: Dump backup>>).

Multilevel backup in Firebird must follow the following steps:

. Create initial backup (level 0) which essentially is the copy of the database at the moment of backup start and mark it with backup GUID.
. Since Firebird marks each data page with a certain identifier at every change, it is possible to find data pages, changed from the moment of previous backup and copy only them to form backup of level 1.
. It is possible to create several level of the backups – for example, the initial backup (full copy, level 0) is being created every week, every day we create level 1 (differences from the level 0), and at every hour we create level 2 backups (differences from daily level 1).

Incremental backup with simple schedule allows planning 3 levels of backups: weekly, daily and hourly.

You can see summary information for such incremental backup configuration at the following screenshot of its widget:

image::3.2.37.png[]

In order to setup Simple incremental backup, click on Settings "`gear`" of the widget and select "`Simple schedule`" (selected by default). The following dialog will appear:

image::3.2.38.png[]

There are 4 main areas in this dialog, let's cover them one by one.

The top area is devoted for general settings of the incremental backup – they are the same for Simple and Advanced schedules:

image::3.2.39.png[]

*Max duration, sec* – it limits the maximum duration of backup process, by default is 1 day (86400 seconds).

*Minimum free disk space (bytes)* – minimal size of free disk space to prevent backup to start, by default ~9Mb

**Backup folder – **where incremental backup for the selected database will be stored.
It is necessary to store incremental backups for each database separately from backups of other databases: i.e., the separate folder for each database.

It is necessary to specify backup folder with enough free disk space to store all level of backups!

**Journal name**–file name details information about incremental backups files, for internal use only.

*Path to nBackup* – it is possible to specify other nbackup tool than standard [path]_nbackup_ (not recommended).

*Backup name pattern* – pattern for files of incremental backup (no need to change it).

*Options* – additional options for nbackup command line tool (no need to change it).

*Do not check existence of backup files* – this option should be checked if you plan to delete or more incremental backups to another location.

*Do not check GUID chain* – this option should be checked if you want to skip existence check of previous levels of incremental backups.

*Immediately create non-existing low-level backups* – by default this option is __On__.
It means that if you have scheduled the initial start moment of level 1 backup earlier than the initial start moment of level 0 backup, DataGuard will automatically fix it and create level 0 backup right before level 1.
The following backups of level 0 will be fulfilled according the regular schedule.

*Send OK email for levels 0, 1, 2* – enable this option to receive notifications about incremental backups (__highly recommended__!)

After setting main set of parameters the schedule itself should be set.
As you can see on the screenshot below, you need to specify day of the week and time to do level 0 (weekly) backup, days of week and time to start level 1 (daily) backups and hours and minutes of level 3 (hourly backups).

For each backup level you can specify how many files to keep in history.

image::3.2.40.png[]

By default it is set to keep 5 weekly backups, 7 daily and 24 hourly backups.

However, sometimes more flexible schedule is required, for this purpose Incremental Backup widget has Advanced schedule:

image::3.2.41.png[]

As you can see, the upper part of the configuration screen is the same as in Simple schedule, and the difference is in the way how backup levels are scheduled.

Advanced schedule allows to setup up to 5 levels of backup, and plan them with flexible <<_hqbird_config_cron_expr,CRON expressions>>.

For example, you can setup it to create full copy (level 0) backup every 3 months, level 1 copy every month, level 2 – every week, level 3 every day and level 4 – every hour.

[TIP]
====
If you are monitoring more than one database, it is highly recommended splitting the runtime of the backups.
====

[[_hqbird_config_db_dump_backup]]
=== Database: Dump Backup

This job also utilizes nbackup functionality in Firebird, but unlike multilevel backups, it always performs a full copy (level 0) of the database.
Such job is useful to quickly create a copy of working database.

The configuration of Database: Dump backup is trivial:

image::3.2.42.png[]

You just need to setup when and where DataGuard should copy a full copy (level 0 incremental backup), and how many copies it should keep.

=== Database: Delta

If you are using incremental backups (or Dump backup), this job is critically important.
It watches for delta-files lifetime and size, and warns if something goes wrong.
Forgotten delta-files are the often reason of corruptions and significant losses of data.

This jobs finds all delta files associated with database and check their age and size.
If one of these parameters exceeds thresholds "`Maximum delta
size`" or "`Maximum delta age`", administrator will receive the alert and database status will be set to CRITICAL.

[NOTE]
====
If delta file of the protected database was corrupted, it is possible to extract data from it using metadata from the original database file or repository from "`Low-level metadata backup`" job.
====

image::3.2.56.png[]

=== Database: RestoreDB

One of the often tasks of the database administrators is restoring database from the backup.
There could be many reason to do restore, the most popular reasons are regular check of the stored backups and necessity to have fresh restored copy for quick rollback.
HQbird FBDataGuard can automate restoring of backups (which were created with gbak or Database: Verified backup) with *Database: RestoreDB* job.
Let's consider the options and parameters of this job.

image::3.2.43.png[]

By default, restore is disabled – and, since restoring can be long and resource-consuming job, please plan when to restore carefully.

The database can be restored from different types of backups.
To specify which types of backups are used during recovery, use the *Restore Source* switch.

Below you can see the configuration dialog for **Database: RestoreDB** in **nbackup** mode:

image::3.2.44-0.png[]

In **gbak** mode, the configuration dialog for **Database: RestoreDB** looks like this:

image::3.2.44.png[]

* "`*Scheduled*`" field contains <<_hqbird_config_cron_expr,CRON expression>> which defines when to run restore.
* "`*Get backup from folder*`" - specify the location of backup file(s) to be restored. If you are restoring backups at the same computer where they have been created, specify the same folder as it is in Database: Verified backup job. If you are restoring backups from the another computer, specify the folder where those backups are located.
* "`*Take backup not older than, hours*`" - this parameter specifies the maximum age of backup to be restored. If the latest backup file will be older than specified number of hours, RestoreDB job will send the alert with warning that backup is too old. This is useful for automatic checking of backups created on the remote computer.
* "`*Restore source*`" specifies what types of backups will be used to restore the database .
* "`*Datatime pattern for nbackup*`" contains the template for backup names made with nbackup.
It should be the same as *Backup name pattern* see <<_hqbird_config_incremental_backup,Database: Incremental Backup>>.
* "`*Template for gbak backup file name*`" contains the template for backup names. It should be the same as *Backup name pattern* see <<_hqbird_config_verified_backup, Verified backup>>.
* "`*Backup gbak file extension*`" - by default it is fbk
* "`*Use NN CPU cores to restore*`" - only available in gbak mode.
* "`*Restore options*`" - only available in gbak mode.
* "`*Restore to directory*`" - folder where FBDataGuard will restore backups.
* "`*Restore with filename*`" - template for the restored database file. By default it contains the following parts
+
** ${db.id}_{0,date, yyyyMMdd_HH-mm}_testrestore.fdb
** Db.id – internal identifier of the database (GUID)
** 0,date, yyyyMMdd_HH-mm – timestamp
** testrestore.fdb – description (You can set there any filename you need).
* "`*When existing database found*`" - if FBDataGuard will encounter a file with the same name as restored database in the destination folder, by default it will rename the existing file. If you want to replace old restored file with new one, choose "`Replace existing file`".
* "`*Append suffix to filename when rename*`" - if you have chosen "`Rename existing file`", this suffix will be used to rename it. If you have chosen "`Replace existing file`", this suffix also will be used to rename, but after that the old file will be deleted.
* "`*Execute command after restore*`" - in this field you can specify an optional path to the command file or another utility to be started after the restore. There will be 2 parameters passed: the first is the path to the backup which was just restored, and the second is the path to the restored file.
* "`*Restore timeout, minutes*`" - here you can set the time limit for restore operation. If this limit will be exceeded, the warning will be sent, saying that restore takes too long.
* "`*Check available space before restore (bytes)*`" - here you can set the limit for the minimal free space in the restore destination – if there is less free space than specified, restore will not start, and associated warning will be sent.
* "`*Notify on successful restore*`" - send email about successful restore (by default it is off, only alerts about problems will be sent).


[[_hqbird_config_cloud_backup]]
=== Database: Transfer Replication Segments

The purpose of "Transfer Replication Segments" job is to send replication segments produced by async replication from master to replica server. In the case of distributed environment of the
asynchronous replication, when the network connection between master and replica server is unstable, or with high latency, or when servers are in the different geographical regions, the best way to transfer replication segments will be through FTP or FTP over SSH.

Below we will consider how to setup Cloud Backup for this task.

First, the asynchronous replication master should be configured to save replication segments into the some local folder – by default, it will be [path]_${db.path}.LogArch_ – as it is shown in the example below:

image::3.2.45.png[]


.Transfer Replication Segments configuration
image::3.2.46.png[]

Then we can setup *Transfer Replication Segments* job to monitor this folder for the new replication segments and upload them to the remote FTP server.

As you can see at the screenshot above, Cloud backup job checks folder, specified in "`*Monitor this folder*`" with an interval, specified in "`*Check period, seconds*`".
Please note – Cloud Backup sends files in the order of their names, not dates.

To check that transferred files are valid replication segments, and to support automatic re-initialization of the replica databases, the checkmark "`*Enable/disable replication cloud backup job*`" must be enabled.

By default, Cloud Backup compresses and encrypts replication segments before send them.
The default password is "`*zipmasterkey*`" (without quotes), which can be specified in the field "`*Compress with optional password*`".
FBDataGuard creates the compressed and encrypted copy of the replication segment and upload it to the specified target server.

To disable packing and encryption, uncheck the "`*Compress with optional password*`" checkmark.

==== FTP/FTPS/FTPS over SSH

There are several types of target servers: FTP, FTP over SSL/TLS, FTP over SSH.
When you select the necessary type, dialog shows mandatory fields to be completed.

You can select up to 5 simultaneous remote servers to upload backups.
Below you can see the configuration dialog for FTP.

image::3.2.47.png[]


[NOTE]
====
If you don't have FTP installed on the target server with Windows, install Filezilla – it is very popular fast and lightweight FTP-server for Windows.
====

[NOTE]
====
Replication segments will be uploaded to the subdirectory specified in the "`Upload to folder`".
By default, this is [path]_/dababase0/${db.id}_, where [replaceable]``db.id`` is the identifier of the database inside the DataGuard.
The replica about this [replaceable]``db.id`` does not know anything, so you need to register it manually in "`Unpack to directory`" (see <<_hqbird_config_cloud_backup_receiver,File  Receiver>>).
====

===== FTP over SSL/TLS

image::3.2.48.png[]

In order to send files to FTPS, it is necessary to create jks storage with private key file, and specify path to it in the field "`Key store file`" and password for it in "`Key store password`".

See details and example how to create jks file and password here: http://xacmlinfo.org/2014/06/13/how-to-keystore-creating-jks-file-from-existing-private-key-and-certificate/

The last part of parameters in Cloud Backup dialog allows controlling the behavior of Cloud backup.

* *Delete local prepared copy* – by default it is On. This parameter specify that Cloud backup job deletes compressed copy of the replication segment after the successful upload to the target server. If you don't want to keep these copies on the master server, keep the parameter enabled.
* *Delete local prepared file copy* – by default is Off. It means status means that replication segment will be not deleted by FBDataGuard after uploading. It can be useful if you want to keep the full history of changes in replication segments, but, be careful; in case of an intensive write activity replication segments can occupy a lot of space (Terabytes).
* *Send Ok report* – send email to the specified in Alerts address every time when replication segment is uploaded. By default it is off.

As a result, FBDataGuard will upload encrypted and compressed replication segments to the remote server.
To decompress and decrypt them into the regular replication segments, another instance of HQbird FBDataGuard should be installed on the replica server, and Cloud Backup Receiver job should be configured – see more details in the section <<_hqbird_config_cloud_backup_receiver,Database: File Receiver>>.

===== FTP over SSH

image::3.2.49.png[]

To use FTP over SSH with private key authentication, please specify the full path to it in "`Key store file`", other parameters are similar to usual FTP.

[[_hqbird_config_transfer_files]]
=== Database: Transfer Files

The purpose of "Transfer Files" job is to send backup files from master to replica server. In the case of distributed environment, when the network connection between master and replica server is unstable, or with high latency, or when servers are in the different geographical regions, the best way to transfer files will be through FTP or FTP over SSH.

Below we will consider how to setup "Transfer Files" for this task.

First, the database server should be configured to save backup files into the some local folder — by default, it will be `${db.default-directory}/backup` — as it is shown in the example below:

.Transfer File configuration
image::3.2.49-1.png[]

Then we can setup *Transfer Files* job to monitor this folder for the new backup files and upload them to the remote FTP server.

As you can see at the screenshot above, *Transfer Files* job checks folder, specified in “Monitor this folder” with an interval, specified in **“Check period, seconds”**. Please note – Transfer Files sends files in the order of their names, not dates.

By default, Transfer Files compresses and encrypts backup files before send them. The default password is “**zipmasterkey**” (without quotes), which can be specified in the field “**Encrypt when compressing**”. FBDataGuard creates the compressed and encrypted copy of the backup and upload it to the specified target server.

To disable encryption, uncheck the “**Encrypt when compressing**” checkmark.


==== FTP/FTPS/FTPS over SSH

There are several types of target servers: FTP, FTP over SSL/TLS, FTP over SSH.
When you select the necessary type, dialog shows mandatory fields to be completed.

You can select up to 5 simultaneous remote servers to upload backups.
Below you can see the configuration dialog for FTP.

image::3.2.49-2.png[]


[NOTE]
====
If you don't have FTP installed on the target server with Windows, install Filezilla – it is very popular fast and lightweight FTP-server for Windows.
====

[NOTE]
====
Replication segments will be uploaded to the subdirectory specified in the "`Upload to folder`".
By default, this is [path]_/dababase0/${db.id}_, where [replaceable]``db.id`` is the identifier of the database inside the DataGuard.
The replica about this [replaceable]``db.id`` does not know anything, so you need to register it manually in "`Unpack to directory`" (see <<_hqbird_config_cloud_backup_receiver,File  Receiver>>).
====

===== FTP over SSL/TLS

image::3.2.49-2.png[]

In order to send files to FTPS, it is necessary to create jks storage with private key file, and specify path to it in the field "`Key store file`" and password for it in "`Key store password`".

See details and example how to create jks file and password here: http://xacmlinfo.org/2014/06/13/how-to-keystore-creating-jks-file-from-existing-private-key-and-certificate/

The last part of parameters in Cloud Backup dialog allows controlling the behavior of Cloud backup.

* *Delete local prepared copy* -- by default it is On. This parameter specifies that Transfer Files job deletes compressed copy of the file after the successful upload to the target server. If you don't want to keep these copies on the master server, keep the parameter enabled.
* *Delete local prepared file copy* -- by default is Off. It means status means that file will be not deleted by FBDataGuard after uploading. It can be useful if you want to keep the full history of changes in files, but, be careful; in case of an intensive write activity such files can occupy a lot of space (Terabytes).
* *Send Ok report* -- send email to the specified in Alerts address every time when replication segment is uploaded. By default, it is off.
* *Perform fresh backup* -- disabled by default. Transfer Files remembers the last number of file it sends. If you need to start again from scratch, from file 1, enable this parameter. Please note that it will automatically become disabled after the resetting of the counter.

As a result, FBDataGuard will upload encrypted and compressed files to the remote server.
To decompress and decrypt them into the regular files, another instance of HQbird FBDataGuard should be installed on the replica server, and File Receiver job should be configured -- see more details in the section <<_hqbird_config_cloud_backup_receiver,Database: File Receiver>>.

===== FTP over SSH

image::3.2.49-4.png[]

To use FTP over SSH with private key authentication, please specify the full path to it in "`Key store file`", other parameters are similar to usual FTP.

==== Sending verified and incremental backups through Cloud Backups

Cloud Backup also can be used to send any files to FTP/FTPS/etc.
For example, you can setup Cloud Backup to look for FBK files, produces by Verified Backup Job, and schedule to upload to the remote FTP server.

It is necessary to remember that number of stored backups should be less than the number of files to be preserved by Cloud Backup (specified in the parameter "`How many files to keep`".
By default, Cloud Backup keeps 10 last sent files, and Verified backup has 5 most recent backup files, so it work Ok, but if you will reduce the number of kept files in Cloud Backup, it will delete extra files according "`Filename template`".

The same can be done for incremental backups.

[[_hqbird_config_pump_files]]
=== Database: Pump Files

The purpose of the "Pump Files" task is to transfer files from one directory accessible to the DataGuard to some other location, usually remote, with the possibility of using various methods that can be connected to the DataGuard in the form of plugins and selectable in the task configuration with the ability to set unique for each plugin parameters. HQbird includes two file transfer plugins: fpt and sftp. There are other file transfer plugins. Transfer plugins are jar files and are located in the `Firebird DataGuard/plugins` folder.

Let's consider the options and parameters of this job.

.Options available for the ftp file transfer plugin.
image::3.2.62.png[]

* *Filemask to pump* -- whitelist, according to which files are selected for copying. Represent masks of file names. Must be separated by comma.
* *Exclude file-mask* -- blacklist is a mask of file names that should be excluded from the transfer. The blacklist takes precedence over the whitelist.
* *Pump method* -- file transfer method (plugin).

.Options available for the sftp file transfer plugin.
image::3.2.63.png[]

The algorithm of this task is as follows:

. At each iteration of the task, a list of files is generated for the directory for monitoring files to be sent.
Masks are used to select the list of files: "Filemask to pump" and "Exclude file-mask".
. For each selected file (from the list from step 1, in ascending date order from the lastModified file), the following is performed:
.. If the packing option is set, the file is packed (if the file is not of zero size).
The name of the packed file is formed by adding a hardcoded extension: `.zipfilepump`. The file is packed in the same directory.
If the file turns out to be of zero size, the algorithm will consider that the file has not been completed yet and will interrupt sending the rest of the files with a corresponding message.
.. The file sending task is configured for one of several possible sending options using optional plugins (see below).
Depending on whether the packing option was enabled or not, the original or packed file is sent using the specified algorithm (in the current version it is ftp or sftp).
.. After sending, if the packing option was selected, the packed file is deleted.
.. The original file is renamed by adding the extension `.fuploaded`.
. The algorithm proceeds to send the next file from the list. The total number of files sent during the iteration and their original (unpacked) size are summed up for display in the widget
. Upon completion of sending all files from the generated list, the directory is revolving cleaned, from which files are deleted by mask `*.fuploaded`.
That is, a list of all such files is created, it is sorted by the time of the last modification, and all old ones are deleted, except for the last "Keep NN files".
+
Upon completion of sending, if the "Send OK-report on every pump" checkbox is checked, then the user will be sent a report on the number and size of files sent at the current iteration.


[[_hqbird_config_cloud_backup_receiver]]
=== Database: File Receiver

In general, Cloud Backup Receiver is designed to decompress files from zip archives, and the most often it is used in the pair with Cloud Backup to transfer archived replication segments.

Cloud Backup Receiver checks files in the folder specified in "`*Monitor directory*`", with interval equal to "`*Check periods, minutes*`".
Its checks only files with specified mask according "`*Filename template*`" (*arch* by default) and specified extension ([path]_.replpacked_ by default), and if it encounters such files, it decompresses and decrypts them with the password, specified in "`*Decrypt password*`", and copies to the folder, specified in "`*Unpack to directory*`".

If parameter "`*Monitor for replication*`" is enabled, Cloud Backup Receiver also will check that received file is actually a replication segment (it has specific header), and if it is not, it will raise an appropriate warning.

image::3.2.50.png[]

There are the following additional parameters:

* *Alert if number of unpacked files more than* – by default is 30. If there is a long queue of replication segments to be unpacked, it can be a problem with a replica database, so HQbird sends alert to attract administrator`'s attention.
* *Warn if the newest file in unpack folder is older than (minutes)* – if the most recent file (usually, replication segment) is too old (more than 360 minutes), the replication process can be broken, and HQbird sends an appropriate alert.
* *Send Ok report* – by default it is Off. If it is On, HQbird sends an email about each successful unpacking of the segment. It can be too often for replication segments, because they are arriving every 30-180 seconds, and Ok for normal files like verified or incremental backups.
* *Perform fresh unpack* – disabled by default. Cloud Backup Receiver remembers the last number of replication segment it unpacked. If you need to start unpacking from scratch, from segment 1 (for example, after re-initialization of replication), enable this parameter. Please note that it will automatically become disabled after the resetting of the counter.

After setup of Cloud Backup Receiver, configure the replica to look for replication segments: set in the "`Log archive directory`" the same path as in "`Cloud Backup Receiver`" -> "`Unpack to directory`".

image::3.2.51.png[]

==== Embedded FTP server

HQbird has embedded FTP server, which is off by default.
It is suitable to use embedded FTP server to receive replication segments.

In order to enable embedded FTP server, it is necessary to edit the [path]_ftpsrv.properties_ configuration file, which is located in [path]_C:\HQbirdData\config_ or [path]_/opt/hqbird/ftpsrv.properties_

By default, it contains the following:
[source]
----

#path in ftpsrv.homedir must be escaped "ftpsrv.homedir=c:\\ftp\\pub"

# or backslashed for ex: "ftpsrv.homedir=c:/ftp/pub"

ftpsrv.enable = false

ftpsrv.port = 8721

ftpsrv.defuser=admin2

ftpsrv.defpsw=strong password2

ftpsrv.homedir=
----

It is necessary to change **ftpsrv.enabled **to *true* and specify the home directory for FTP in *ftpsrv.homedir* parameter.
Also, it is recommended to use non-default username and password.

After that, restart FBDataGuard service, and check availability of the FTP.

.Attention -- Linux users!
[IMPORTANT]
====
On the Linux, FBDataGuard service runs under *firebird* user, so FTP home directory also should have permission for user **firebird**.
====

=== Database: Low-level metadata backup

"`Database: Low level metadata backup`" is one of the key jobs of DataGuard, it ensures database protection at low level.

First of all, this job stores raw metadata in special repository, so in case of heavy corruption (due to hardware failure, for example) of database it is possible to use this repository to recover database.

The second purpose of this job is to constantly check all important system tables for consistency.
Every 20 minutes it walks through all important system tables in the database and ensures that there are no errors at metadata level.

The third purpose is to warn administrator about too many formats for each tables.

There is an implementation limit in Firebird to have 256 formats per table, however even several formats can greatly increase a chance of hard corruption and can slow down the performance.
It is recommended do not change tables structure at production database and keep only one format per each table.
If it`'s not possible, administrator should try to perform backup/restore more often to transform all formats into the single one.

image::3.2.52.png[]


=== Database: Validate DB

Validation of Firebird database requires exclusive access: i.e., no users should be connected during validation. "`Database: Validate DB`" job shuts down the database and performs validation of database, and then turns it on.

By default, this job is OFF.
Please consider carefully, is it possible to provide exclusive access for database.
Validation can also take significant time.

image::3.2.53.png[]

Using configuration dialog, you can enable/disable this job, set time to run, set the shutdown timeout (time to wait before launch validation), and also shutdown mode (FORCE, ATTACH, TRANSNATIONAL). If you have no deep knowledge n what you are doing, it's better to keep default parameters.

"`Database: Validate DB`" will send alert with critical status if there will be any errors.

Also, Firebird will write errors into [path]_firebird.log_, and they will appear in the alerts generated by "`Server log`" job.

=== Database: Sweep Schedule

FBDataGuard includes special job to run an explicit sweep, in case if automatic sweep was disabled.
By default, job is disabled.

image::3.2.54.png[]

The recommendation is to schedule explicit sweep with disconnection of long-running transactions for all databases where such transactions are detected.
The recommended period is once per day (usually during the night, after backup's completing).

By default, sweep is set to 23-00, which can be not a good time, because default verified backup starts at the same time, so better change it.

image::3.2.55.png[]

Please note: by default, check mark "`*Disconnect all
                        connections with long-running active transactions before
                    sweep*`" is enabled.
It means that HQbird will find and disconnect long-running transactions (more than 30 minutes) before sweep -- in order to make sweep efficient.
If long-running active transactions will be not disconnected, sweep cannot clean old records versions.

"`*Do not disconnect processes with name
                        pattern*`" -- in this parameter specify SIMILAR TO expression for processes names which will be not disconnected.
By default, we exclude [app]``gbak``, [app]``gstat`` and [app]``fbsvcmgr`` processes.

"`*Disconnect all processes older than
                        (minutes)*`" -- HQbird will disconnect processes which have long-running active writeable transactions, by default threshold is 30 minutes.
The practical upper limit for this parameter is 1440 minutes (it is highly unlikely that transaction does something useful more than 1 day).

"`*Use multiple cores to sweep*`" -- HQbird Enterprise can use multiple cores to perform sweep operation, in order to make sweep 4-6 times faster.
We recommend to specify no more than 1/2 CPU cores in case of the single database on the server, or
1/4 of CPU cores if there are several databases.
For example, if you have 16 cores and 1 big database, set this parameter to 8, if there are several big databases, set 4.

=== Database: Disk space

This job watches for all objects related with database: database files (including volumes of multi-volume database), delta-files, backup files and so on.

"`Database: Disk space`" job analyzes the growth of database and estimate will there be enough free space for the next operation like backup (including test restore) on the specific hard drive.

It generates several types of alerts.
Problems with disk space are in the top list of corruption reasons, so please pay attention to the alerts from this job.

This job also contributes data to the server space analysis graph ().

By default, this job is enabled.

Using configuration dialog, you can specify check period and thresholds for free space.
The first reached threshold will be alerted.
To set threshold only in % of disk space, you need to set explicit space in bytes to 0.

image::3.2.57.png[]

=== Database: Database statistics

This job is very useful to capture performance problems and perform overall check of database at low-level without making backup.

image::3.2.58.png[]

We recommend running this job every day and storing a history of statistics report.

Then, with HQbird Database IBAnalyst it is possible to find problems with database performance and get useful recommendations how to fix them.

[NOTE]
====
As a useful side effect, [app]``gstat`` visits all database pages for tables and indices, and ensures that all of them are correct.
====

=== Database: Replica Check

This task allows you to check the availability of the replica database.
After a specified period, it changes the value of the specified generator and compares the value of the generator on the replica side and the master database.

image::3.2.58-1.png[]

*Min diff to alert* -- the difference between the values of the generator on the master and replica side, after which alter are sent.

<<<

== Email alerts in HQbird FBDataGuard

FBDataGuard can send alerts by email to administrator(s): such alerts contain information about successful backups and potential and real problems with databases.

General properties for notifications can be set by clicking on the server name (or computer name) at the top of the web-console:

image::3.1.7-0.png[]

After that you will see the configuration dialog for common alerts settings:

image::3.1.7-1.png[]

Descriptions of some of the properties you can set here:

* "`*Installation name*`" is some readable name for your convenience; it will be referred in emails and alerts.
* "`*Installation GUID*`" is a service field; there is no need to change it.
* "`*Web console background color*`" – often it is useful to adjust the color of HQbird web interface to distinguish them easily.

It's a good idea to enable setup email alerts.
To do this you need to click on the envelope button in the top of the web-console:

image::3.1.7.png[]

After that you will see the configuration dialog for alerts:

.Email alerts configuration dialog in FBDataGuard.
image::3.1.8.png[]

First of all, you need to enable alerts sending by enabling checkbox "`Send alerts by e-mail`".

* "`*Send alerts by email*`" - enable email alerts and configure email settings below.
* "`*Send alerts to*`" specify where to send emails.
* "`*From field*`" is what will be set as sender in the email.
* "`SMTP server address`", "`SMTP server port`", "`SMTP server login`" and "`SMTP server password`" are data which will be used to send emails.

Before saving the settings, you can click the "Send Test Message" button, if the settings are correct, you should receive a letter to the specified address.

In order to limit the number of letters, you can collect messages into groups and send them in batches. To do this, set "Group notifications in emails" checkbox. It will also help bypass some of the atni-spam systems that can blacklist you due to too frequent send emails.

Click "`Save`" to save email alerts settings.

<<<

== FBDataGuard tips&tricks

FBDataGuard allows changing its setting not only through web-console, but also using direct modification of configuration files.
This can be useful when you need to install FBDataGuard in silent mode (no interaction with user), to bundle it with third-party software, or to perform some fine configuration adjustments.

=== Path to FBDataGuard configuration

During the start FBDataGuard looks for in registry for configuration and output paths:

image::3.2.61.png[]

These values specify the paths to FBDataGuard configuration and output folder -- these values are chosen during installation.

[[_hqbird_config_fbdataguard_port]]
=== Adjusting web-console port

One of the most frequently asked questions is how to adjust port for web-console application (by default it is 8082), It can be done by changing port setting in file [path]_%config%\agent\agent.properties_ ([var]``%config%`` is [path]_C:\HQbirdData\config_ or [path]_/opt/hqbird/conf_).
----

server.port = 8082  #change it
----

[var]``%config%`` - folder to store configuration information, it is specified in .

=== How to change password for Admin user

You can specify its password in the file [path]_access.properties_ (in [path]_C:\HQbirdData\config_ or [path]_/opt/hqbird/conf_)
----

access.login=admin

access.password=youradminpasswordforhqbird
----

After setting the password, restart FBDataGuard, and new password will be encrypted and applied.

=== Guest user for HQbird FBDataGuard

There is read-only user to access HQbird FBDataGuard, with the name guest.
----

access.guest-login=guest

access.guest-password=yournewpassword
----

<<<

[[_hqbird_config_cron_expr]]
== Appendix: CRON Expressions

All jobs in FBDataGuard have time settings in CRON format.
CRON is very easy and powerful format to schedule execution times.

=== CRON Format

A CRON expression is a string comprised of 6 or 7 fields separated by white space.
Fields can contain any of the allowed values, along with various combinations of the allowed special characters for that field.
The fields are as follows:

[cols="1,1,1,1", frame="topbot", options="header"]
|===
| Field Name
| Mandatory
| Allowed Values
| Allowed Special Characters


|Seconds
|YES
|0-59
|, - * /

|Minutes
|YES
|0-59
|, - * /

|Hours
|YES
|0-23
|, - * /

|Day of month
|YES
|1-31
|, - * / L W

|Month
|YES
|1-12 or JAN-DEC
|, - * /

|Day of week
|YES
|1-7 or SUN-SAT
|, - * / L #

|Year
|NO
|empty, 1970-2099
|, - * /
|===

So cron expressions can be as simple as this: `\* * * * ? *` or more complex, like this: `0 0/5 14,18,3-39,52 ? JAN,MAR,SEP MON-FRI
                2002-2010`

=== Special characters

** `\*` (__"`all values`"__) -- used to select all values within a field.
For example, "`*`" in the minute field means __"`every minute`"__.

** `?` (__"`no specific value`"__) -- useful when you need to specify something in one of the two fields in which the character is allowed, but not the other.
For example, if I want my trigger to fire on a particular day of the month (say, the 10th), but don't care what day of the week that happens to be, I would put "`10`" in the day-of-month field, and "`?`" in the day-of-week field.
See the examples below for clarification.

** `-` -- used to specify ranges.
For example, "`10-12`" in the hour field means __"`the hours 10, 11 and 12`"__.

** `,` -- used to specify additional values.
For example, "`MON,WED,FRI`" in the day-of-week field means __"`the days Monday, Wednesday, and
                    Friday`"__.

** `/` -- used to specify increments.
For example, "`0/15`" in the seconds field means __"`the seconds 0, 15, 30, and 45`"__.
And "`5/15`" in the seconds field means __"`the seconds 5, 20, 35, and 50`"__.
You can also specify "`/`" after the "`*character – in this
                        case *`" is equivalent to having "`0`" before the "`/`". "`1/3`" in the day-of-month field means __"`fire every 3 days starting on the first day of the
                        month`"__.

** `L` (__"`last`"__) -- has different meaning in each of the two fields in which it is allowed.
For example, the value "`L`" in the day-of-month field means _"`the last day of the
                        month`"_ -- day 31 for January, day 28 for February on non-leap years.
If used in the day-of-week field by itself, it simply means "`7`" or "`SAT`".
But if used in the day-of-week field after another value, it means _"`the last xxx day of the
                        month`"_ -- for example "`6L`" means __"`the last Friday of the month`"__.
When using the "`L`" option, it is important not to specify lists, or ranges of values, as you'll get confusing results.

** `W` (__"`weekday`"__) -- used to specify the weekday (Monday-Friday) nearest the given day.
As an example, if you were to specify "`15W`" as the value for the day-of-month field, the meaning is: __"`the nearest weekday to the 15th of the
                        month`"__.
So if the 15th is a Saturday, the trigger will fire on Friday the 14th.
If the 15th is a Sunday, the trigger will fire on Monday the 16th.
If the 15th is a Tuesday, then it will fire on Tuesday the 15th.
However, if you specify "`1W`" as the value for day-of-month, and the 1st is a Saturday, the trigger will fire on Monday the 3rd, as it will not "`jump`" over the boundary of a month's days.
The "`W`" character can only be specified when the day-of-month is a single day, not a range or list of days.

[NOTE]
====
The "`L`" and "`W`" characters can also be combined in the day-of-month field to yield "`LW`", which translates to __"`last weekday of the month`"__.
====

** `#` -- used to specify "`the nth`" XXX day of the month.
For example, the value of "`6#3`" in the day-of-week field means _"`the third Friday of
                        the month`"_ (day 6 = Friday and "`#3`" = the 3rd one in the month). Other examples: "`2#1`" = the first Monday of the month and "`4#5`" = the fifth Wednesday of the month.
Note that if you specify "`#5`" and there is not 5 of the given day-of-week in the month, then no firing will occur that month.

[NOTE]
====
The legal characters and the names of months and days of the week are not case sensitive.
MON is the same as mon.
====

=== CRON Examples

Here are some full examples:

[cols="1,1", frame="topbot", options="header"]
|===
| Expression
| Meaning


|``0 0 12 * * ?``
|Fire at 12pm (noon) every day

|``0 15 10 ? * *``
|Fire at 10:15am every day

|``0 15 10 * * ?``
|Fire at 10:15am every day

|``0 15 10 * * ? *``
|Fire at 10:15am every day

|``0 15 10 * * ? 2005``
|Fire at 10:15am every day during the year 2005

|``0 * 14 * * ?``
|Fire every minute starting at 2pm and ending at 2:59pm, every
                                    day

|``0 0/5 14 * * ?``
|Fire every 5 minutes starting at 2pm and ending at 2:55pm,
                                    every day

|``0 0/5 14,18 * * ?``
|Fire every 5 minutes starting at 2pm and ending at 2:55pm,
                                    AND fire every 5 minutes starting at 6pm and ending at 6:55pm,
                                    every day

|``0 0-5 14 * * ?``
|Fire every minute starting at 2pm and ending at 2:05pm, every
                                    day

|``0 10,44 14 ? 3 WED``
|Fire at 2:10pm and at 2:44pm every Wednesday in the month of
                                    March.

|``0 15 10 ? * MON-FRI``
|Fire at 10:15am every Monday, Tuesday, Wednesday, Thursday
                                    and Friday

|``0 15 10 15 * ?``
|Fire at 10:15am on the 15th day of every month

|``0 15 10 L * ?``
|Fire at 10:15am on the last day of every month

|``0 15 10 ? * 6L``
|Fire at 10:15am on the last Friday of every month

|``0 15 10 ? * 6L 2002-2005``
|Fire at 10:15am on every last Friday of every month during
                                    the years 2002, 2003, 2004 and 2005

|``0 15 10 ? * 6#3``
|Fire at 10:15am on the third Friday of every month

|``0 0 12 1/5 * ?``
|Fire at 12pm (noon) every 5 days every month, starting on the
                                    first day of the month.

|``0 11 11 11 11 ?``
|Fire every November 11th at 11:11am.
|===

[IMPORTANT]
====
Pay attention to the effects of '?' and '*' in the day-of-week and day-of-month fields!
====

=== Notes

Support for specifying both a day-of-week and a day-of-month value is not complete (you must currently use the '?' character in one of these fields).

Be careful when setting fire times between mid-night and 1:00 AM - "`daylight
                    savings`" can cause a skip or a repeat depending on whether the time moves back or jumps forward.

More information is here http://www.quartz-scheduler.org/docs/tutorials/crontrigger.html

