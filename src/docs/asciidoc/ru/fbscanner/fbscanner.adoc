== Мониторинг с помощью HQbird FBScanner

=== Что такое FBScanner?

FBScanner (Firebird Scanner) -- это инструмент, включенный в расширенный дистрибутив HQbird, который может отслеживать и просматривать весь трафик между серверами Firebird и InterBase и их клиентскими приложениями.

Он показывает активность подключенных клиентов в реальном времени:

* Соединения (IP/имя, продолжительность, загрузка процессора),
* Запросы (текст запроса, статус, параметры)
* Транзакции (с параметрами).

FBScanner может регистрировать весь SQL-трафик в текстовых файлах и во внешней базе данных Firebird. Он включает модуль FBScanner LogAnalyzer для анализа производительности SQL.

FBScanner можно использовать для профилирования приложений баз данных, мониторинга активности пользователей и управления подключениями к базе данных (включая отключения клиентов на архитектурах Classic, SuperClassic и SuperServer). Он также идеально подходит для устранения ошибок INET, а также для аудита существующих приложений и настройки производительности.

FBScanner поддерживает Firebird (V1.x, V2.0, V2.1 и V2.5), InterBase (от V4.0 до 2009/XE3). Это полезный инструмент для анализа производственных баз данных, особенно если приложение разработано сторонней организацией и исходный код отсутствует.

FBScanner прозрачен в отношении приложения базы данных и не требует каких-либо изменений в исходном коде, логике или конфигурации приложения или базы данных.

=== Проблемы, которые FBScanner может помочь решить

* Мониторинг соединений в режиме реального времени. FBScanner показывает все подключения к выбранному серверу базы данных: IP/DNS-имя подключенного клиента, базу данных и время подключения.
* Мониторинг SQL-запросов в режиме реального времени. Для каждого соединения FBScanner показывает все текущие SQL-запросы вместе с параметрами их транзакций.
* Обнаружение самого старого соединения и самой старой активной транзакции, что позволяет вам проанализировать, что транзакция может иметь неоптимальное поведение или неправильный дизайн транзакции, или показать пользователей, которые могут использовать приложение таким образом, который может повлиять на производительность.
* Отключения клиентов. Проверка правильности выполнения отключений. Вы также можете использовать FBScanner для отключения пользователей для выполнения обслуживания или обновления базы данных.
* FBScanner позволяет маршрутизировать определенные приложения или отдельных пользователей, чтобы вы могли увеличить масштабируемость конкретных приложений или пользователей.
* Вы можете регистрировать SQL-запросы. Для отладки или в целях безопасности FBScanner может регистрировать весь выбранный трафик в специальную базу данных для дальнейшего анализа. FBScanner включает в себя инструмент LogAnalyzer для поиска плохих запросов и неэффективных планов SQL.

=== Влияние на производительность

FBScanner ничего не меняет в передаваемом SQL-трафике и работает просто как прозрачный прокси, поэтому все приложения будут работать нормально.

FBScanner потребляет примерно 50-150Мб памяти (для 30-100 активных клиентов), известно, что FBScanner добавляет примерно 150мс на каждый оператор SQL.

=== Как настроить FBScanner на локальном компьютере?

Чтобы настроить FBScanner, запустите "`FBScanner Service Settings`" из меню "`Пуск`" menu:IBSurgeon[HQbird Server Side > Firebird SQL Scanner]. тот инструмент поможет вам настроить как базовые, так и расширенные параметры конфигурации для FBScanner.

Основные параметры конфигурации отображаются на главном экране "`FBScanner Configuration`". Он сканирует реестр Windows на наличие установленных служб Firebird и отображает их в таблице.

image::4.3.1.png[]

По умолчанию Firebird использует порт 3050 для сетевых подключений.

FBScanner работает как прозрачный TCP-прокси -- он перенаправляет весь SQL-трафик от клиентов к Firebird.

FBScanner предлагает изменить порт Firebird на 3053, чтобы запустить собственный экземпляр на порту 3050. FBScanner проверяет использование порта, и если 3050 или 3053 используются другим программным обеспечением (не Firebird), он предупредит вас красной надписью "`Port used`" рядом с полем "`Port`".

Зеленый рисунок в центре главного экрана "`FBScanner Configuration`" кратко показывает, как будет передаваться SQL-трафик клиентских приложений.

На рисунке ниже вы можете видеть, что FBScanner обнаружил экземпляр Firebird 1.5 и предлагает изменить его порт на 3053, чтобы настроить собственный экземпляр на прослушивание порта 3050.

Такой сценарий по умолчанию обеспечит максимальную совместимость с существующими клиентами Firebird (т. е. приложениями конечного пользователя).

Чтобы утвердить изменения, нажмите "`Ok`", в противном случае -- "`Cancel`".

[IMPORTANT]
====
Если настройки FBScanner были изменены, служба FBScanner будет перезапущена, а все существующие соединения Firebird будут разорваны! Будьте осторожны при изменении настроек FBScanner в производственной среде. FBScanner запросит ваше разрешение на перезапуск, пожалуйста, принимайте решение обдуманно.
====

=== Как настроить FBScanner для удаленном компьютере?

FBScanner может маршрутизировать SQL-трафик не только как локальный прокси, но и с другого компьютера. Чтобы понять разницу и обнаружить последствия, давайте разберемся в деталях.

Базовая (и по умолчанию) конфигурация FBScanner подразумевает, что он работает на том же компьютере, на котором работает Firebird, и обрабатывает весь SQL-трафик от клиентов Firebird (т. е. приложений конечного пользователя), которые используют строку подключения по умолчанию (и, следовательно, порт 3050).

image::4.3.2.png[]

Иногда не удобно настраивать FBScanner на обработку всех запросов, например, в случае:

* Необходимо профилировать/логировать только несколько (возможно, одну) рабочих станций.
* Необходимо профилировать только определенное приложение или узкую функциональность
* Разработчикам необходимо проверить некоторый код SQL в действующей базе данных -- собрать статистику выполнения SQL, планы и т. д.
* Большая нагрузка (слишком много рабочих станций). В случае большой нагрузки FBScanner может потреблять ресурсы основного сервера, поэтому лучше перенести FBScanner (а также журнал FBScanner, если он включен, на выделенный компьютер).
* Linux-сервер. Если Firebird работает в Linux, можно маршрутизировать SQL-трафик через удаленный экземпляр FBScanner в Windows.

В таких случаях хорошей идеей будет настроить FBScanner на удаленном компьютере и пропускать через него только часть SQL-трафика. Это также позволяет выполнить необходимый анализ SQL без изменения портов или другой конфигурации на сервере -- единственной необходимой корректировкой будет изменение имени хоста в строках подключения клиентских приложений.

Одним из частых вариантов использования FBScanner в удаленной конфигурации является использование его в качестве консоли отладки для компьютера разработчика, чтобы разработчик мог видеть в режиме реального времени (с помощью FBScanner LogViewer) или впоследствии (с помощью FBScanner LogAnalyzer) все SQL-запросы со своего компьютера на сервер Firebird.

На рисунке ниже вы можете увидеть, как это может выглядеть:

image::4.3.3.png[]

Теперь вернемся к настройке и посмотрим, насколько легко настроить FBScanner для маршрутизации SQL-трафика на удаленном компьютере.

В нижней части главного экрана "`FBScanner Configuration`" вы можете увидеть следующие настройки по умолчанию (для примера Firebird 1.5, который мы рассматривали выше):

image::4.3.4.png[]

Чтобы настроить FBScanner для маршрутизации SQL-трафика на удаленный Firebird, нам нужно изменить "`Server Type`" с "`Local...`" на "`Remote`". Это изменит главный экран инструмента конфигурации.

Прежде всего, нам необходимо указать сетевое имя (или IP) компьютера с экземпляром Firebird и порт, на котором он будет использоваться -- его необходимо ввести в текстовое поле "`Interface`".

Затем нам нужно указать версию Firebird -- в нашем примере это Firebird 1.5.

Экземпляр FBScanner также имеет "`Interface`" -- это список сетевых адаптеров, обнаруженных на компьютере. Если вам нужно привязать FBScanner к одному из них и отключить подключения от других сетевых адаптеров, выберите один из адаптеров из раскрывающегося списка. По умолчанию FBScanner принимает запросы клиентов Firebird от всех сетевых адаптеров.

Ниже вы можете увидеть пример конфигурации FBScanner для маршрутизации SQL-трафика на удаленный экземпляр Firebird, который находится на компьютере *myserver1* и работает через порт 3050.

image::4.3.5.png[]

Нажмите "`Ok`", чтобы подтвердить новые настройки, и FBScanner направит SQL-запросы на удаленный Firebird.

[IMPORTANT]
====
Если вам необходимо передать трафик SQL от клиентских приложений через удаленный FBScanner, измените соответствующую строку подключения Firebird. Например, если изначально клиентские приложения подключались к "`*myserver1:C:\Database\data.fdb*`", чтобы передать SQL-трафик через FBScanner в этом примере, вам необходимо изменить строку подключения на "`*computer1:C:\Database\data.fdb*`" (где `computer1` -- сетевое имя компьютера, на котором работает FBScanner).
====

=== Как настроить логирование?

В меню "`Пуск`" запустите "Firebird Scanner > FBScanner Settings", затем нажмите кнопку "`Advanced options`" (в правом нижнем углу главного экрана).

image::4.3.6.png[]

В диалоговом окне выберите вкладку "`SQL log`".

image::4.3.7.png[]

По умолчанию ведение журнала отключено.

[IMPORTANT]
====
Важно понимать, что при журналировании в базу данных SQL будут записываться все операции SQL, включая транзакции, соединения и т. д. Это означает, что база данных журналов SQL будет потреблять то же количество ресурсов (ЦП, жесткий диск и т. д.), что и основная база данных. В связи с этим для сред с высокой нагрузкой мы рекомендуем использовать удаленную настройку FBScanner для ведения журнала SQL.
====

Есть два варианта ведения журнала: в файл и в базу данных журналов Firebird.

==== Логирование в текстовые файлы

Логирование в файлы создает текстовый файл для каждого соединения, в котором FBScanner записывает операторы SQL и транзакции. Мы рекомендуем логирование в файлы в целях отладки и во время разработки -- оно подходит для исследования линейного кода SQL. Если подключений много, логирование в файлы становится не очень подходящим.

Чтобы включить ведение журнала в файлы, установите переключатель рядом с опцией "`File`" и укажите папку, в которой будут храниться файлы журналов (сначала проверьте, существует ли указанная папка!):

image::4.3.8.png[]

Затем нажмите "`Ok`".

[IMPORTANT]
====
Включение ведения журнала потребует перезапуска службы FBScanner, поэтому все текущие соединения будут разорваны. FBScanner немедленно попросит вашего разрешения сделать это.
====

==== Пример логирования в текстовые файлы

Для следующих команд в `isql`

[listing]
----
Use CONNECT or CREATE DATABASE to specify a database

SQL> connect "localhost:E:\Temp\TEST15_2.FDB";
Database:  "localhost:E:\Temp\TEST15_2.FDB"

SQL> create table t1(i1 integer, c1 varchar(150));
SQL> create table t2(i2 integer, b1 blob);
SQL> select count(*) from t1;

COUNT
============
0

SQL> insert into t1(i1, c1) values(1, 'test');
SQL> select count(*) from t1;

COUNT
============
1

SQL> exit;
----

FBScanner создал следующий журнал:

[listing]
----
/* Log created by FBScanner v2.7.19
14.01.2011 16:06:07
	  Client IP      = 127.0.0.1
	  Client Name    = ibsurgeon3
	  Client Process = isql [1884]
*/
CONNECT '127.0.0.1/3053:E:\Temp\TEST15_2.FDB' USER 'SYSDBA';

/* 14.01.2011 16:06:09 */
/* TrID=20; */
SET TRANSACTION READ WRITE WAIT SNAPSHOT;

/* 14.01.2011 16:06:09 */
/* TrID=22; isc_tpb_version1, isc_tpb_write, isc_tpb_read_committed, isc_tpb_wait,
   isc_tpb_no_rec_version */
SET TRANSACTION READ WRITE WAIT ISOLATION LEVEL READ COMMITTED NO RECORD_VERSION;

/* 14.01.2011 16:06:19 */
/* QrID=26 TrID=22; EXECUTE */
create table t1(i1 integer, c1 varchar(150));

/* 14.01.2011 16:06:19 */
/* QrID=26 TrID=22; INFO */

/* 14.01.2011 16:06:19 */
/* TrID=22; */
COMMIT;

/* 14.01.2011 16:06:33 */
/* TrID=27; isc_tpb_version1, isc_tpb_write, isc_tpb_read_committed, isc_tpb_wait,
   isc_tpb_no_rec_version */
SET TRANSACTION READ WRITE WAIT ISOLATION LEVEL READ COMMITTED NO RECORD_VERSION;

/* 14.01.2011 16:06:33 */
/* QrID=31 TrID=27; EXECUTE */
create table t2(i2 integer, b1 blob);

/* 14.01.2011 16:06:33 */
/* QrID=31 TrID=27; INFO */

/* 14.01.2011 16:06:41 */
/* TrID=32; isc_tpb_version1, isc_tpb_write, isc_tpb_read_committed, isc_tpb_wait,
   isc_tpb_no_rec_version */
SET TRANSACTION READ WRITE WAIT ISOLATION LEVEL READ COMMITTED NO RECORD_VERSION;

/* 14.01.2011 16:06:41 */
/* QrID=36 TrID=20; EXECUTE */
select count(*) from t1;

/* 14.01.2011 16:06:41 */
/* QrID=36 TrID=20; INFO */

/*
	Fetch count     = 1
*/

/* 14.01.2011 16:07:11 */
/* QrID=38 TrID=20; EXECUTE */
insert into t1(i1, c1) values(1, 'test');

/* 14.01.2011 16:07:17 */
/* QrID=40 TrID=20; EXECUTE */
select count(*) from t1;

/* 14.01.2011 16:07:17 */
/* QrID=40 TrID=20; INFO */

/*
	Fetch count     = 1
*/

/* 14.01.2011 16:07:26 */
/* TrID=32; */
COMMIT;

/* 14.01.2011 16:07:26 */
/* TrID=27; */
COMMIT;

/* 14.01.2011 16:07:26 */
/* TrID=20; */
COMMIT;
----

Как видите, лог в файл полезен для понимания того, как команды SQL выполнялись внутри одного соединения.

==== Логирование в базу данных Firebird

Прежде чем начать работу с журналом SQL, необходимо понять некоторые детали реализации, которые могут быть важны для производственных систем.

В основном запись в базу данных Firebird осуществляется простым способом: служба FBScanner записывает весь трафик во внешнюю базу данных Firebird. База данных Firebird с журналом может находиться на том же компьютере, где находится FBScanner, или на удаленном компьютере.

Примите во внимание следующие требования к настройке журнала SQL:

* База данных журналов (и соответствующий экземпляр Firebird) должна быть в формате Firebird 2.5 (начиная с FBScanner 2.7.15). Если вы вынуждены использовать FBScanner на компьютере с другой версией Firebird, вам необходимо использовать Firebird 2.5 embedded для хранения журнала.
* SQL-трафик от всех зарегистрированных соединений записывается в единую таблицу с соответствующими маркерами (с какого компьютера, приложения, пользователя и т.д. была создана данная конкретная запись).
* База данных журналов может потреблять значительное количество ресурсов в случае большой нагрузки. В случае большого количества подключений рекомендуется настроить базу данных журналов FBScanner и Firebird на выделенном компьютере.
* Во многих случаях протоколировать все соединения нет необходимости, поскольку они повторяют один и тот же набор SQL-запросов. Тщательное исследование отдельного соединения может оказаться наиболее эффективным способом обнаружения проблем с производительностью.

Чтобы включить ведение журнала SQL, выберете "`SQL`" в переключателе. Это активирует соответствующие текстовые поля и элементы управления.

image::4.3.9.png[]

Прежде всего, нажмите кнопку "`Edit`".

image::4.3.10.png[]

[IMPORTANT]
====
Если вы собираетесь использовать один и тот же экземпляр Firebird для регистрации трафика SQL, вам необходимо указать строку подключения с явным портом.
В нашем примере это будет порт 3053, а строка подключения будет иметь вид `127.0.0.1/3053:C:\FBScanner_log.fdb`
====

В этом диалоговом окне вам также необходимо указать, как подключиться к базе данных с журналом.

Если базы данных с указанным именем нет, создайте новую базу данных -- нажмите "`Create database log`".

Проверьте соединение с базой данных журналов -- нажмите "`Test connection`".

Нажмите "`Ok`", чтобы сохранить настройки.

==== Маркеры транзакций

FBScanner может собирать информацию о маркерах транзакций (так же, как это делает IBSurgeon Transaction Monitors). Собранная информация будет отображаться в виде графиков в FBScanner Log Analyzer.

Для этой цели FBScanner запускает отдельное соединение, для которого требуются логин, пароль и путь к соответствующей клиентской библиотеке (если вы отслеживаете Firebird 1.5 с помощью FBScanner, потребуется `fbclient.dll` из 1.5).

Если вы решили собирать информацию о маркерах транзакций, отметьте флажок "`Collect transactions counters info`" и заполните поля "`Login`", "`Password`" и "`Client DLL`".

==== Использование Firebird 2.5 embedded для журнала SQL

Если вам необходимо использовать журнал SQL на компьютере, где используется старая версия Firebird (1.0, 1.5, 2.0, 2.1 или даже InterBase), для хранения журнала рекомендуется использовать Firebird 2.5 Embedded.

Вы можете загрузить Firebird 2.5 Embedded по адресу https://www.firebirdsql.org[www.firebirdsql.org].

Распакуйте архив прямо в папку FBScanner (по умолчанию `C:\Program Files\IBSurgeon\Firebird Scanner`) и переименуйте `fbembed.dll` в `fbclient.dll`.

Структура папок будет выглядеть так

image::4.3.11.png[]

После этого запустите "`Advanced options`", вкладка "`SQL logging`", переключатель "`SQL`" и нажмите "`Edit`", затем в "`Client library`" укажите переменованный файл `fbclient.dll`, как показано ниже.

image::4.3.12.png[]

[TIP]
====
В Embedded Firebird `fbclient.dll` представляет собой весь движок.
Он работает внутри процесса FBScanner и не взаимодействует с другими установленными экземплярами Firebird, как полными, так и встроенными.
====

=== Как проанализировать журнал FBScanner?

Многие пользователи рассказали нам, что не осознают, сколько запросов, транзакций и других операций выполняет их программное обеспечение. Как вы помните, FBScanner хранит всю информацию в одной таблице. Эта таблица использует ссылки на саму себя для уменьшения объема хранимой информации, что затрудняет чтение и понимание необработанного журнала.

Для облегчения анализа журналов мы создали в FBScanner новый модуль -- LogAnalyzer. Он доступен в IBSurgeon Deploy Center для всех пользователей FBScanner (в разделе "`Download`").

LogAnalyzer требует Firebird 2.5 для работы с базой данных журналов. Он также создает новые индексы и выполняет сложные запросы для отчетов, поэтому рекомендуется следующая процедура:

. Настройте ведение журнала и сбор статистики минимум за 1 день.
. Скопируйте базу данных журналов на другой компьютер с Firebird 2.5
. Подключитесь к копии базы данных журналов и выполните анализ на компьютерах разработчика.
. При необходимости скопируйте обновленные версии баз данных журналов.

Чтобы проанализировать базу данных журналов, запустите LogAnalyzer и нажмите "`Connect to FBScanner log base`", затем заполните параметры подключения и выберите базу данных журналов.

image::4.3.13.png[]

При первом запуске LogAnalyzer создаст необходимые индексы, это может занять несколько минут.

После этого LogAnalyzer отобразит последний доступный день в журнале на вкладке "`Server Load`":

image::4.3.14.png[]

Вкладка "`Server Load`" показывает, сколько SQL-запросов было выполнено в минуту и сколько времени потребовалось для их выполнения. Фактически он показывает загрузку сервера, то есть количество запросов и время их выполнения.

Увеличьте масштаб (кнопка в левом верхнем углу вкладки "`Server load`"), перетащите график, удерживая правую кнопку мыши, и выберите пик, который вы хотите исследовать -- щелкните правой кнопкой мыши, чтобы открыть всплывающее меню.

image::4.3.15.png[]

Он покажет вам вкладку "`All statements`", где вы можете просматривать SQL-запросы.

image::4.3.16.png[]

Выберите любой запрос, чтобы просмотреть его текст и, если функция ведения журнала плана включена, его план.

Чтобы проследить за ходом выполнения, вы можете щелкнуть запрос правой кнопкой мыши и найти соединение и транзакцию для этого запроса.

image::4.3.17.png[]

LogAnalyzer выделяет запросы в одной транзакции жирным шрифтом:

image::4.3.18.png[]

Вы можете отсортировать запросы и, например, найти запрос с наибольшим временем выполнения:

image::4.3.19.png[]

Чтобы узнать больше об этом запросе, дважды щелкните его и просмотрите более подробную информацию.

image::4.3.20.png[]

=== Как отслеживать ошибки 10054, отключения и неудачные попытки входа в систему?

FBScanner автоматически регистрирует все 10054 ошибки, отключения и неудачные попытки входа в систему с подробным описанием в файле `FBScanner.log`, который находится в главном каталоге FBScanner.

[listing]
----
19.08.2010 21:43:09
	Connect Error
	  Client IP      = 192.10.1.2
	  Client Name    =
	  DB Name        =
	  DB User        = MORTON
	  Client Process = SUPC [5520]
	  Client Process (by fbclient) = E:\TEMP\TEST1.EXE [5520]
	  STATUS         = [file  is not a valid database]


19.08.2010 21:43:25
	Login Failed
	  Client IP      = 127.0.0.1
	  Client Name    = ibsurgeon3
	  DB Name        = C:\Program Files\Jupiter2010\Data\data.gdb
	  DB User        = MORTON
	  Client Process = Jupiter.exe [3032]
	  Client Process (by fbclient) = E:\TEMP\TEST1.EXE [3032]
	  STATUS         = [Your user name and password are not defined.
Ask your database administrator to set up a Firebird login.]
----

=== Операции Backup/restore и массовой загрузки

Для выполнения операций, не требующих мониторинга или отладки, таких как резервное копирование и восстановление или массовая загрузка записей (в биллинговых системах), мы рекомендуем обходить сервис FBScanner.

Если FBScanner установлен в рекомендуемой конфигурации по умолчанию, т. е. на порту 3050, а Firebird -- на порте 3053, строки подключения должны быть такими:

[listing]
----
server_name/3053:Disk:\Path\database.fdb
----

пример строки подключения

[listing]
----
connect "localhost/3053:C:\TEMP\database.fdb" user "SYSDBA" password "masterkey";
----

Пример использования команды резервного копирования

[listing]
----
gbak.exe -b -g -v -user SYSDBA -pass masterkey localhost/3053:C:\TEMP\database.fdb C:\temp\backup.gbk
----

Конечно же, использование локальной строки подключения всегда будет обходить FBScanner:

[listing]
----
gbak.exe -b -g -v -user SYSDBA -pass masterkey C:\TEMP\database.fdb C:\temp\backup.gbk
----

=== Мониторинг в реальном времени: FBScanner Viewer

Для мониторинга соединений, запросов и транзакций в режиме реального времени FBScanner включает в себя специальный инструмент, а именно FBScanner Viewer.

FBScanner Viewer показывает мгновенный снимок SQL-трафика между Firebird и контролируемыми клиентскими приложениями.

image::4.3.21.png[]

В первом столбце мы видим тип записи -- connection, statement или transaction.

В таблице ниже вы можете найти описание всех столбцов на главной странице FBScanner Viewer (некоторые столбцы по умолчанию скрыты, используйте меню "`Columns`" чтобы включить/выключить их):

[cols="1,1", options="header"]
|===
| Наименование столбца
| Описание


|! (первый столбец)
|Указывает тип записи в FBScanner Viewer -- для операторов SQL, транзакций и соединений имеется отдельный набор значений.
Они описаны в следующей таблице ниже.

Знак "`!`" в заголовке этого столбца означает активный фильтр -- нажмите на треугольник справа от знака "`!`", чтобы настроить его.

|Tag
a|Зеленый/красный фон показывает загрузку ЦП в % (красный -- ядро, зеленый -- Firebird).

В тексте отображается значение тега (если оно было указано в SQL-запросе).

Пример установки значений тегов:

[listing]
----
SELECT * FROM RDB$DATABASE
/*FBSCANNER$CON_NAME=MyConnect;
FBSCANNER$TR_NAME=MyTransaction;
FBSCANNER$ST_NAME=SomeImportantQuery; */;
----

Также в этом столбце вы увидите выполнение инструментов `gbak` и `gfix`.

|Transaction Count
|Применимо для строки типа подключение.
Отображается количество активных транзакций в соединении.

Очень полезно найти приложения с автоматической фиксацией и другими неэффективными проблемами управления транзакциями.

|PID
|Идентификатор процесса Firebird. Только для архитектуры Classic.

|Client IP
|IP соединения

|Client Name
|DNS подключения (если возможно разрешить)

|Client Process Name
|Начиная с Firebird 2.1, `fbclient.dll` показывает имя клиентского приложения. Например, `C:\Program Files\Firebird\Firebird_2_1\bin\isql.exe`

|Priority
|Приоритет экземпляра Firebird (только Classic)

|Database
|Имя базы данных или ее псевдоним, как указано в строке подключения.

|User
|Имя пользователя -- например, SYSDBA (не поддерживается для Trusted Authentication)

|Role
|Роль пользователя

|Start
|Для строки соединения -- время соединения, для транзакции -- время начала транзакции, для оператора -- время начала запроса.

|Time
|`'NOW' - Start`; Время сначала старта

|Last Activity
|Время последнего действия для текущего соединения/транзакции/оператора.

|Inactive
|`'NOW' - Last Activity`; Период бездействия

|Latest Retaining
|Время последнего "`COMMIT RETAINING`" или "`ROLLBACK RETAINING`" в текущей транзакции.

|Retaining
|`'NOW' - Latest Retaining`

|Received
|Байты, полученные клиентом

|Sent
|Байты, отправленные клиентом

|CPU Time
|Показывает общее время, затраченное на соединение/транзакцию/запрос. Если в транзакциях более 1 запроса, время выполнения всех запросов будет суммироваться. То же правило применяется и для расчета времени соединения.

|Prepare Time
|

|Execute Time
|

|Fetch Count
|Применимо только для statements. Количество записей, как сообщает `fbclient.dll`

|Protocol
|Версия протокола Firebird для текущей сессии.

|Version
|Версия `fbclient.dll`/`gds32.dll`.

Определение версии не на 100 % верно: второстепенные версии считаются одинаковыми, JayBird и .NET Provider считаются одинаковыми, InterBase 8.x = InterBase 9.x
|===

В следующей таблице вы можете увидеть подробную информацию о значениях, отображаемых в первом столбце в строках FBScanner Viewer для SQL запросов:

[cols="1,1", options="header"]
|===
| Флаг
| Описание


|A
|Allocated. Начальная фаза жизненного цикла SQL-запроса

|P
|Prepared. Указывает, что запрос был подготовлен

|E
|Execute. В данный момент запрос выполняется

|C
|Closed statement. Выполнение завершено

|D
|Dropped statement.

|F
|Fetching is in progress

|f
|Fetching is in progress, но в данный момент приостановлено (набор записей не получен)

|c
|Closed cursor. Все данные были получены.
|===

==== Теги

Теги позволяют назначать читаемые идентификаторы (имена) соединениям, запросам и транзакциям.

Вам просто нужно добавить эти комментарии:

[listing]
----
SELECT COUNT(*) FROM RDB$DATABASE
/* FBSCANNER$CON_NAME=My_application;
   FBSCANNER$TR_NAME=Read_only_transaction_N1;
   FBSCANNER$ST_NAME=Customers_list_query; */
----

* FBSCANNER$CON_NAME= задает имя соединения. После первого назначения это имя будет сохраняться в течение всего срока действия соединения.
* FBSCANNER$TR_NAME= задает имя транзакции. После первого присвоения это имя будет использоваться в течение всего срока действия транзакции.
* FBSCANNER$ST_NAME= задает имя запроса.

Теги отображаются в первом столбце таблицы FBScanner Viewer, и теги можно фильтровать по их именам.

Теги полезны для быстрого ответа на следующие частые вопросы:

* Какая программа запустила этот запрос? (разработчикам необходимо пометить тегом FBSCANNER$CON_NAME каждое подключение к базе данных)
* Какова транзакция для этого запроса? (разработчикам необходимо использовать тег FBSCANNER$TR_NAME для обозначения транзакций)
* Что это за очень длительный запрос? (разработчик может помечать длительные запросы читаемыми именами, например "`Annual report`").

==== Меню FBScanner Viewer

FBScanner Viewer предлагает широкий спектр опций, упрощающих отладку и оптимизацию, которые доступны через его меню:

* *Сервер*
+
** Подключить...
** Отключить
** Последние сервера
** Выход
* *Подключения*
+
** Отключить
** Отключение клиентов...
** Завершить процесс...
** Последние запросы
** Старейшее подключение
** Приоритет процесса...
** Ping
** Ping всех
** Извлекать планы запросов
* *Транзакции*
+
** OAT
* *Инструменты*
+
** *Визуализация*
+
*** Администратор СУБД (только подключения)
*** Разработчик СУБД (без транзакций)
*** Разработчик СУБД (детально)
** Язык -- English, Italian, Русский, Portuguese
** Дополнения
** Настройки
* *Колонки* -- список столбцов
* *Помощь*


===== Сервер

Для подключения к службе FBScanner выберите menu:Сервер[Подключить...].

Появится следующий диалог:

image::4.3.22.png[]

После выбора сервера FBScanner Viewer запросит пароль. Существует 2 пароля -- для доступа только для чтения и для доступа администратора (полного). По умолчанию пароль для доступа только для чтения пуст.

image::4.3.23.png[]

[TIP]
====
Чтобы настроить пароли для доступа к FBScanner Viewer, вам необходимо перейти в "`FBScanner Configuration`" -- "`Advanced Settings`".
====

*Сервер\Отключить* отключает FBScanner Viewer от службы FBScanner.

*Сервер\Последние сервера* показывает список последних служб FBScanner, к которым подключался FBScanner Viewer.

*Выход* закрывает FBScanner Viewer.

==== Подключения

Пункты меню "`Отключить`", "`Отключение клиентов...`" и "`Завершить процесс...`" доступны только при подключении к службе FBScanner с правами администратора.

*Отключить* предложит закрыть текущее соединение (выделено в основной таблицы FBScanner Viewer):

image::4.3.24.png[]

"`*Отключение клиентов...*`" запускает следующий диалог:

image::4.3.25.png[]

В правой части находится список подключений, представленный именами баз данных, клиентов или пользователей в соответствии с фильтром выше.

Используя кнопки &gt; и &lt;, администратор может выбрать соединения, которые нужно отключить, а затем нажать кнопку "`Disconnect`".

Отключение будет выполнено путем эмуляции ошибки 10054 -- соответствующие записи будут в `firebird.log` (`interbase.log`) и в `FBScanner.log`.

==== Завершить процесс...

Есть несколько случаев, когда вам нужно завершить процесс Firebird, но мы не рекомендуем это делать.

"`Завершить процесс....`" запрашивает явное завершение процесса Firebird и работает только на локальном FBScanner и с архитектурой Classic:

image::4.3.26.png[]

Он не будет работать с архитектурами SuperServer и SuperClassic.

"`*Последние запросы*`" показывает список из 20 последних запросов в выбранном соединении:

image::4.3.27.png[]

Это полезно для специальной отладки, работает как кнопка "`Rewind`".

[TIP]
====
Для полноценной регистрации SQL-трафика включите функцию регистрации SQL в службе FBScanner и используйте FBScanner LogAnalyzer для просмотра журнала.
====

"`*Старейшее подключение*`" -- показывает самое старое соединение в таблице.

"`*Приоритет процесса...*`" -- применим только для локальной установки FBScanner с классической архитектурой.
Это позволяет установить приоритет процесса для экземпляров Classic.

"`*Ping*`" -- позволяет проверить -- активно ли выбранное соединение?

"`*Ping всех*`" -- проверяет все соединения тем же способом.

"`*Извлекать планы запросов*`" -- запускает извлечение планов для выбранного подключения. Извлеченные планы отображаются в таблице, а также сохраняются в журнале SQL (или текстовом журнале). Если ведение журнала не включено, ничего не происходит. Чтобы включить извлечение плана для всех подключений, используйте соответствующий параметр в "`FBScanner Configuration`".

==== Транзакции

Единственная опция *Транзакции\OAT* выделит в таблице самую старую активную транзакцию.

==== Инструменты

В меню "`Инструменты`" мы видим несколько опций.

С помощью "`*Визуализация*`" пользователь может выбрать наиболее подходящее представление данных таблицы:

* Администратор СУБД (только подключения)
* Разработчик СУБД (без транзакций)
* Разработчик СУБД (детально)

FBScanner Viewer локализован на 4 языках.

С помощью *Инструменты\Язык* вы можете переключаться между языками:

image::4.3.28.png[]

"`*Дополнения*`" включает плагины.

Для получения дополнительной информации свяжитесь link:mailto:support@ib-aid.com[support@ib-aid.com]

"`*Настройки*`" -- это еще один способ изменить некоторые параметры службы FBScanner.

image::4.3.29.png[]

Пожалуйста, ознакомьтесь с соответствующим разделом этого руководства для получения подробной информации о настройке службы FBScanner.

==== Структура журнала SQL

FBScanner сохраняет SQL-трафик в следующей таблице:

[source,sql]
----
CREATE TABLE FBSCANNER$LOG
(
    ID                   BIGINT NOT NULL,
    IDATTACHMENT         BIGINT,
    IDTRANSACTION        BIGINT,
    PID                  INTEGER,
    ROW_TYPE             INTEGER NOT NULL,
    CLIENT_IP            VARCHAR(24),
    CLIENT_NAME          VARCHAR(256),
    CUSTOM_NAME          VARCHAR(256),
    SUBNET_NAME          VARCHAR(256),
    DB_FILENAME          VARCHAR(512),
    DB_USER              VARCHAR(512),
    DB_ROLE              VARCHAR(512),
    START_TIME           TIMESTAMP DEFAULT 'NOW' NOT NULL,
    END_TIME             TIMESTAMP,
    LAST_ACTIVITY        TIMESTAMP DEFAULT 'NOW' NOT NULL,
    LAST_RETAINING       TIMESTAMP,
    WORK_TIME            INTEGER DEFAULT 0 NOT NULL,
    CPU_TIME_USER        INTEGER DEFAULT 0 NOT NULL,
    CPU_TIME_PRIVILEGED  INTEGER DEFAULT 0 NOT NULL,
    FETCH_COUNT          INTEGER DEFAULT 0 NOT NULL,
    RESULT               INTEGER,
    SQL_TEXT             BLOB SUB_TYPE 1 SEGMENT SIZE 80,
    SQL_TEXT2            BLOB SUB_TYPE 1 SEGMENT SIZE 80,
    SQL_PLAN             BLOB SUB_TYPE 1 SEGMENT SIZE 80,
    PREPARE_TIME         INTEGER DEFAULT 0 NOT NULL,
    EXECUTE_TIME         INTEGER DEFAULT 0 NOT NULL
);
----

==== Логическая структура

В этой таблице есть 3 уровня иерархии:

* `ID` -- первичный ключ
* `IDATTACHMENT` и `IDTRANSACTION` -- внешние ключи, ссылающиеся на FBSCANNER$LOG.ID
* `ROW_TYPE` -- уровень иерархии (0, 1, 2 )

.Уровень 1. Соединение. ROW_TYPE = 0
[cols="1,1", frame="all"]
|===
|PID
|Идентификатор процесса (только для локального FBScanner)

|ROW_TYPE
|0

|CLIENT_IP
|IP-адрес клиента

|CLIENT_NAME
|DNS-имя

|CUSTOM_NAME
|Тег соединения (если задан в тексте запроса)

|SUBNET_NAME
|Логическое имя подсети. Смотри файл `FBScanner.subnets`

|DB_FILENAME
|Псевдоним базы данных или полный путь к базе данных

|DB_USER
|Имя пользователя

|DB_ROLE
|Роль пользователя

|START_TIME
|Время начала соединения

|END_TIME
|Время завершения соединения
|===


.Уровень 2. Транзакция. ROW_TYPE = 1
[cols="1,1", frame="all"]
|===
|IDATTACHMENT
|Идентификатор соединения

|ROW_TYPE
|1

|CUSTOM_NAME
|Тег транзакции (если назначен)

|START_TIME
|Время начала транзакции

|END_TIME
|Время окончания транзакции

|LAST_RETAINING
|Время последнего commit retaining или rollback retaining

|RESULT
|

0 – транзакция активна

1 – Commit

2 – Rollback

|SQL_TEXT
|Флаги транзакции
|===



.Уровень 3. Запрос. ROW_TYPE = 2
[cols="1,1", frame="all"]
|===
|IDATTACHMENT
|Идентификатор соединения

|IDTRANSACTION
|Идентификатор транзакции

|ROW_TYPE
|2

|CUSTOM_NAME
|Тег запроса (если назначен)

|START_TIME
|Время начала запроса

|WORK_TIME
|Время до ответа от сервера

|CPU_TIME_USER
|Время процессора (только локально)

|CPU_TIME_PRIVILEGED
|Время ядра ЦП (только локально)

|FETCH_COUNT
|Количество записей, возвращаемых запросом

|RESULT
|0 -- запрос выполнен успешно, иначе это поле содержит SQLCODE ошибки

|SQL_TEXT
|Текст запроса (с параметрами)

|SQL_TEXT2
|Исходный текст запроса (NULL, если равен SQL_TEXT)

|SQL_PLAN
|План выполнения запроса (если включена настройка  "`Извлекать планы`")

|**PREPARE_TIME**
|Время подготовки

|**EXECUTE_TIME**
|Время выполнения запроса
|===

==== Индексы в журнале

Первоначально база данных журналов содержит только индекс первичного ключа.

FBScanner Log Analyzer создает необходимые индексы при первом подключении.

=== Матрица функций FBScanner

[cols="1,4,1,1"]
|===
.2+h| #
.2+h| Функция
2+h|Режим FBScanner

h| Агент
h| Удаленный


|
|Поддержка операционных систем
|
|

|
|**Windows**
|X
|X

|
|Linux, Mac OS X, Free BSD
|
|X

|
|Поддерживаемые версии Firebird и InterBase
|
|

|
|Firebird 1.0, Yaffil 1.0 (включая ведение журнала)
|X
|X

|
|Firebird 1.5 (включая ведение журнала)
|X
|X

|
|Firebird 2.0 (включая ведение журнала)
|X
|X

|
|Firebird 2.1 (включая ведение журнала)
|X
|X

|
|Firebird 2.5 (включая ведение журнала + поддержка SuperClassic)
|X
|X

|
|InterBase 6.0-2009/XE (включая ведение журнала)
|X
|X

|**1**
|**Соединения**
|
|

|**__1.1__**
|**__Информация об установленных соединениях в FBScanner Viewer:__**
|
|

|
|Firebird/InterBase логин пользователя
|X
|X

|
|IP-адрес или имя компьютера
|X
|X

|
|Время подключения и время последней активности
|X
|X

|
|Приоритет процессов (только для классической архитектуры)
|X
|

|**__1.2__**
|**__Управление подключением (требуется вход в FBScanner Viewer с правами администратора)__**
|
|

|
|Безопасное отключение одного или нескольких соединений с использованием прерывания соединения TCP/IP (имитация ошибки 10054)
|X
|X

|
|Изменение приоритета процессов в классической архитектуре (например, чтобы настроить приоритет долго выполняющегося отчета или что-то в этом роде. С помощью тегов администратор может распознать соединение, на котором работает отчет - см. "`Tags`").
|X
|

|
|Автоматическая настройка приоритетов для Firebird с классической архитектурой.
В конфигурации FBScanner администратор может настроить автоматическую соответствие для:

Указанный IP или подсеть IP -- установите приоритет X

Указанное имя хоста – установить приоритет X

Указанное имя базы данных – установите приоритет X

Указанное имя пользователя – установить приоритет X
|X
|

|
|Уничтожение Classic процессов, использовать не рекомендуется, но иногда полезно.
|X
|

|
|Возможность ограничить все соединения (для выполнения некоторых операций, требующих монопольного доступа)
|X
|X

|
|Фильтрация просмотра соединений по всем параметрам соединений (кроме информации о времени)
|X
|X

|
|Белый и черный список баз данных для подключения
|X
|X

|
|Белый и черный список IP-адресов (клиентов)
|X
|X

|
|Ограничение подключений # -- администратор может ограничить количество подключений
|X
|X

|
|Эмуляция ошибки "`Wrong login/password`" для запрещенных подключений
|X
|

|
|Обнаружение старых/неправильных версий `fbclient.dll`/`gds32.dll`
|X
|X

|**__1.3__**
|**__Регистрация событий, связанных с соединениями__**
|X
|X

|
|FBScanner регистрирует неудачные попытки входа в систему в файле `FBScanner.log`. Для каждой неудачной попытки входа FBScanner записывает следующую информацию: IP-адрес, имя пользователя, базу данных и время попытки входа.
|X
|X

|
|Если соединение было прервано (ошибка 10054), FBScanner определяет и протоколирует один из 5 типов разрывов соединения:

Клиентское приложение было закрыто неправильно (например, приложение было закрыто диспетчером задач)

Соединение было закрыто по тайм-ауту (в FBScanner можно также настроить принудительное отключение, чтобы закрыть соединение по тайм-ауту)

Сбой сервера (сбой `fbserver` или `fb_inet_server`)

Серверный процесс (`fbserver` или `fb_inet_server`) был уничтожен с помощью FBScanner.

Отключение соединений от FBScanner Viewer

Во всех вышеперечисленных случаях FBScanner записывает IP-адрес отключенного клиента(ов) и причину отключения.
Это очень полезная функция для поиска и устранения ошибок 10054.
|X
|X


|**2.**
|**Транзакции**
|
|

|**__2.1.__**
|**__Транзакции отображаются внутри соответствующих соединений__**
|
|

|
|Флаги транзакций
|X
|X

|
|Время жизни транзакций
|X
|X

|
|Используя кнопку OAT, вы можете найти самую старую активную транзакцию в режиме реального времени и просмотреть связанные соединения/запросы.
|X
|X

|**3.**
|**Запросы**
|
|

|**__3.1__**
|**__Информация о запросах__**
|
|

|
|Время начала
|X
|X

|
|Текст запроса
|X
|X

|
|Транзакция запроса
|X
|X

|
|Статус (prepare/execute/...)
|X
|X

|
|Фильтрация по статусу запроса (по умолчанию закрытые запросы скрыты)
|X
|X

|
|Мгновенный индикатор загрузки процессора
|X
|X

|
|Если подготовка или выполнение запроса вызвало ошибку, FBScanner записывает в журнал `SQLCODE` (например, "`primary key violation`").
|
|

|**__3.2__**
|**__Дополнительные операции с запросами__**
|
|

|
|Извлечение плана для запросов.

Может выполняться для всех подключений (должно быть включено в утилите настройки FBScanner).

Можно включить/выключить для выбранного соединения только в FBScanner Viewer.

В обоих случаях планы будут регистрироваться в общем журнале, если ведение журнала включено.
|X
|X

|**4.**
|**Tags**
|
|

|
a|Теги позволяют назначать читаемые идентификаторы (имена) соединениям, запросам и транзакциям. Вам просто нужно добавить эти комментарии:

[source]
----
SELECT COUNT(*) FROM RDB$DATABASE
/* FBSCANNER$CON_NAME=My_application;
FBSCANNER$TR_NAME=Read_only_transaction_N1;
FBSCANNER$ST_NAME=Customers_list_query; */
----

|X
|X

|
|`FBSCANNER$CON_NAME=` -- задает имя соединения. После первого назначения это имя будет сохраняться в течение всего срока действия соединения.
|X
|X

|
|`FBSCANNER$TR_NAME=` -- задает имя транзакции. После первого присвоения это имя будет использоваться на протяжении всей транзакции.
|X
|X

|
|`FBSCANNER$ST_NAME=` -- задает имя запроса.
|
|

|
|Теги отображаются в специальном столбце в FBScanner Viewer.
|X
|X

|
|Можно фильтровать теги по их именам.
|X
|X

|
a|Теги полезны для быстрого ответа на следующие частые вопросы:

* Какая программа запустила этот запрос? (разработчикам необходимо пометить тегом `FBSCANNER$CON_NAME` каждое подключение к базе данных).
* Какова транзакция для этого запроса? (разработчикам необходимо использовать тег `FBSCANNER$TR_NAME` для обозначения транзакций)
* Что это за очень длинный запрос? (разработчик может помечать длительные запросы читаемыми именами, например  "`Годовой отчет`")
|X
|X

|**5.**
|**Логирование**
|
|

|
|Логирование позволяет перехватывать все запросы и записывать их во внешнюю базу данных Firebird. К вашему сведению, ведение журналов нельзя заменить системными таблицами Firebird 2.1 или InterBase, поскольку они предоставляют только снимки программ.
|X
|X

|
|Логирование соединений, запросов и транзакций
|X
|X

|
|Протоколирование всех выполненных запросов (пропускаются только подготовленные запросы).
|X
|X

|
|Сохранение запросов с информацией об их подключении и транзакции.
|X
|X

|
|Все транзакции протоколируются, даже отменённые. Запись журнала транзакций имеет столбец RESULT, который показывает, была ли транзакция зафиксирована или отменена.
|X
|X

|
|Если извлечение плана включено, планы запросов также регистрируются.
|X
|X

|
|Автоматическое создание базы данных для логирования.
|X
|X

|
|Автоматическое создание таблиц для логирования для любой базы данных Firebird.
|X
|X
|===
