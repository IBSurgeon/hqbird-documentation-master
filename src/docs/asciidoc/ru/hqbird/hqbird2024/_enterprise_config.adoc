[[_hqbird_enterprise_config]]
= Настройка репликации HQBird

HQbird -- это расширенный дистрибутив Firebird для больших баз данных с инструментами мониторинга, оптимизации и администрирования, он также включает в себя плагин для встроенной репликации master-slave и различные улучшения производительности.

В HQbird встроенная репликация доступна начиная с версии 2.5. В "`ванильном`" Firebird она появилась позже и доступна начиная с версии 4.0. 

HQbird на 100% совместим с Firebird 2.5, 3.0, 4.0 и 5.0 -- никаких изменений в ODS не требуется. Чтобы переключиться на HQbird и обратно, резервное копирование/восстановление не требуется, просто остановите/запустите Firebird и замените двоичные файлы. Репликация возможна между узлами с одинаковой версией, т.е. невозможна между версиями 3.0 и 2.5.

== Как работает репликация

Репликация HQbird работает на логическом уровне: она реплицирует изменения сделанные DML (`INSERT`/`UPDATE`/`DELETE`, `EXECUTE PROCEDURE` и др.) и DDL (`CREATE`/`ALTER`/`DROP`) операторами; *никаких дополнительных триггеров не требуется*. Единственное требование к текущей версии репликации -- наличие уникальных или первичных ключей для всех таблиц, изменения в которых необходимо реплицировать.

Чтобы использовать репликацию, вам необходимо установить HQbird, зарегистрировать его (с пробной версией или с полной лицензией) и настроить репликацию. HQbird должен быть запущен на главном сервере и на всех серверах-репликах.

Ниже мы рассмотрим, как настроить репликацию Firebird с помощью HQbird.

_Вы можете использовать HQbird в Windows и Linux с 32-разрядной и 64-разрядной версиями Firebird 2.5, 3.0, 4.0 и 5.0._


<<<

== Установка

Пожалуйста, установите HQbird из прилагаемого дистрибутива. Если у вас установлена другая версия Firebird (2.5, 3.0), сначала удалите ее.

Чтобы включить репликацию, на вашем главном сервере и сервере-реплике должна быть рабочая и зарегистрированная (пробная или полная) копия HQbird.

Пожалуйста, обратитесь к разделу 2 этого руководства для получения подробной информации об установке сервера HQbird.

<<<

== Асинхронная репликация в Firebird

HQbird поддерживает 2 типа репликации: асинхронную и синхронную. В случае асинхронной репликации главный сервер сохраняет подтверждённые изменения из главной базы данных в файлах (сегментах репликации), которые могут использоваться асинхронно одним или несколькими серверами-репликами.

image::6.1.png[]

Как работает асинхронная репликация:

* Изменения на стороне мастер-севера регистрируются в файлах журнала репликации
* Журнал состоит из нескольких сегментов (файлов)
* Сегменты репликации (заархивированные) передаются на сервера-реплики и применяются к репликам в фоновом режиме
* Реплику можно создавать и пересоздавать онлайн (без остановки мастера)

Важные моменты, которые следует учитывать:

* Практическая задержка между мастером и репликой настраивается и может составлять 15-30 секунд (по умолчанию -- 90 секунд).
* Задержка между мастером и репликой может увеличиться в случае большой нагрузки (из-за задержки обработки сегментов репликации)
* Реплику можно переключить в основной (т.е. обычный) режим с помощью 1 команды

*Асинхронная репликация -- рекомендуемый вариант для HQbird*:

* обеспечивает стабильность и защиту от повреждений базы данных Firebird;
* может быть быстро и легко сконфигурирована;
* не требует простоев для настройки;
* имеет возможность повторной инициализации в онлайн режиме;
* подходит для распределенных сред (когда реплика находится в облаке или на удаленном сервере).

Для настройки асинхронной репликации потребуются следующие шаги:

. Настройка HQbird для репликации на главном сервере
. Создание копии файла базы данных master
. Настройка базы данных для репликации на сервере-реплике (подчиненном сервере)


=== Шаг 1: Настройка HQbird для репликации на главном сервере

Чтобы настроить репликацию, откройте HQbird FBDataGuard: запустите современный браузер (Chrome, Firefox и т.д.) и откройте этот локальный URL: http://127.0.0.1:8082/[http://127.0.0.1:8082] (порт, если необходимо настраивается в ini-файлах HQbird).

Введите им и пароль по умолчанию: **admin/strong password**.

Зарегистрируйте сервер Firebird, и появится следующая картинка:

image::6.2.png[]

Убедитесь, что вы действительно подключены к правильной версии Firebird -- в левом верхнем углу в виджете "Active server" должна быть указана версия
"`... Firebird 2.5 *HQbird*`" или "`... Firebird 3.0 *HQbird*`" или "`... Firebird 4.0 *HQbird*`" или "`... Firebird 5.0 *HQbird*`".

После этого нажмите "`Add database`" в правом нижнем углу и укажите ник и путь к базе данных, которая будет основной:

image::6.3.png[]

[NOTE]
====
Пожалуйста, обратите внимание, что база данных должна быть зарегистрирована с указанным в ней явным путем, а не с псевдонимом -- репликация не будет работать с псевдонимом.
====

После успешной регистрации базы данных нажмите на значок в заголовке базы данных, чтобы настроить репликацию:

image::6.4.png[]

После этого появится основное диалоговое окно настройки для баз данных master и replica.

Когда репликация не настроена, это диалоговое окно практически пустое:

image::6.5.png[]


==== Асинхронная репликация на главном сервере

Асинхронная репликация записывает все изменения в главной базе данных в журнал репликации: набор файлов, называемых "сегментами репликации". Сервер реплики получает эти сегменты и применяет их к базе данных реплики.

Ранее мы зарегистрировали "H:\dbwmaster.fdb`, в данном примере это главная база данных. Чтобы настроить асинхронную репликацию на стороне мастера: выберите роль репликации: "`Master`", затем "`Asynchronous`" и нажмите "`Save`".

Начиная с Firebird 4.0, вам необходимо включить публикацию на уровне базы данных. Нажав на кнопку "Enable publications (and grant it for all tables)", вы активируете публикацию и добавляете все таблицы в список для публикации. Списком таблиц для публикации можно управлять в SQL, используя следующие инструкции:

[listing]
----
ALTER DATABASE INCLUDE {TABLE <table_list> | ALL} TO PUBLICATION

ALTER DATABASE EXCLUDE {TABLE <table_list> | ALL} FROM PUBLICATION

<table_list> ::= tablename [, tablename ...]
----

.Диалог настройки репликации для асинхронной репликации
image::6.6.png[]

Единственный параметр, который вы можете изменить, -- это "`*Записывать закоммиченные данные каждые NN секунд*`", он определяет, как часто должны перемещаться зафиксированные данные в архивные сегменты репликации.

По умолчанию это значение равно 90 секундам.

Есть несколько необязательных параметров, которые вы можете изменить, если откроете подробное диалоговое окно с кнопкой btn:[more>>].:

image::6.7.png[]

Давайте рассмотрим все параметры в этом диалоговом окне -- просто чтобы дать вам представление о том, что они делают, *их не нужно изменять*:

* "`Папка оперативных логов`" -- папка, в которой будут храниться операционные журналы. Это системная папка, полностью управляемая Firebird. По умолчанию `${db.path}.ReplLog` (`db.path` -- это место, где находится база данных). *Нет необходимости изменять значение по умолчанию*.
* "`Папка архивных логов`" -- папка, в которой будут храниться архивированные журналы. В соответствии со значением по умолчанию `${db.path}.LogArch`, HQbird создаст папку `DatabaseName.LogArch` в папке с базой данных, поэтому *нет необходимости изменять этот параметр*.
* Третий параметр ("`Переопределить команду архивации`") необязательный, *оставьте его пустым*.


[NOTE]
====
Пожалуйста, обратите внимание, что параметры репликации инициализируются при первом подключении к базе данных. Вот почему вам необходимо перезапустить службу Firebird (или все подключения в случае Classic) после настройки репликации -- такой перезапуск гарантирует, что репликация запустится должным образом.
====

В этом случае сегменты журнала репликации сначала будут записаны в `${db.path}.ReplLog` (`db.path` -- это место, где находится база данных -- в нашем примере это будет `H:\DBWMaster.fdb.ReplLog`), а после достижения максимального размера сегмента, или количество коммитов, или после другого триггера, будет запущена команда архивирования по умолчанию -- она скопирует заархивированные сегменты репликации в `${db.path}.LogArch` (в нашем примере это будет `H:\DBWMaster.fdb.LogArch`).

После запуска репликации вы сможете увидеть файлы сегментов репликации в папке, указанной в  "`Папка оперативных логов`", сразу после выполнения любой операции с главной базой данных:

image::6.8.png[]

Сегменты репликации ротируются ядром Firebird, и когда отдельный сегмент заполнен, он копируется в папку архива логов. Размер сегмента по умолчанию 16 мегабайт.

Пожалуйста, обратите внимание - вам не нужно ничего делать с операционными сегментами!

После подтверждения транзакции и/или указанного времени ожидания сохраненных данных вы увидите заархивированные сегменты в папке, указанной в "`Папка архивных логов`".

Архив логов репликации это набор файлов в хронологическом порядке. Эти файлы должны быть импортированы сервером реплики в базу данных реплики.

.Important!
[IMPORTANT]
====
Для пользователей Linux -- убедитесь, что владельцем папки с базой данных является пользователь `firebird`. HQbird работает под управлением пользователя "`firebird`" в Linux, и папка с базой данных должна иметь разрешения для "`firebird`" для создания папки журналов (`chown firebird -R /your/database/folder`).
====

==== Как скопировать сегменты репликации с мастера на реплику?

Существует 2 популярных способа скопировать архивные сегменты с главного сервера на серверы-реплики: через общий сетевой ресурс и с помощью задания <<_hqbird_config_cloud_backup>> на главном сервере и <<_hqbird_config_cloud_backup_receiver>> на реплике.

===== Общий сетевой ресурс

Вы можете предоставить общий доступ к папке с архивированными сегментами в качестве общего сетевого ресурса. В этом случае у службы Firebird должно быть достаточно прав для чтения, записи и удаления файлов на этом общем сетевом ресурсе. Обычно службы Firebird и HQbird запускаются под учетной записью LocalSystem, у которой нет доступа к общим сетевым ресурсам. Замените ее на какую-нибудь более мощную учетную запись (например, Администратора домена).

===== Отправка/приём сегментов репликации 

Мы рекомендуем использовать HQbird FBDataGuard для отправки сегментов репликации с главного сервера на реплику по FTP: он сжимает, шифрует и загружает сегменты на указанный FTP-сервер. На этом сервере другой HQbird FBDataGuard распаковывает сегменты и копирует их в необходимую папку для дальнейшего использования репликой.

[NOTE]
====
Пожалуйста, ознакомьтесь с заданием <<_hqbird_config_cloud_backup>> для получения более подробной информации о том, как настроить передачу архивированных сегментов между мастером и репликами.
====

=== Шаг 2: Создание копии файла базы данных master

Чтобы начать репликацию, нам необходимо создать копию исходного файла базы данных, которая будет использоваться в качестве целевой для процесса репликации. Давайте будем называть такой файл базы данных `"реплика"`.

В HQbird реплика будет автоматически создаваться в папке, которую вы укажете в диалоговом окне после нажатия на "`Создать заново БД реплику и оправить на реплику-сервер`".

image::6.9.png[]

Если у вас достаточно места в папке с базой данных, *просто оставьте путь пустым* и нажмите btn:[Submit], и рядом с базой данных будет создана реплика. Или вы можете указать другое место назначения на локальных дисках с достаточным количеством свободного места.

.Важно!
[IMPORTANT]
====
Если свободного места будет недостаточно (менее 105% от размера базы данных), HQbird не будет создавать копию -- появится соответствующее сообщение об ошибке.
====

Если вы нажмете кнопку btn:[Submit], HQbird запустит процесс создания реплики. Об этом появится соответствующее сообщение:

image::6.10.png[]

В случае действия по умолчанию результирующая база данных будет находиться в той же папке, что и база данных. Имя реплики будет  `DATABASE_NAME.EXT.DD-MMM-YYYY_NNNN.4replica` -- например, `employee30.fdb.17-Apr-2018_142507.4replica`

[NOTE]
====
Обратите внимание! Создание реплики может занять значительное время в случае большой базы данных!
====

Все этапы создания реплики отображаются в виде оповещений в HQbird (также отправляются по электронной почте):

image::6.11.png[]


[NOTE]
====
Убедитесь, что процесс создания реплики был успешно завершен -- проверьте вкладку "`Alerts`"!
====

=== Шаг 3: Настройка базы данных для асинхронной репликации на сервере-реплике (подчиненном сервере)

После завершения настройки асинхронной репликации на главном сервере нам необходимо настроить ее для базы данных-реплики на экземпляре сервера-реплики.

Прежде всего, мы предполагаем, что вы успешно установили HQbird на сервер-реплику. Мы рекомендуем использовать на сервере-реплике SuperClassic для Firebird 2.5 и SuperServer для Firebird 3.0 и выше (это конфигурации HQbird по умолчанию).

**Пользователи Firebird Classic Linux**: Если вы запускаете Firebird на сервере-реплике в классическом режиме в Linux, вам необходимо запустить дополнительный процесс Firebird replicator с помощью команды "fb_smp_server -r`.

Во-вторых, база данных реплик должна быть зарегистрирована в HQbird FBDataGuard. Если вы намерены использовать автоматическую повторную инициализацию, вы можете зарегистрировать какую-нибудь небольшую базу данных (`employee.fdb`) с требуемым именем и выполнить повторную инициализацию: в результате реплика базы данных будет автоматически перенесена с главного сервера.

В-третьих, мы предполагаем, что вам удалось настроить передачу журналов с помощью заданий <<_hqbird_config_cloud_backup>>/<<_hqbird_config_cloud_backup_receiver>> или с помощью сетевого общего доступа.

[NOTE]
====
Обратите внимание: перед регистрацией база данных должна иметь GUID реплики базы данных! Этот GUID создается автоматически, если вы воспользовались ссылкой "`Reinitialize replica database`", но если вы выполняете повторную инициализацию вручную, не забудьте установить его, иначе будет выдана ошибка об отсутствии GUID базы данных.
====

Затем завершите настройку репликации -- единственным обязательным параметром является путь к папке с архивированными сегментами репликации, и по умолчанию он уже установлен -- HQbird создаст папку с журналами рядом с базой данных:

image::6.12.png[]

Итак, здесь не нужно ничего менять, просто нажмите btn:[Сохранить].

Предполагая, что база данных реплики настроена как `D:\DATABASE\DBWREPLICA.FDB`, HQbird создаст папку `D:\DATABASE\DBWREPLICA.FDB.LogArch`, и replica импортирует из нее файлы сегментов репликации.

Нажмите btn:[Сохранить] и перезапустите службу Firebird (чтобы убедиться, что параметры репликации были применены).

После перезапуска сервер-реплика начнет использовать сегменты репликации из папки -- обратите внимание, что после импорта все обработанные сегменты будут удалены. Также будет создан файл с именем `{DATABASE-GUIDE}` -- это так называемый контрольный файл. Firebird хранит в нем некоторую внутреннюю информацию о ходе репликации.

[NOTE]
====
Не рекомендуется хранить архивные сегменты репликации из разных баз данных в одной папке! Всегда выделяйте отдельную папку для каждой пары баз данных мастер-реплика!
====

<<<

== Автоматическая инициализация и переинициализация реплики

Мы рекомендуем использовать <<_hqbird_config_cloud_backup>> на мастере и <<_hqbird_config_cloud_backup_receiver>> на реплике, чтобы реализовать передачу и проверку целостности сегментов репликации через FTP. В этом случае также можно выполнить повторную инициализацию базы данных-реплики в один клик.

Если в <<_hqbird_config_cloud_backup>> и <<_hqbird_config_cloud_backup_receiver>> включены следующие параметры (по умолчанию), HQbird автоматически выполняет повторную инициализацию, включая перезапуск базы данных реплики:

image::6.13.png[]

Параметр "`Префикс для переименования файлов репликации`" следует изменить, если вы собираетесь инициализировать несколько копий главной базы данных через одну папку -- в этом случае он должен быть уникальным для каждой базы данных.

В случае единой базы данных никаких изменений не требуется.

=== Как работает повторная инициализация

Если настроены <<_hqbird_config_cloud_backup>>/<<_hqbird_config_cloud_backup_receiver>>, то можно выполнить полную повторную инициализацию одним щелчком мыши по "`Создать заново БД реплику и отправить на реплику сервер`".

После кнопки на главной БД HQbird выполнит следующее:

. Спросит у вас, где хранить копию базы данных (по умолчанию она находится рядом с основной базой данных, нажмите btn:[Submit], чтобы сохранить базу данных там).
. Основная база данных будет скопирована (с помощью `nbackup`)
. Созданная копия базы данных будет переведена в режим реплики.
. для копии будет рассчитана хеш-сумма md5
. В соответствии с настройками <<_hqbird_config_cloud_backup>> главный HQbird загрузит базу данных на указанный FTP.

Следующие шаги будут выполняться экземпляром HQbird репликой:

. Как только реплика HQbird заметит файлы `reini*` во входящей папке FTP, <<_hqbird_config_cloud_backup_receiver>> начнет процедуру повторной инициализации.
. Обработка архивных сегментов будет приостановлена
. Полученная база данных будет проверена -- будет рассчитана хеш-сумма md5 и сравнена со значением в прилагаемом файле отчета.
. Существующая реплика базы данных будет отключена, чтобы отключить всех пользователей.
. Новая база данных-реплика будет скопирована поверх существующей базы данных.
. Серверу реплики может потребоваться перезагрузка, чтобы увидеть новую реплику.

Реплика вернулась в обычный режим.

=== Устранение неполадок асинхронной репликации

Если вы настроили асинхронную репликацию, но она не работает, первым делом включите задание <<[[_hqbird_config_repllog]]>> на мастере и на реплике. Это задание анализирует файлы `replication.log` и в случае наличия ошибок создает соответствующее предупреждение.

image::6.14.png[]


Кроме того, полезно включить опцию "`Подробный лог`" на реплике и перезапустить Firebird. "`Подробный лог`" заставит Firebird записывать много подробностей о репликации в файл `replication.log` (рядом `с firebird.log`).

image::6.15.png[]

Обычно текст ошибки не требует пояснений, но поскольку некоторые популярные вопросы возникают регулярно, мы решили создать таблицу со списком основных проблем с асинхронной репликацией и способами их решения.

[cols="1,1", options="header"]
|===
| Проблема
| Возможные причины и способы решения


|Репликация на стороне мастера настроена, но папки для оперативных или архивных сегментов (`${dbpath}.LogRepl` или `${dbpath}.LogArch`) не создаются.
|HQbird создает эти папки автоматически, но для этого требуются разрешения.

В Windows: эти папки должны находиться на локальных дисках, или службы HQbird и Firebird должны запускаться с помощью "`Запуск от имени`" с учетной записью с повышенными привилегиями (Администратор домена?).

В Linux: папки должны иметь разрешения для пользователя "`firebird`".

|Репликация на стороне мастера настроена; папки `ReplLog` и `LogArch` созданы, но в них ничего нет. `Replication.log` пуст.
|Firebird не видит конфигурацию репликации. Перезапустите службу Firebird (все соединения в случае Classic), чтобы прочитать новую конфигурацию.

|Репликация на стороне мастера настроена; в папке `ReplLog` присутствую файл вида `databasename.log-000`, но нет файлов в `LogArch`. Кроме того, могут быть ошибки о нехватке места в `replication.log`.
|Это означает, что у Firebird нет разрешения на доступ к папке `LogArch` и создание там файлов сегментов репликации (`databasename-logarch.000XXX`).

Если папка `LogArch` находится на сетевом ресурсе или подключенном диске, убедитесь, что у Firebird есть права (полный доступ) на доступ к ней.

|Опция "`Подробный лог`" для реплики включена, но `replication.log` пуст или не создаётся.
|Иногда Firebird не может создать `replication.log` ли даже записать в уже созданный файл. Попробуйте создать его вручную и применить к нему необходимые разрешения (особенно в Linux).  Подробный вывод должен записываться в `replication.log` каждые 60 секунд, даже если нет сегментов для импорта.

|Репликация на стороне мастера в порядке, но реплика не использует сегменты репликации. Файл `replication.log` пуст.
|Реплика не прочитала новую конфигурацию репликации. Перезапустите Firebird.

|Репликация на стороне мастера в порядке, но реплика не использует сегменты репликации. Файл `replication.log` содержит ошибки прав доступа.
|У реплики недостаточно прав для чтения из папки `LogArch`. Установите необходимые разрешения или запустите реплику под привилегированной учетной записью.

|Реплика имеет ошибки в `replication.log` "`Segment NNN is missing`"
|Проверьте, есть ли такой сегмент на стороне реплики и соответствует ли он размеру мастера. Если размер сегмента в реплике равен 0, скопируйте его вручную или инициализируйте реплику заново.

|Реплика имеет ошибки в `replication.log` о неправильных внешних ключах и перестала использовать сегменты.
|Это означает, что копия реплики десинхронизирована, поэтому некоторые записи не имеют соответствующих значений в ссылочных таблицах для указанного внешнего ключа. Реплику следует повторно инициализировать. Если вы часто видите эти ошибки, обратитесь в службу поддержки IBSurgeon.

|===

<<<

== Синхронная репликация в Firebird

В случае синхронной репликации главный сервер напрямую вставляет зафиксированные изменения главной базы данных в одну или несколько баз данных-реплик:

image::6.16.png[]

Основными особенностями синхронной репликации являются следующие:

* Изменения буферизуются для каждой транзакции, передаются пакетами и синхронизируются при фиксации.
* Практическая задержка менее 1 секунды.
* Мастер база блокируется до применения изменений репликой
* Ошибки репликации могут либо прерывать операции, либо просто отсоединять реплику.
* Реплика доступна для запросов только для чтения (с оговорками).
* Может быть реализован автоматическое переключение между сервера (с помощью HQbird Cluster Manager).

На что обратит внимание:

* Дополнительная нагрузка на ЦП и ввод-вывод на стороне реплики.
* Требуется прямое и постоянное сетевое соединение от мастера к репликам, рекомендуется 1+Гбит/с.
* Реплику можно воссоздать онлайн, повторная инициализация синхронной репликации требует остановки мастера

Когда использовать синхронную репликацию:

* Пользовательские отказоустойчивые кластерные решения с более чем 3 узлами (особенно для веб-приложений).
* Для масштабирования производительности, перемещая операции чтения на отдельный сервер реплик (серверы отчетов, витрины данных или веб-представления, доступные только для чтения).
* В сочетании с асинхронной репликацией для масштабирования производительности.


=== Шаги по настройке синхронной репликации

. Остановите Firebird
. Создайте копию главного файла базы данных, переключите ее в режим реплики и скопируйте на сервер(ы) реплики.
. Настройте серверы реплик и базы данных для репликации с помощью HQbird FBDataGuard.
. Запускайте серверы-реплики -- перед главным сервером!
. Настройте главный сервер и главную базу данных для репликации с помощью HQBird FBDataGuard.
. Запустить главный сервер

Как видите, время простоя, необходимое для инициализации синхронной репликации, больше, чем время простоя для настройки асинхронной репликации, поскольку база данных реплики должна быть онлайн до запуска мастера.

=== Синхронная репликация на мастере и реплике

Синхронная репликация предназначена для записи изменений из главной базы данных непосредственно в базу данных-реплику. Большим преимуществом синхронной репликации является то, что задержка репликации может быть очень небольшой, но недостатком является то, что в случае потери соединения между мастер-сервером и сервером-репликой часть передаваемых данных будет потеряно.

image::6.17.png[]

В этом примере база данных синхронной реплики находится на удаленном сервере с IP-адресом *сервер реплики* и путем `/data/test2.fdb`.

Для синхронной репликации на сервере реплики не требуется никакой настройки, за исключением `gfix –replica <master-guid>` для переключения базы данных реплики в режим реплики.

=== Параметры репликации для тестирования синхронной репликации

В случае тестирования синхронной репликации HQbird в производственной системе мы рекомендуем установить для параметра `disable_on_error` значение `true`.

image::6.18.png[]

В случае ошибки репликации он отключит репликацию, и главный сервер продолжит работать без репликации.

Для повторной инициализации репликации необходимо проанализировать журнал репликации и повторить все шаги инициализации.

Кроме того, включите задание "`Лог репликации`" в HQbird FBDataGuard, чтобы отслеживать журнал репликации на наличие ошибок и предупреждений:

image::6.19.png[]

<<<

== Как вручную создать реплику базы данных?

_Конечно, всегда можно создать реплику с помощью простого процесса копирования: остановите Firebird на мастере, скопируйте файл базы данных, завершите настройку репликации на реплике, затем запустите Firebird. Однако HQbird поддерживает создание онлайн-реплик -- подробности см. ниже._

Если по каким-то причинам вы не можете использовать автоматическое создание реплики, вы можете создать реплику-копию главной базы данных вручную.

Начиная с HQbird 2018, можно создать файл реплики без остановки главного сервера с помощью `nbackup`. Это просто для асинхронной репликации, кроме того возможно создавать дополнительные реплики онлайн, т. е. без остановки мастера.

=== Создание копии онлайн (с помощью nbackup)

Рассмотрим, как создать реплику для асинхронной репликации с помощью `nbackup`:

. заблокировать файл базы данных с помощью `nbackup`
+
[listing]
----
nbackup –l database_path_name -user SYSDBA –pass masterkey
----
. скопировать заблокированный файл базы данных, чтобы создать реплику
+
[listing]
----
copy database_path_name replica_path_name
----
. разблокировать основную базу данных
+
[listing]
----
nbackup –n database_path_name -user SYSDBA –pass masterkey
----
. Исправление реплики базы данных
+
[listing]
----
nbackup –f replica_path_name_name
----
. Переключить базу данных в режим реплики
+
для Firebird 2.5 и 3.0
+
[listing]
----
gfix replica_path_name –replica {DATABASEGUID} –user SYSDBA –pass masterkey
----
+
для Firebird 4.0 и выше
+
[listing]
----
gfix replica_path_name –replica <replica_mode> –user SYSDBA –pass masterkey

<replica_mode> ::= read_only | read_write
----
+


=== Что такое {DATABASEGUID}?

GUID базы данных -- это уникальный идентификатор главной базы данных.

Его можно получить {DATABASEGUIDE}, выполнив команду `gstat –h`:

image::6.20.png[]

Чтобы переключить базу данных в режим реплики, выполните следующую команду:

[listing]
----
gfix disk:\path\mydatabase.fdb -replica {guid} -user SYSDBA -pass masterkey
----

[NOTE]
====
Если вы не видите GUID базы данных в выводе `gstat –h`, подключитесь к главной базе данных, используя двоичные файлы Firebird из дистрибутива HQbird (через `isql` или любым другим приложением), и снова запустите `gstat –h`.
====

=== Как перевести базу данных реплики в мастер режим

Чтобы переключить базу данных в обычный (главный) режим, выполните ту же команду с пустым `{}` вместо GUID базы данных:

для Firebird 2.5 и 3.0

[listing]
----
gfix disk:\path\mydatabase.fdb -replica {} -user SYSDBA -pass masterkey
----

для Firebird 4.0 и выше

[listing]
----
gfix replica_path_name –replica none –user SYSDBA –pass masterkey
----

<<<

== Как отличить главную базу данных от реплики

=== Используйте gstat -h

Если вы запустите `gstat –h database_name`, выходные данные будут содержать ключевое слово "`replica`" в разделе Attributes для базы данных, настроенной как реплика:

[listing]
----
Database "D:\O30.FDB"
Gstat execution time Mon Nov 26 17:47:07 2018

Database header page information:
Flags                   0
Generation              187842
System Change Number    15
Page size               8192
ODS version             12.0
Oldest transaction      173630
Oldest active           185440
Oldest snapshot         185440
Next transaction        185441
Sequence number         0
Next attachment ID      24975
Implementation          HW=AMD/Intel/x64 little-endian OS=Windows CC=MSVC
Shadow count            0
Page buffers            0
Next header page        0
Database dialect        3
Creation date           Jan 11, 2017 15:12:20
Attributes              replica

Variable header data:
Database backup GUID:   {37E7918F-5478-43CF-E3B2-D80B0E7D3F63}
Sweep interval:         0
Database GUID:  {BBBD2881-ACDE-4636-CEB2-7EE31AF66CC3}
Replication master GUID: {BBBD2881-ACDE-4636-CEB2-7EE31AF66CC3}
*END*
Gstat completion time Mon Nov 26 17:47:07 2018
----

Для основной базы данных в атрибутах нет специальных отметок.

=== Через SQL-запрос к контекстной переменной

В Firebird 2.5 и 3.0 в пространстве `SYSTEM` есть контекстная переменная `REPLICA, содержащая информацию о состоянии базы данных:

[listing]
----
SQL> select RDB$GET_CONTEXT('SYSTEM', 'REPLICA') from rdb$database;

RDB$GET_CONTEXT
================================================================
FALSE
----

В Firebird 4.0 используйте другую контекстную переменную `REPLICA_MODE`:

[listing]
----
SQL> select RDB$GET_CONTEXT('SYSTEM', 'REPLICA_MODE') from rdb$database;

RDB$GET_CONTEXT
================================================================
READ-ONLY
----

Также в Firebird 4.0 и выше вы можете использовать таблицу мониторинга `MON$DATABASE`:

[listing]
----
SQL> SELECT MON$REPLICA_MODE FROM MON$DATABASE;

MON$REPLICA_MODE
================
               1
----

Режимы реплики базы данных:

* 0 -- не реплика
* 1 -- read-only реплика
* 2 -- read-write реплика

<<<

== Дополнительные параметры репликации

Есть возможность указать несколько дополнительных параметров для тонкой настройки процесса репликации. Эти параметры можно указать в "`Опции`" диалога настройки репликации.

. Размер локального буфера, используемого для накопления событий репликации, которые можно отложить до фиксации/отката транзакции. Чем больше это значение, тем меньше сетевых обменов между главным и подчиненным хостами. Однако это требует больше времени на "`контрольные точки`" репликации (время на синхронизацию исходной базы данных с ее репликой).
+
[listing]
----
buffer_size = 1048576
----
. Если этот параметр включен, любая ошибка во время репликации приводит к тому, что мастер прекращает репликацию изменений и продолжает работать в обычном режиме. В противном случае (поведение по умолчанию) мастер сообщает об ошибке.
+
[listing]
----
disable_on_error = false
----
. Если этот параметр включен, реплицированные записи сжимаются с помощью RLE перед передачей и распаковываются на подчиненной стороне. Это уменьшает трафик и (косвенно) количество round-trips за счет дополнительных циклов ЦП с обеих сторон.
+
[listing]
----
compress_records = false
----
. Если этот параметр включен, конфликтующие записи в целевой базе данных изменяются в соответствии с записями в основной базе данных. В частности:
+
** если происходит вставка и существует целевая запись, то она обновляется;
** если происходит обновление и целевая запись не существует, она вставляется;
** если произошло удаление, а целевая запись не существует, она игнорируется.

[listing]
----
master_priority = false
----
. Шаблон (регулярное выражение), определяющий, какие таблицы необходимо включать в репликацию. По умолчанию все таблицы реплицируются.
+
[listing]
----
include_filter
----
. Шаблон (регулярное выражение), определяющий, какие таблицы необходимо исключить из репликации. По умолчанию все таблицы реплицируются.
+
[listing]
----
exclude_filter
----
. Если этот параметр включен, таблицы без первичного ключа (или уникального индекса) исключаются из репликации. По умолчанию все таблицы реплицируются.
+
[listing]
----
exclude_without_pk = false
----
. Программа (команда оболочки с аргументами), которая выполняется, когда текущий сеанс репликации обнаруживает критическую ошибку. Эта команда выполняется один раз для каждого неудачного сеанса репликации. Обратите внимание, что программа выполняется синхронно, и сервер ожидает ее завершения, прежде чем продолжить свою работу.
+
[listing]
----
alert_command
----
. Префикс для имен файлов журнала репликации. К нему автоматически будет добавлен порядковый последовательный номер. Если не указано, в качестве префикса используется имя файла базы данных (без пути).
+
[listing]
----
log_file_prefix
----
. Максимально допустимый размер для одного сегмента репликации. Он должен как минимум вдвое превышать указанный __buffer_size__.
+
[listing]
----
log_segment_size = 16777216
----
. Максимально допустимое количество полных сегментов репликации. По достижении этого предела процесс репликации задерживается на _log_archive_timeout_ секунд (см. ниже), чтобы архивирование могло наверстать упущенное. Если какой-либо из полных сегментов не заархивирован и не помечен для повторного использования в течение таймаута, репликация завершится ошибкой.
+
Ноль означает неограниченное количество сегментов, ожидающих архивирования.
+
[listing]
----
log_segment_count = 8
----
