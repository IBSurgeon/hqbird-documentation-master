[[_hqbird_enterprise_config]]
= Настройка репликации HQBird

HQbird -- это расширенный дистрибутив Firebird для больших баз данных с инструментами мониторинга, оптимизации и администрирования, он также включает в себя плагин для встроенной репликации master-slave и различные улучшения производительности.

В HQbird встроенная репликация доступна начиная с версии 2.5. В "`ванильном`" Firebird она появилась позже и доступна начиная с версии 4.0. 

HQbird на 100% совместим с Firebird 2.5, 3.0, 4.0 и 5.0 -- никаких изменений в ODS не требуется. Чтобы переключиться на HQbird и обратно, резервное копирование/восстановление не требуется, просто остановите/запустите Firebird и замените двоичные файлы. Репликация возможна между узлами с одинаковой версией, т.е. невозможна между версиями 3.0 и 2.5.

== Как работает репликация

Репликация HQbird работает на логическом уровне: она реплицирует изменения сделанные DML (`INSERT`/`UPDATE`/`DELETE`, `EXECUTE PROCEDURE` и др.) и DDL (`CREATE`/`ALTER`/`DROP`) операторами; *никаких дополнительных триггеров не требуется*. Единственное требование к текущей версии репликации -- наличие уникальных или первичных ключей для всех таблиц, изменения в которых необходимо реплицировать.

Чтобы использовать репликацию, вам необходимо установить HQbird, зарегистрировать его (с пробной версией или с полной лицензией) и настроить репликацию. HQbird должен быть запущен на главном сервере и на всех серверах-репликах.

Ниже мы рассмотрим, как настроить репликацию Firebird с помощью HQbird.

_Вы можете использовать HQbird в Windows и Linux с 32-разрядной и 64-разрядной версиями Firebird 2.5, 3.0, 4.0 и 5.0._


<<<

== Установка

Пожалуйста, установите HQbird из прилагаемого дистрибутива. Если у вас установлена другая версия Firebird (2.5, 3.0), сначала удалите ее.

Чтобы включить репликацию, на вашем главном сервере и сервере-реплике должна быть рабочая и зарегистрированная (пробная или полная) копия HQbird.

Пожалуйста, обратитесь к разделу 2 этого руководства для получения подробной информации об установке сервера HQbird.

<<<

== Асинхронная репликация в Firebird

HQbird поддерживает 2 типа репликации: асинхронную и синхронную. В случае асинхронной репликации главный сервер сохраняет подтверждённые изменения из главной базы данных в файлах (сегментах репликации), которые могут использоваться асинхронно одним или несколькими серверами-репликами.

image::6.1.png[]

Как работает асинхронная репликация:

* Изменения на стороне мастер-севера регистрируются в файлах журнала репликации
* Журнал состоит из нескольких сегментов (файлов)
* Сегменты репликации (заархивированные) передаются на сервера-реплики и применяются к репликам в фоновом режиме
* Реплику можно создавать и пересоздавать онлайн (без остановки мастера)

Важные моменты, которые следует учитывать:

* Практическая задержка между мастером и репликой настраивается и может составлять 15-30 секунд (по умолчанию -- 90 секунд).
* Задержка между мастером и репликой может увеличиться в случае большой нагрузки (из-за задержки обработки сегментов репликации)
* Реплику можно переключить в основной (т.е. обычный) режим с помощью 1 команды

*Асинхронная репликация -- рекомендуемый вариант для HQbird*:

* обеспечивает стабильность и защиту от повреждений базы данных Firebird;
* может быть быстро и легко сконфигурирована;
* не требует простоев для настройки;
* имеет возможность повторной инициализации в онлайн режиме;
* подходит для распределенных сред (когда реплика находится в облаке или на удаленном сервере).

Для настройки асинхронной репликации потребуются следующие шаги:

. Настройка HQbird для репликации на главном сервере
. Создание копии файла базы данных master
. Настройка базы данных для репликации на сервере-реплике (подчиненном сервере)


=== Шаг 1: Настройка HQbird для репликации на главном сервере

Чтобы настроить репликацию, откройте HQbird FBDataGuard: запустите современный браузер (Chrome, Firefox и т.д.) и откройте этот локальный URL: http://127.0.0.1:8082/[http://127.0.0.1:8082] (порт, если необходимо настраивается в ini-файлах HQbird).

Введите им и пароль по умолчанию: **admin/strong password**.

Зарегистрируйте сервер Firebird, и появится следующая картинка:

image::6.2.png[]

Убедитесь, что вы действительно подключены к правильной версии Firebird -- в левом верхнем углу в виджете "Active server" должна быть указана версия
"`... Firebird 2.5 *HQbird*`" или "`... Firebird 3.0 *HQbird*`" или "`... Firebird 4.0 *HQbird*`" или "`... Firebird 5.0 *HQbird*`".

После этого нажмите "`Add database`" в правом нижнем углу и укажите ник и путь к базе данных, которая будет основной:

image::6.3.png[]

[NOTE]
====
Пожалуйста, обратите внимание, что база данных должна быть зарегистрирована с указанным в ней явным путем, а не с псевдонимом -- репликация не будет работать с псевдонимом.
====

После успешной регистрации базы данных нажмите на значок в заголовке базы данных, чтобы настроить репликацию:

image::6.4.png[]

После этого появится основное диалоговое окно настройки для баз данных master и replica.

Когда репликация не настроена, это диалоговое окно практически пустое:

image::6.5.png[]


==== Асинхронная репликация на главном сервере

Асинхронная репликация записывает все изменения в главной базе данных в журнал репликации: набор файлов, называемых "сегментами репликации". Сервер реплики получает эти сегменты и применяет их к базе данных реплики.

Ранее мы зарегистрировали "H:\dbwmaster.fdb`, в данном примере это главная база данных. Чтобы настроить асинхронную репликацию на стороне мастера: выберите роль репликации: "`Master`", затем "`Asynchronous`" и нажмите "`Save`".

Начиная с Firebird 4.0, вам необходимо включить публикацию на уровне базы данных. Нажав на кнопку "Enable publications (and grant it for all tables)", вы активируете публикацию и добавляете все таблицы в список для публикации. Списком таблиц для публикации можно управлять в SQL, используя следующие инструкции:

[listing]
----
ALTER DATABASE INCLUDE {TABLE <table_list> | ALL} TO PUBLICATION

ALTER DATABASE EXCLUDE {TABLE <table_list> | ALL} FROM PUBLICATION

<table_list> ::= tablename [, tablename ...]
----

.Диалог настройки репликации для асинхронной репликации
image::6.6.png[]

Единственный параметр, который вы можете изменить, -- это "`*Write commited data every NN seconds*`", он определяет, как часто должны перемещаться зафиксированные данные в архивные сегменты репликации.

По умолчанию это значение равно 90 секундам.

Есть несколько необязательных параметров, которые вы можете изменить, если откроете подробное диалоговое окно с кнопкой btn:[more>>].:

image::6.7.png[]

Давайте рассмотрим все параметры в этом диалоговом окне -- просто чтобы дать вам представление о том, что они делают, *их не нужно изменять*:

* "`Log directory`" -- папка, в которой будут храниться операционные журналы. Это системная папка, полностью управляемая Firebird. По умолчанию `${db.path}.ReplLog` (`db.path` -- это место, где находится база данных). *Нет необходимости изменять значение по умолчанию*.
* "`Log archive directory`" -- папка, в которой будут храниться архивированные журналы. В соответствии со значением по умолчанию `${db.path}.LogArch`, HQbird создаст папку `DatabaseName.LogArch` в папке с базой данных, поэтому *нет необходимости изменять этот параметр*.
* Третий параметр ("`Override log archive command`") необязательный, *оставьте его пустым*.


[NOTE]
====
Пожалуйста, обратите внимание, что параметры репликации инициализируются при первом подключении к базе данных. Вот почему вам необходимо перезапустить службу Firebird (или все подключения в случае Classic) после настройки репликации -- такой перезапуск гарантирует, что репликация запустится должным образом.
====

В этом случае сегменты журнала репликации сначала будут записаны в `${db.path}.ReplLog` (`db.path` -- это место, где находится база данных -- в нашем примере это будет `H:\DBWMaster.fdb.ReplLog`), а после достижения максимального размера сегмента, или количество коммитов, или после другого триггера, будет запущена команда архивирования по умолчанию -- она скопирует заархивированные сегменты репликации в `${db.path}.LogArch` (в нашем примере это будет `H:\DBWMaster.fdb.LogArch`).

После запуска репликации вы сможете увидеть файлы сегментов репликации в папке, указанной в  "`Log directory`" , сразу после выполнения любой операции с главной базой данных:

image::6.8.png[]

Сегменты репликации ротируются ядром Firebird, и когда отдельный сегмент заполнен, он копируется в папку архива логов. Размер сегмента по умолчанию 16 мегабайт.

Пожалуйста, обратите внимание - вам не нужно ничего делать с операционными сегментами!

После подтверждения транзакции и/или указанного времени ожидания сохраненных данных вы увидите заархивированные сегменты в папке, указанной в "`Log archive directory`".

Архив логов репликации это набор файлов в хронологическом порядке. Эти файлы должны быть импортированы сервером реплики в базу данных реплики.

.Important!
[IMPORTANT]
====
Для пользователей Linux -- убедитесь, что владельцем папки с базой данных является пользователь `firebird`. HQbird работает под управлением пользователя "`firebird`" в Linux, и папка с базой данных должна иметь разрешения для "`firebird`" для создания папки журналов (`chown firebird -R /your/database/folder`).
====

==== Как скопировать сегменты репликации с мастера на реплику?

Существует 2 популярных способа скопировать архивные сегменты с главного сервера на серверы-реплики: через общий сетевой ресурс и с помощью задания <<_hqbird_config_cloud_backup>> на главном сервере и <<_hqbird_config_cloud_backup_receiver>> на реплике.

===== Общий сетевой ресурс

Вы можете предоставить общий доступ к папке с архивированными сегментами в качестве общего сетевого ресурса. В этом случае у службы Firebird должно быть достаточно прав для чтения, записи и удаления файлов на этом общем сетевом ресурсе. Обычно службы Firebird и HQbird запускаются под учетной записью LocalSystem, у которой нет доступа к общим сетевым ресурсам. Замените ее на какую-нибудь более мощную учетную запись (например, Администратора домена).

===== Отправка/приём сегментов репликации 

Мы рекомендуем использовать HQbird FBDataGuard для отправки сегментов репликации с главного сервера на реплику по FTP: он сжимает, шифрует и загружает сегменты на указанный FTP-сервер. На этом сервере другой HQbird FBDataGuard распаковывает сегменты и копирует их в необходимую папку для дальнейшего использования репликой.

[NOTE]
====
Пожалуйста, ознакомьтесь с заданием <<_hqbird_config_cloud_backup>> для получения более подробной информации о том, как настроить передачу архивированных сегментов между мастером и репликами.
====

=== Шаг 2: Создание копии файла базы данных master

Чтобы начать репликацию, нам необходимо создать копию исходного файла базы данных, которая будет использоваться в качестве целевой для процесса репликации. Давайте будем называть такой файл базы данных `"реплика"`.

Начиная с HQbird 2018 R2, реплика будет автоматически создаваться в папке, которую вы укажете в диалоговом окне после нажатия на "`Reinitialize replica database`".

image::6.9.png[]

Если у вас достаточно места в папке с базой данных, *просто оставьте путь пустым* и нажмите btn:[Ок], и рядом с базой данных будет создана реплика. Или вы можете указать другое место назначения на локальных дисках с достаточным количеством свободного места.

.Важно!
[IMPORTANT]
====
Если свободного места будет недостаточно (менее 105% от размера базы данных), HQbird не будет создавать копию -- появится соответствующее сообщение об ошибке.
====

Если вы нажмете кнопку btn:[Ок], HQbird запустит процесс создания реплики. Об этом появится соответствующее сообщение:

image::6.10.png[]

В случае действия по умолчанию результирующая база данных будет находиться в той же папке, что и база данных. Имя реплики будет  `DATABASE_NAME.EXT.DD-MMM-YYYY_NNNN.4replica` -- например, `employee30.fdb.17-Apr-2018_142507.4replica`

[NOTE]
====
Обратите внимание! Создание реплики может занять значительное время в случае большой базы данных!
====

Все этапы создания реплики отображаются в виде оповещений в HQbird (также отправляются по электронной почте):

image::6.11.png[]


[NOTE]
====
Убедитесь, что процесс создания реплики был успешно завершен -- проверьте вкладку "`Alerts`"!
====

=== Шаг 3: Настройка базы данных для асинхронной репликации на сервере-реплике (подчиненном сервере)

После завершения настройки асинхронной репликации на главном сервере нам необходимо настроить ее для базы данных-реплики на экземпляре сервера-реплики.

Прежде всего, мы предполагаем, что вы успешно установили HQbird на сервер-реплику. Мы рекомендуем использовать на сервере-реплике SuperClassic для Firebird 2.5 и SuperServer для Firebird 3.0 и выше (это конфигурации HQbird по умолчанию).

**Пользователи Firebird Classic Linux**: Если вы запускаете Firebird на сервере-реплике в классическом режиме в Linux, вам необходимо запустить дополнительный процесс Firebird replicator с помощью команды "fb_smp_server -r`.

Во-вторых, база данных реплик должна быть зарегистрирована в HQbird FBDataGuard. Если вы намерены использовать автоматическую повторную инициализацию, вы можете зарегистрировать какую-нибудь небольшую базу данных (`employee.fdb`) с требуемым именем и выполнить повторную инициализацию: в результате реплика базы данных будет автоматически перенесена с главного сервера.

В-третьих, мы предполагаем, что вам удалось настроить передачу журналов с помощью заданий <<_hqbird_config_cloud_backup>>/<<_hqbird_config_cloud_backup_receiver>> или с помощью сетевого общего доступа.

[NOTE]
====
Обратите внимание: перед регистрацией база данных должна иметь GUID реплики базы данных! Этот GUID создается автоматически, если вы воспользовались ссылкой "`Reinitialize replica database`", но если вы выполняете повторную инициализацию вручную, не забудьте установить его, иначе будет выдана ошибка об отсутствии GUID базы данных.
====

Затем завершите настройку репликации -- единственным обязательным параметром является путь к папке с архивированными сегментами репликации, и по умолчанию он уже установлен -- HQbird создаст папку с журналами рядом с базой данных:

image::6.12.png[]

Итак, здесь не нужно ничего менять, просто нажмите btn:[Сохранить].

Предполагая, что база данных реплики настроена как `D:\DATABASE\DBWREPLICA.FDB`, HQbird создаст папку `D:\DATABASE\DBWREPLICA.FDB.LogArch`, и replica импортирует из нее файлы сегментов репликации.

Нажмите btn:[Сохранить] и перезапустите службу Firebird (чтобы убедиться, что параметры репликации были применены).

После перезапуска сервер-реплика начнет использовать сегменты репликации из папки -- обратите внимание, что после импорта все обработанные сегменты будут удалены. Также будет создан файл с именем `{DATABASE-GUIDE}` -- это так называемый контрольный файл. Firebird хранит в нем некоторую внутреннюю информацию о ходе репликации.

[NOTE]
====
Не рекомендуется хранить архивные сегменты репликации из разных баз данных в одной папке! Всегда выделяйте отдельную папку для каждой пары баз данных мастер-реплика!
====

<<<

== Автоматическая инициализация и переинициализация реплики

We recommend using Cloud Backup on the master and Cloud Backup Receiver on the replica to implement the transfer and check integrity of the replication segments through FTP. In this case, it is also possible to implement 1-click re-initialization for the replica database.

If Cloud Backup and Cloud Backup Receiver have the following options enabled (by default), HQbird perform the re-initialization automatically, including restart of replica database:

image::6.13.png[]

Parameter "`Prefix to name uploaded reini files`" should be changed if you intend to initialize several copies of the master database through the single folder -- in this case set it should be unique for each database.

In case of the single database, no changes are required.

=== How re-initialization works

If Cloud Backup/Cloud Backup Receiver are configured, it is possible to perform the complete re-initialization with 1 click to "`Reinitialize replica database`".

Once clicked, the master HQbird will do the following:

. Ask you where to store copy of the database (by default it is near the master database, click Ok to store database there).
. Master database will be copied (with `nbackup`)
. The created copy of the database will be set to the replica mode
. md5 hash-sum will be calculated for the copy
. According the settings in Cloud Backup (Enable replication should be Enabled), master HQbird will upload database to the specified FTP

Next steps will be done by replica HQbird instance:

. Once replica HQbird will notice the reini* files in the incoming FTP folder, Cloud Backup Receiver will start the procedure of re-initialization.
. Processing if usual arch-segments will be stopped
. The arrived database will be checked -- md5 hash-sum will be calculated and compared with the value in the accompanied report file.
. The existing replica database will be shutdown to disconnect all users
. New replica database will be copied over the existing database
. The replica server may require restart to see new replica.

Replica is back to the normal mode.

=== Troubleshooting asynchronous replication

If you have setup asynchronous replication, but it does not work, the first thing is to enable job "`Replication Log`" on the master and on the replica. This job parses `replication.log` files, and if there are errors, creates the appropriate alert.

image::6.14.png[]

Also, the good thing is to enable "`Verbose`" option on the replica, and restart Firebird. Verbose will make Firebird to write a lot of details about replication into the `replication.log` file (near `firebird.log`).

image::6.15.png[]

Usually the text of the error is self-explanatory, but since there are some popular questions which occur regularly, we decide to create the table with the list of main problems with asynchronous replication and ways to resolve it.

[cols="1,1", options="header"]
|===
| Problem
| Possible reasons and how to resolve


|Master part of replication was configured, but folders for operational or archived segments (`${dbpath}.LogRepl` or `${dbpath}.LogArch`) are not created
|HQbird creates these folders automatically, but it requires permissions.

On Windows: these folders should be on local drives, or HQbird and Firebird services must run with "`Run As`" with the powerful account (Domain Admin?).

On Linux: folders must have permissions for "`firebird`" user.

|Master part of replication was configured; folders for `ReplLog` and `LogArch` were created, but nothing appear there. `Replication.log` is empty.
|Firebird does not see the replication configuration. Restart Firebird service (all connections in case of Classic) to make read the new configuration.

|Master part of replication was configured; there are files `databasename.log-000` in ReplLog folder, but no files in `LogArch`. Also, could be errors about insufficient space or out of space in `replication.log`
|It means that there is no permission for Firebird to access the `LogArch` folder and create replication segment files (`databasename-logarch.000XXX`) there.

If `LogArch` folder on the network share or mounted drive, make sure that Firebird has rights (full access) to access it.

|"`Verbose`" option on replica is enabled, but `replication.log` is empty or nor created.
|Sometimes Firebird cannot create `replication.log` or even write to already created file. Try to create it manually and apply necessary permissions to it (especially on Linux). Verbose output should be written to the `replication.log` every 60 seconds even if there is no segments to import.

|Master part of replication is Ok, but replica does not consume replication segments. `replication.log` file is empty.
|Replica did not read the new replication configuration. Restart Firebird.

|Master part of replication is Ok, but replica does not consume replication segments. `replication.log` contains errors about permissions.
|Replica does not have enough permissions to read from the `LogArch` folder. Set necessary permissions or run replica under powerful account.

|Replica has errors in `replication.log` "`Segment NNN is missing`"
|Check is there such segment on the replica side, and if it is on the master size. If segment has size = 0 on replica, copy it manually or use "`Perform fresh backup`" checkmark in Cloud Backup.

|Replica has errors in `replication.log` about wrong foreign keys and stopped consume segments
|It means that replica copy is desynchronized, so some records do not have the appropriate values in referenced tables for the specified Foreign Key. Replica should be reinitialized. If you see this errors often, please contact IBSurgeon support.

|===

<<<

== Synchronous replication for Firebird

In case of synchronous replication, master server directly inserts committed changes of the master database to one or more replicas databases:

image::6.16.png[]

The main features of the synchronous replication are the following:

* Changes are buffered per transaction, transferred in batches, synchronized at commit
* Practical delay is below1 second
* Follows the master priority of locking
* Replication errors can either interrupt operations or just detach replica
* Replica is available for read-only queries (with caveats)
* Automatic fail-over can be implemented (with HQbird Cluster Manager)

Issues to be considered

* Additional CPU and I/O load on the replica side
* Requires direct and permanent network connection from master to replica(s), 1+Gbps recommended
* Replica can be recreated online, re-initialization of synchronous replication requires stop of master

When to use synchronous replication:

* Custom fail-over cluster solutions with 3+ nodes (especially for web applications)
* Scale performance by moving reads to the separate replica server (report servers, data marts or read-only web representation)
* In combination with asynchronous replication for performance scaling


=== Steps to setup synchronous replication

. Stop Firebird
. Create a copy of master database file, switch it to replica mode and copy it to the replica server(s)
. Setup replica server(s) and database(s) for replication with HQbird FBDataGuard
. Start replica server(s) -- before master server!
. Setup master server and master database for replication with HQBird FBDataGuard
. Start master server

As you can see, the downtime required for initialization the synchronous replication is bigger than downtime to configure asynchronous replication, because replica database must be online before master's start.

=== Synchronous replication at master and replica

Synchronous replication is designed to write changes from the master database directly to the replica database. The big advantage of synchronous replication that replication delay can be very small, but the disadvantage is that in the case of the lost connection between master and replica servers there will be gaps in transmitted data.

image::6.17.png[]

In this example, the synchronous replica database is on the remote server with IP address *replica server* and path `/data/test2.fdb`.

No setup is necessary for synchronous replication on the replica server, except `gfix –replica <master-guid>` for the replica database to switch it to the replica mode.

=== Replication parameters for testing synchronous replication

In the case of testing synchronous replication of HQbird Enterprise on the production system, we recommend setting parameter _disable_on_error_ to true.

image::6.18.png[]

It will switch off replication in case of replication error, and the master server will continue to work without replication.

To reinitialize replication the replication log should be analyzed and all initialization steps should be done again.

Also, please enable job "`Replication log`" in HQbird FBDataGuard to monitor replication log for errors and warnings:

image::6.19.png[]

<<<

== How to manually create replica of the database?

_Of course, it is always possible to create replica with the simple copy process: stop Firebird on master, copy database file, complete setup of replication on the replica, then start Firebird. However, HQbird supports online replica creation -- see details below._

If, for some reason, you cannot use the automatic replica creation (which is available since v. 2018 R2), you can create replica copy of the master database manually.

Starting with HQbird 2018, it is possible to create replica file without stopping the master server, with `nbackup`. It is easy for asynchronous replication, and it also makes possible to create additional replicas online -- i.e., without stopping a master.

=== Creating copy online (with nbackup)

Let's consider how to create replica for asynchronous replication using nbackup:

. apply nbackup lock
+
[listing]
----
nbackup –l database_path_name -user SYSDBA –pass masterkey
----
. copy locked database file to create a replica
+
[listing]
----
copy database_path_name replica_path_name
----
. unlock master database
+
[listing]
----
nbackup –n database_path_name -user SYSDBA –pass masterkey
----
. Fixup replica database
+
[listing]
----
nbackup –f replica_path_name_name
----
. Switch database to replica mode
+
for Firebird 2.5 and 3.0
+
[listing]
----
gfix replica_path_name –replica {DATABASEGUID} –user SYSDBA –pass masterkey
----
+
for Firebird 4.0
+
[listing]
----
gfix replica_path_name –replica <replica_mode> –user SYSDBA –pass masterkey

<replica_mode> ::= read_only | read_write
----
+


=== What is {DATABASEGUID}?

Database GUID is the unique identifier of a master database. 

To find out {DATABASEGUIDE}, run command `gstat –h`:

image::6.20.png[]

To switch database to the replica mode run the following command:

[listing]
----
gfix disk:\path\mydatabase.fdb -replica {guid} -user SYSDBA -pass masterkey
----

[NOTE]
====
If you don't see Database GUID in `gstat –h` output, connect to the master database using Firebird binaries from HQbird distribution (with `isql` or any other application), and run `gstat –h` again.
====

=== How to set replica database to the master mode

To switch database to the normal (master) mode run the same command with the empty {} instead of database GUID:

for Firebird 2.5 and 3.0

[listing]
----
gfix disk:\path\mydatabase.fdb -replica {} -user SYSDBA -pass masterkey
----

for Firebird 4.0

[listing]
----
gfix replica_path_name –replica none –user SYSDBA –pass masterkey
----

<<<

== How to distinguish master database from replica

=== Using gstat -h

If you run `gstat –h database_name`, the output will contain the keyword "`replica`" in Attributes section for database configured as replica:

[listing]
----
Database "D:\O30.FDB"
Gstat execution time Mon Nov 26 17:47:07 2018

Database header page information:
Flags                   0
Generation              187842
System Change Number    15
Page size               8192
ODS version             12.0
Oldest transaction      173630
Oldest active           185440
Oldest snapshot         185440
Next transaction        185441
Sequence number         0
Next attachment ID      24975
Implementation          HW=AMD/Intel/x64 little-endian OS=Windows CC=MSVC
Shadow count            0
Page buffers            0
Next header page        0
Database dialect        3
Creation date           Jan 11, 2017 15:12:20
Attributes              replica

Variable header data:
Database backup GUID:   {37E7918F-5478-43CF-E3B2-D80B0E7D3F63}
Sweep interval:         0
Database GUID:  {BBBD2881-ACDE-4636-CEB2-7EE31AF66CC3}
Replication master GUID: {BBBD2881-ACDE-4636-CEB2-7EE31AF66CC3}
*END*
Gstat completion time Mon Nov 26 17:47:07 2018
----

For master database there is no special marks in Attributes.

=== With SQL query to the context variable

In Firebird 2.5 and 3.0, there is a context variable `REPLICA` in the `SYSTEM` area that contains information about database status:

[listing]
----
SQL> select RDB$GET_CONTEXT('SYSTEM', 'REPLICA') from rdb$database;

RDB$GET_CONTEXT
================================================================
FALSE
----

In Firebird 4.0 use another context variable `REPLICA_MODE`:

[listing]
----
SQL> select RDB$GET_CONTEXT('SYSTEM', 'REPLICA_MODE') from rdb$database;

RDB$GET_CONTEXT
================================================================
READ-ONLY
----

Also in Firebird 4.0 you can use the `MON$DATABASE` monitoring table:

[listing]
----
SQL> SELECT MON$REPLICA_MODE FROM MON$DATABASE;

MON$REPLICA_MODE
================
               1
----

Database replica mode:

* 0 -- not a replica
* 1 -- read-only replica
* 2 -- read-write replica

<<<

== Optional parameters for replication

It is possible to specify several additional parameters for fine tuning of the replication process. These parameters can be specified in the "`Optional parameters`" of replication setup dialog.

. Size of the local buffer used to accumulate replication events that can be deferred until the transaction commit/rollback. The bigger this value the less network round-trips between master and slave hosts are performed. However, it costs longer replication "`checkpoints`" (time to synchronize the original database with its replica).
+
[listing]
----
buffer_size = 1048576
----
. If enabled, any error during replication causes the master to stop replicating changes and continue working normally. Otherwise (the default behavior), the master reports an error.
+
[listing]
----
disable_on_error = false
----
. If enabled, replicated records are RLE-compressed before transmission and decompressed on the slave side. It reduces the traffic and (indirectly) a number of round-trips at the cost of extra CPU cycles on both sides.
+
[listing]
----
compress_records = false
----
. If enabled, conflicting records in the target database are modified to match records in the master database. In particular:
+
** if there's an insert and the target record exists, it gets updated;
** if there's an update and the target record does not exist, it gets inserted;
** if there's a delete and the target record does not exist, it gets ignored.

[listing]
----
master_priority = false
----
. Pattern (regular expression) that defines what tables must be included into replication. By default, all tables are replicated.
+
[listing]
----
include_filter
----
. Pattern (regular expression) that defines what tables must be excluded from replication. By default, all tables are replicated.
+
[listing]
----
exclude_filter
----
. If enabled, tables without primary key (or unique index) excluded from replication. By default, all tables are replicated.
+
[listing]
----
exclude_without_pk = false
----
. Program (complete command line with arguments) that is executed when the current replication session notices a critical error. This command is executed once per every failed replication session. Please note that the program is executed synchronously and the server is waiting for its completion before continuing its operations.
+
[listing]
----
alert_command
----
. Prefix for replication log file names. It will be automatically suffixed with an ordinal sequential number. If not specified, database filename (without path) is used as a prefix.
+
[listing]
----
log_file_prefix
----
. Maximum allowed size for a single replication segment. It must at least double the specified __buffer_size__.
+
[listing]
----
log_segment_size = 16777216
----
. Maximum allowed number of full replication segments. Once this limit is reached, the replication process is delayed for _log_archive_timeout_ seconds (see below) to allow the archiving to catch up. If any of the full segments is not archived and marked for reuse during the timeout, the replication fails with an error.
+
Zero means an unlimited number of segments pending archiving.
+
[listing]
----
log_segment_count = 8
----
