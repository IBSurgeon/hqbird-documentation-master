[[hqbird-config]]
= Настройка заданий, мониторинга и обслуживания в FBDataGuard

Пожалуйста, выполните следующие шаги:

. Убедитесь что у вас установлен Firebird 2.5.5 или новее, и он работает;
. Служба HQbird FBDataGuard установлена и запущена
+
.. Проверить это можно с помощью апплета "`Службы`" в Панели управления (щелкните правой кнопкой мыши "`Мой компьютер`", выберите "`Управление`", затем "`Службы и приложения`", "`Службы`" и найдите в списке "`Agent FBDataGuard`"
.. В Linux вы можете проверить это с помощью команды `ps aux | grep dataguard`.
. Убедитесь, что порт FBDataGuard доступен (8082) и не заблокирован брандмауэром или другими антивирусными инструментами. При необходимости настройте порт в файле конфигурации FBDataGuard (см. <<hqbird-config-fbdataguard-port>>).


== Запуск веб-консоли

Чтобы открыть веб-консоль, введите в браузере `http://localhost:8082` или используйте IP-адрес вашего сервера с установленным HQbird ServerSide.

Или вы можете выбрать в меню "`Пуск`" menu:IBSurgeon[FBDataGuard].

=== Поддерживаемые браузеры

Веб-интерфейс FBDataGuard корректно работает с Firefox, Chrome, Safari, Microsoft Edge и Internet Explorer 11.

=== Сообщение об ошибке сертификата веб-сайта

Если вы настроили FBDataGuard на использование https, браузер укажет, что этот сайт небезопасен, и предложит покинуть сайт. Это сообщение вызвано сертификатом безопасности по умолчанию для веб-консоли FBDataGuard.

Пожалуйста, проигнорируйте это сообщение и нажмите открыть веб-консоль FBDataGuard.

Он запросит у вас имя пользователя и пароль (диалог входа в систему может отличаться для Firefox, Safari или Chrome).

.Ввод логина и пароля для веб-консоли FBDataGuard.
image::3.1.1.png[]


.Внимание!
[IMPORTANT]
====
По умолчанию пользователь/пароль для HQbird FBDataGuard -- "**admin"/"strong password**" (без кавычек).
====

=== Функция автоматического обнаружения FBDataGuard

При первом запуске FBDataGuard проверит компьютер на наличие установленных серверов Firebird. FBDataGuard для Windows ищет в реестре записи Firebird, FBDataGuard для Linux проверяет местоположения по умолчанию для установок Firebird.

FBDataGuard покажет список всех установленных копий Firebird, но FBDataGuard может отслеживать только один экземпляр Firebird.
Выберите его, нажав btn:[Добавить в мониторинг &gt;&gt;]

Если вы не видите экземпляр Firebird в списке автоматического обнаружения, вы можете выбрать btn:[Добавить сервер вручную &gt;&gt;] и настроить параметры экземпляра вручную.

.Функция автоматического обнаружения HQbird.
image::3.1.2.png[]

<<<

== Обзор веб-консоли.

=== Части веб-консоли.

image::3.2.1.png[]

Веб-консоль FBDataGuard содержит 7 вкладок (в левой части экрана, обычно они свернуты):

* _Dashboard_ -- это основная вкладка, где администратор может настроить HQbird FBDataGuard и просмотреть статусы сервера и баз данных.
* _Alerts_ -- содержит полный список оповещений, созданных FBDataGuard.
* _FTP active sessions_ -- отображать информацию об активных FTP-сессиях.
* _Registration_ -- информация о лицензии и регистрации/активации.
* _Graphs gallery_ -- графики производительности.
* _Performance_ -- настройки мониторинга производительности и отчеты о производительности.
* _Speed test_ -- тест скорости

=== Задачи

Веб-консоль предназначена для удобной настройки действий (называемых **"`задачи`"**), которые выполняет HQbird FBDataGuard.

Почти все задания FBDataGuard имеют две цели: первая — отслеживать некоторые значения и при необходимости выдавать оповещения, а вторая — сохранять исторические значения в журналах, чтобы позже можно было увидеть динамику важных параметров сервера Firebird и базы данных.

В этом разделе мы рассмотрим общую настройку параметров заданий, а не анализ собранных логов.

=== Виджет задачи

Общий подход следующий: каждое действие представляется "`виджетом`", который состоит из следующих частей:

.Элементы виджета веб-консоли FBDataGuard.
image::3.2.2.png[]

Статус -- обозначается цветным значком и названием.
Статус базы данных представляет собой сводку всех включенных заданий уровня сервера и статусов баз данных, и, соответственно, статус базы данных представляет собой сводку всех заданий уровня базы данных.

=== Типы статусов

*CRITICAL* означает проблемы, *OK* означает "`Все в порядке`", *WARNING* означает некоторые проблемы, требующие внимания, *MAJOR* означает серьезную проблему, *MINOR* – незначительная проблема, *MALFUNCTION* означает, что задание не удалось выполнить (что-то препятствует его выполнению), *NOT_AVAILABLE* означает, что задание недоступно в этой версии сервера или базы данных.

*OFF* означает, что задание не активно, *UNKNOWN* означает, что задание активно, но еще не запущено, поэтому фактические результаты неизвестны.

*Job name* -- имя задачи.

* image:3.2.3.png[] Кнопка конфигурации открывает диалог настройки, индивидуальный для каждого задачи.
* image:3.2.4.png[] Запускает задачу немедленно.
* image:3.2.5.png[] Resolved -- это ссылка для сброса статуса на UNKNOWN и забывания ошибок, которые были обнаружены ранее. Статус будет обновлен в соответствии с текущей ситуацией после следующего выполнения задания.

*Last run* показывает время после последнего запуска этого задания.

*Period/Schedule to run* показывает, как часто и когда будет запускаться задание.

*More &gt;&gt;* -- это ссылка, которая открывает виджет и показывает более подробную информацию и предлагаемые действия администратору для разрешения ситуации.

Все задания в FBDataGuard имеют настройки по умолчанию, которые очень близки к рекомендуемым значениям для 80% установок Firebird, поэтому после первоначальной настройки сервер и база данных будут защищены на довольно хорошем уровне по сравнению с установкой по умолчанию, однако мы рекомендуем дополнительную настройку для каждой задачи. В следующих разделах мы рассмотрим каждое задание и его настройку.

<<<

== Конфигурация сервера Firebird в FBDataGuard

=== Регистрация сервера Firebird

Чтобы зарегистрировать автоматически обнаруживаемый сервер, вам нужно нажать btn:[Добавить в мониторинг &gt;&gt;], a затем настроить параметры автоматического обнаружения.

[NOTE]
====
Примечание. Чтобы использовать доверенную аутентификацию Windows (по умолчанию она отключена), вам необходимо быть уверенным, что библиотеки `jaybird30.dll` и `fbclient.dll` (из соответствующей версии Firebird) находятся в доступных для поиска путях Windows.
====

При установке под Windows, если выбрана опция автоматической регистрации master/replica, то сервер будет добавлен автоматически. В этом случае этот шаг можно пропустить. Если выбран вариант автоматической регистрации реплики, то база данных будет добавлена дополнительно.

Давайте рассмотрим, что вы можете увидеть в диалоге Server (как правило, вам не нужно ничего менять):

[horizontal]
Установлен в папке:: Папка установки Firebird
Папка Bin для Firebird:: Папка исполняемых файлов Firebird (для Firebird 3 и выше в Windows она совпадает с папкой установки)
Log:: расположение `firebird.log`
Configuration file:: расположение `firebird.conf`
Aliases:: расположение `aliases.conf` или для Firebird 3 и старше `databases.conf` ( *пожалуйста, измените его вручную, если необходимо* )
Хост:: имя или IP-адрес сервера, обычно `localhost`
Порт:: порт для Firebird, согласно настройке `firebird.conf`
Использовать trusted auth:: use trusted authentication, by default it is off
Логин:: имя пользователя (администратора), обычно это SYSDBA
Пароль:: пароль пользователя (пароль SYSDBA)
User for Services API:: имя пользователя для служб Firebird. Обычно совпадает с *Логин*.
Password for Services API user:: пароль пользователя для служб Firebird.
Server authentication plugin list:: список плагинов аутентификации.
Папка результатов:: Папка, в которой будут храниться резервные копии, статистика и собранные журналы.

.Регистрация сервера в HQbird FBDataGuard.
image::3.1.3.png[]

По умолчанию "`Папка результатов`" для сервера Firebird -- `${agent.default-directory}/${server.id}`, она соответствует `C:\HQbirdData` в случае установки по умолчанию.

Это может быть не очень удобно, поэтому мы рекомендуем указать выходной каталог FBDataGuard по более простому пути, обычно расположенному на диске, где предполагается хранить резервные копии, например `F:\myserverdata`.

После нажатия кнопки "`Сохранить`" FBDataGuard заполнит файлы конфигурации по умолчанию и немедленно начнет анализ `firebird.log`. Это может занять некоторое время (например, 1 минута для `firebird.log` размером 100 МБ). После этого вы увидите начальную веб-консоль с зарегистрированным сервером Firebird:

.HQbird FBDataGuard с зарегистрированным сервером Firebird.
image::3.1.4.png[]

FBDataGuard показывает оповещения и статусы контролируемых объектов: если все в порядке, он показывает зеленые знаки, в противном случае будут желтые или красные уведомления.

Ниже мы подробно рассмотрим каждый контролируемый объект и его настройки.

[NOTE]
====
Примечание: вы не можете удалить зарегистрированный сервер Firebird в веб-консоли FBDataGuard.
Единственный способ отменить регистрацию сервера -- удалить его файлы конфигурации.
В общем, нет смысла удалять зарегистрированный сервер, пока вы не захотите полностью удалить FBDataGuard.
====

=== Сервер: Active server

Сервер: Виджет Active server отображает сводный статус всех заданий уровня сервера и статусы отслеживаемых баз данных.

image::3.2.6.png[]

**Сервер: Active server** также указывает, работает ли Firebird в данный момент или нет, и показывает подробную версию Firebird и HQbird.

Если вы нажмете ссылку *Настройка*, то увидите тот же диалог, который мы использовали для регистрации экземпляра Firebird в FBDataGuard, и теперь его можно использовать для изменения свойств экземпляра Firebird:

image::3.2.7.png[]

В общем, нет необходимости редактировать данные сервера Firebird после регистрации, пока вы не переустановите Firebird -- но в этом случае мы рекомендуем также переустановить HQBird.

[[hqbird-config-repllog]]
=== Сервер: Лог репликации

image::3.2.11.png[]

FBDataGuard проверяет `replication.log` на наличие ошибок.
В случае ошибки он отправляет соответствующее предупреждение (по электронной почте) администратору.

Чтобы включить это задание, установите флажок "`Включить`".

image::3.2.12.png[]

* "`Период проверки, минуты`" -- как часто проверять файл `replication.log` на наличие изменений.
* "`Размер для переименования, байты`" -- если `replication.log` превысит значение, он будет переименован в соответствии с шаблоном даты и времени.
* "`Шаблон имени для переименования`" -- как переименовать `replication.log`
* "`Keep N rolled old log files`" -- сколько ошибок будет храниться в списке последних ошибок.

[[hqbird-config-serverlog]]
=== Сервер: Лог Firebird

image::3.2.13.png[]

Задание "`Лог Firebird`" периодически проверяет `firebird.log`, и если обнаруживает, что файл был изменен, начинается анализ журнала. Встроенный аналитический механизм проверяет каждую запись в файле `firebird.log` и классифицирует их по нескольким категориям с разными уровнями серьезности. В зависимости от серьезности сообщений назначается статус задания и генерируются соответствующие оповещения.

После того, как администратор просмотрит ошибки и предупреждения (и выполнит необходимые действия для устранения причины ошибки), ему необходимо нажать на ссылку *"`Исправлено`"*, и FBDataGuard забудет старые сообщения об ошибках в `firebird.log`.

В диалоге настройки "`Лог Firebird`" вы можете включить/отключить это задание и установить период проверки (в минутах).

image::3.2.14.png[]

Также это задание отслеживает размер `firebird.log`, и если его размер превышает "Размер для переименования", FBDataGuard разделит `firebird.log` и переименует его в соответствии с шаблоном даты и времени.

=== Сервер: Временные файлы

image::3.2.15.png[]

Задание "`Server: Temp files`" полезно для обнаружения и решения проблем с производительностью базы данных Firebird.

При выполнении SQL-запросов Firebird сохраняет промежуточные результаты сортировки и объединения потоков данных во временных файлах, которые размещаются в папках `TEMP`. FBDataGuard показывает в виджете "`Сервер: Временные файлы`" информацию о количестве и размере временных файлов.

FBDataGuard распознает расположение папок `TEMP` и отслеживает количество и размер временных файлов. Нехватка места может привести к проблемам с производительностью или более серьезным ошибкам, слишком большое количество (или слишком большие) временных файлов может указывать на проблемы с качеством SQL-запросов.

image::3.2.16.png[]

Используя диалог конфигурации, вы можете включить/отключить это задание, установить период проверки и пороговые значения для максимального размера временных файлов (размера всех файлов) и количества.

Если вы видите, что размер временных файлов слишком велик и на сервере достаточно оперативной памяти, увеличьте параметр `TempCacheLimit` в `firebird.conf`, чтобы все временные таблицы поместились в оперативную память.

Кроме того, HQbird проверяет другие временные файлы, используемые Firebird -- если вы видите экстремальные значения (несколько ГБайт) для трассировки или мониторинга, хорошей идеей будет проверить папку `FIREBIRD_TMP` на наличие устаревших файлов (со старыми метками времени модификации). Обратите внимание: снимок экрана ниже не является настоящим предупреждением (т. е. значение ОК), он был создан для демонстрации вывода в случае больших временных файлов.

image::3.2.17.png[]

=== Сервер: Размер каталога Firebird

Задание "`Размер каталога Firebird`"  отслеживает размер, занимаемый установкой Firebird. Оно включен по умолчанию.

image::3.2.18.png[]

Это задание предотвращает несколько угроз: проблемы неправильного администрирования при создании томов базы данных или внешних таблиц в папке `%Firebird%\Bin`, очень большой файл `firebird.log`, который может исчерпать все места на диске с установленным Firebird, и некоторые другие проблемы.

Также это задание отслеживает и анализирует информацию, собранную всеми заданиями, связанными со свободным пространством (включая задания на уровне базы данных). На рисунке ниже вы можете увидеть краткое представление анализа пространства для всех дисков, на которых хранятся базы данных Firebird и резервные копии.

С помощью диалога конфигурации вы можете включить/отключить это задание, установить период проверки и пороговые значения размера папки сервера.

image::3.2.19.png[]

По умолчанию мы используем 1 Гб -- это стандартная настройка для установки Firebird.

Если размер вашего Firebird больше, рассмотрите возможность очистки старых журналов и других нежелательных артефактов или увеличьте параметр *Максимум занято* (в байтах), чтобы предотвратить ложные оповещения.

**Примечание для пользователей Linux**: если вы видите красное предупреждение с противоречивой информации о свободном пространстве, добавьте каталоги с базой данных и резервными копиями в виджете "`Место на диске`":

image::3.2.20.png[]

Вы можете получить представление о том, где находится ваша база данных и резервная копия, с помощью команды `df -h`.

=== Сервер: Размер каталога данных HQbird

image::3.2.8.png[]

Мониторинг "`Размер каталога данных HQbird`"  предназначен для наблюдения за пространством, занимаемым отчетами, журналами, статистикой, хранилищем метаданных и другими данными, собранными и сгенерированными HQbird -- по умолчанию это папка `C:\HQbirdData\output`.

Для баз данных, находящихся без присмотра в течение длительного времени (1-2 года), возможно, что журналы FBDataGuard займут слишком много места, а нехватка места может привести к сбою базы данных. Чтобы наверняка это предотвратить, задание "`Размер каталога данных HQbird`" отслеживает занятое место.

По умолчанию задание "`Размер каталога данных HQbird`" включено.

Кроме того, если кто-то проигнорировал рекомендации по размещению папок резервных копий в определенных местах, вполне возможно, что резервная копия базы данных будет создана внутри папки Агента. В этом случае вы сразу увидите CRITICAL статус -- FBDataGuard распознает это и предупредит вас о неправильной конфигурации.

Это задание полезно для связок FBDataGuard и сторонних приложений.

В диалоге конфигурации вы можете включить/отключить это задание, установить период проверки (по умолчанию 10 минут) и установить пороговые значения для оповещений.

Пороговые значения могут быть установлены в % от максимального размера, занимаемого журналом, или с указанием явного размера в байтах.

FBDataGuard проверяет оба значения и выдает предупреждение для первого порога. Если вы хотите установить только %, вам нужно установить -1 в качестве значения «Максимум занято, байт».

image::3.2.10.png[]

=== Сервер: Group sweep

image::3.1.13.png[]

Задание "`Group sweep`" полезно в том случае, если на одном сервере работает много баз данных. В этом случае задание "`Group sweep`" позволяет позволяет выполнять интеллектуальный Sweep для всех баз данных расположенных по указанному пути включая подпапки.

В диалоге настройки "`Group sweep`" можно указать, где расположены базы данных, настроить маску включения и/или исключения для выполнения sweep только для определённых баз данных, а также настроить время запуска процесса.

image::3.1.14.png[]

Задание "`Group sweep`" имеет те же параметры, что и <<hqbird-config-sweep>>, а также следующие дополнительные параметры:

* "`Database root dir`" -- указывает корневую директорию в которой производится поиск баз данных для выполнения Sweep.
* "`Recursive search`" -- если этот флажок установлен, то поиск базы данных происходит рекурсивно во всех подпапках корневой папки.
* "`Include file mask`" -- регулярное выражения для включения файла БД в список группового Sweep.
* "`Exclude file mask`" -- регулярное выражения для исключения файла БД из списка группового Sweep.

=== Сервер: Group master replication

image::3.1.15.png[]

image::3.1.16.png[]

image::3.1.17.png[]

image::3.1.18.png[]

image::3.1.19.png[]

== Конфигурация базы данных в FBDataGuard

=== Регистрация базы данных Firebird

Список баз данных, отслеживаемых FBDataGuard, находится в разделе "`Базы данных`".

image::3.1.5.png[]

Чтобы зарегистрировать базу данных в FBDataGuard, необходимо нажать на символ "`Плюс`" в правом углу "`Базы данных`" (появится подсказка "`Добавить БД`") и заполнить следующую форму:

.Добавление базы данных в мониторинг
image::3.1.6.png[]

* "`*Название БД*`"  предназначен для вашего удобства и используется для ссылки на эту базу данных в оповещениях и сообщениях электронной почты.
* "`*Алиас БД*`" -- это псевдоним базы данных из `aliases.conf` или `databases.conf`. Если вы укажете и "`Алиас БД`", и "`Путь к БД`", то будет использоваться "`Алиас БД`".
* "`*Путь к базе данных*`" -- это локальный путь к базе данных (помните, что FBDataGuard должен работать на одном компьютере с Firebird). Если вы помещаете базу данных на внешний диск, может возникнуть ошибка "`File... has unknown partition`". Чтобы это исправить, вам нужно нажать "`Настроить`" в виджете "`Сервер`" и нажать "`Сохранить`", чтобы FBDataGuard перечитал разделы.
* "`*Папка логов и бэкапов*`" -- это папка, в которой FBDataGuard будет хранить резервные копии, журналы и статистику для этой базы данных. Если вы не выбрали папку HQbirdData во время установки и не указали выходную папку для сервера, рекомендуется указать "`Папка логов и бэкапов`" в каком-то явном месте, например `F:\mydatabasedata`.
* "`*Enable advanced monitoring*`" -- см. <<hqbird-advanced-monitor-viewer>>


[NOTE]
====
Вы можете указать точные абсолютные местоположения для резервных копий и статистики позже в соответствующих диалоговых окнах.
====

Список доступных для регистрации баз данных или их псевдонимов вы можете просмотреть, нажав на ссылку **Показать список базы данных**.

.Available database aliases.
image::3.1.7.png[]

После регистрации FBDataGuard заполнит конфигурацию базы данных значениями по умолчанию, а затем отобразит веб-консоль с зарегистрированной базой данных:

.HQbird FBDataGuard веб консоль после регистрации базы данных.
image::3.1.8.png[]

Вы можете изменить настройки базы данных позже; теперь приступим к настройке оповещений.

=== База данных: Общие настройки

FBDataGuard может контролировать несколько баз данных на одном сервере (до 80 баз данных). Для каждой базы данных создается отдельный виджет. Вверху виджета отображается состояние базы данных, никнейм базы данных (задается при добавлении базы данных и может быть изменен). Также виджет базы данных показывает полный путь к базе данных, ее размер, состояние резервных копий и количество подключенных в данный момент пользователей.

image::3.2.21.png[]

Используя диалог конфигурации, вы можете установить имя базы данных, путь к базе данных и папку вывода для базы данных (для хранения журналов и результатов заданий).

image::3.2.22.png[]

FBDataGuard проверяет корректность пути к базе данных и не позволяет указать неправильный путь.

Также для HQbird в виджете базы данных можно увидеть статус репликации и настроить репликацию, нажав на иконку. Подробности читайте в разделе конфигурации репликации.

Виджет базы данных в HQbird также показывает статус шифрования базы данных.

=== База данных: Транзакции

Задание "`База данных: Транзакции`" предназначено для регистрации активности транзакций. Оно отслеживает два важных интервала: разницу между Oldest Active Transaction и Next transaction, а также разрыв между Oldest Snapshot и Oldest Interesting.

Если эти интервалы выходят за рамки указанного порога, то это означает проблемы с управлением транзакциями.

image::3.2.23.png[]

Эти журналы можно проанализировать, чтобы получить полезную информацию о производительности базы данных и качестве приложений (дополнительную информацию см. здесь http://ib-aid.com/en/articles/ibanalyst-what-you-can-see-at-summary-view/[]).

Это задание также отслеживает ограничение реализации в Firebird: максимальное количество транзакций в версиях Firebird до 3.0 должно быть меньше 2^31^-1. При приближении к этому значению необходимо выполнить резервное копирование и восстановление базы данных. Оно выдаст предупреждение, если номер транзакции будет близок к ограничениям. 

Также динамика транзакций отображается на вкладке "`Graphs gallery`":

image::3.2.24.png[]

=== База данных: Lockprint

Задание "`Lockprint`" отслеживает информацию из таблицы блокировок Firebird. Это очень важно для архитектур Classic/SuperClassic и полезно для SuperServer.

Таблица блокировок -- это внутренний механизм Firebird для организации доступа к объектам внутри движка Firebird. HQbird отслеживает важные параметры таблицы блокировок:

image::3.2.25.png[]


* **Период проверки, минуты** -- как часто HQbird анализирует таблицу блокировок. 3 минуты -- оптимальный интервал.
* *Лимит изменения Deadlock Scans* -- сканирование взаимоблокировок -- это процесс, запускаемый движком Firebird в случае длительной задержки ответа от одного из потоков. Если количество взаимоблокировок велико, это означает, что Firebird сильно загружен. Значение накапливается с момента запуска движка Firebird. Значение по умолчанию довольно велико -- 12345, поэтому его превышение означает низкую производительность базы данных.
* *Лимит Deadlocks* -- если движок Firebird обнаруживает истинную взаимоблокировку во время сканирования взаимоблокировок, он увеличивает это значение. Обратите внимание: настоящие взаимоблокировки случаются очень редко. Не путайте их с конфликтами транзакций  ("`deadlock. Lock conflict on nowait transaction`" и другое).
* *Лимит Mutex Wait*. Mutex Wait -- это параметр таблицы блокировок, который неявно указывает на конфликты ресурсов. Чем выше время ожидания мьютекса, тем выше конкуренция внутри движка за ресурсы. По умолчанию порог ожидания мьютекса установлен на 18%, но это значение не является универсальным для всех баз данных. Хороший подход -- следить за значениями мьютексов в течение 1–2 недель, а затем устанавливать самое высокое значение, наблюдаемое за этот период. График ожидания мьютекса доступен в галерее Mutex Wait.
+
image::3.2.26.png[]
* **Проверять значение Hash Slots**. В заголовке таблицы блокировок есть параметр "`Hash lengths (min/avg/max): 0/0/4`", он отображает длины цепочек коллизий в хеш-таблице блокировок. Важно сохранять эти значения как можно меньшими, поэтому HQbird отслеживает их и подсказывает, как улучшить ситуацию, если длина цепочки коллизий в хеш таблице больше, чем указано в этом задании.
* *Лимит активных соединений* "`Owners`" -- количество подключений, установленных к указанной базе данных. Фактически, это самый быстрый способ получить фактическое количество подключений к базе данных с минимальной нагрузкой на базу данных -- другие способы, такие как запрос к `MON$ATTACHMENTS` или `isc_tpb_database`, имеют различные недостатки. Ограничение здесь должно быть установлено в соответствии с фактическим пиковым количеством подключений. Например, если вы уверены, что пиковое количество подключений к вашей базе данных составляет 500, установите в качестве лимита 550, и если в какой-то момент нагрузка увеличится, вы не пропустите этот момент.
+
image::3.2.27.png[]
* **Лимит закрытых соединений**. "`Free owners`" -- это соотношение между пиковым количеством соединений и текущим количеством соединений. Если вы видите `Free owners = 0`,  то это означает, что количество подключений постоянно растет с момента запуска Firebird. Если вы видите большое количество Free owners, то это может означать, что многие соединения недавно были отключены.
* **Размер таблицы блокировок**. Размер таблицы блокировок является неявным индикатором нагрузки на систему. Обычно размер таблицы блокировок должен быть стабильным. Кроме того, рекомендуется установить первоначальный размер таблицы блокировок равным значению, которое она имеет после некоторого периода активной работы -- хотя таблица блокировок увеличивается по требованию, процесс перераспределения является тяжелой операцией и может привести к микрозависаниям в ответах базы данных. График таблицы блокировки полезен для определения правильного начального значения.
+
image::3.2.28.png[]
* **Очередь к таблице блокировок**. Очередь таблиц блокировки не имеет явного порога в задании Lockprint, но ее значения собираются и отображаются в "`Graphs gallery`". Очередь таблицы блокировок является индикатором общей загрузки.

image::3.2.29.png[]


=== База данных: Пересчет статистики индексов

"`База данных: Пересчет статистики индексов`" -- важная задача, которая помогает поддерживать производительность индексов на оптимальном уровне, а также выполняет дополнительную проверку работоспособности базы данных.

"`Пересчет статистики индексов`"  позволяет запустить пересчет значений селективности индексов. Во время этой процедуры Firebird быстро просматривает листовые страницы индексов и обновляет статистику избирательности. Посещая эти страницы, Firebird также проверяет их целостность, и если индекс поврежден, то будет выдано предупреждение.

Кроме того, это задание проверяет, активны ли все индексы в базе данных. Неактивные или неактивированные индексы обычно указывают на повреждения и приводят к снижению производительности.

По умолчанию это задание отключено, но мы рекомендуем включить его после тщательного выбора показателей для пересчета.

В этом задании есть три режима: AUTO, ALL, SELECTED.

ALL -- режим, в котором будут проверены все индексы.

AUTO -- режим по умолчанию. Он очень похож на ALL, но также проверяет размер базы данных и не трогает индексы, если база данных больше 3,6 ГБ.

image::3.2.30.png[]

SELECTED -- рекомендуемый режим. Это позволяет выбрать индексы, которые следует пересчитывать, или те, которых следует избегать.

Для включения индексов в список пересчитываемых необходимо указать названия индексов (через запятую), а для исключения – выполнить то же самое в соответствующем поле.

Как вы можете видеть на снимке экрана диалогового окна конфигурации, здесь есть поля для включения/отключения задания, установки режима обновления, а также включения или исключения индексов. "`Размер БД для переключения, байты`" -- устанавливает предел, при котором работает режим AUTO. Переключатель "`Проверять активность индексов`" должен быть включен всегда, пока вы не проведете специальные манипуляции с неактивными индексами.


[[hqbird-config-verified-backup]]
=== База данных: Бэкап

"`База данных: Бэкап`" -- одно из ключевых заданий, гарантирующих сохранность данных, хранящихся в защищенной базе данных. При разработке HQbird мы учитывали определенный сценарий восстановления, и этот сценарий подразумевает, что ключевой целью защиты базы данных является минимизация потенциальных потерь данных. Если у нас есть работоспособная резервная копия, восстановление может быть сконцентрировано на сохранении самых последних данных (только что введенных в базу данных), и это значительно сокращает время общего простоя.

Как вы увидите ниже, "`База данных: Бэкап`" -- это не просто оболочка для стандартных функций `gbak` и планировщика, это умное задание, в котором есть множество встроенных правил для предотвращения проблем с резервным копированием и предоставления подходящего интерфейса для управление резервными копиями.

[IMPORTANT]
====
Задание "`База данных: Бэкап`" отключено **по умолчанию**, но мы настоятельно рекомендуем изменить его настройки сразу после установки HQbird.
====

image::3.2.31.png[]

Первоначально задание "`База данных: Бэкап`" отображается как ОК, хотя попытка резервного копирования не выполнялась. В этом случае ОК означает, что резервное копирование как минимум запланировано.

Также это задание распознает файлы по шаблону имен (см. ниже информацию о конфигурации) и показывает общее количество резервных копий.

После завершения резервного копирования информация в виджете изменится: будет показано время создания последней успешной резервной копии, а также время, затраченное на фактическое выполнение резервного копирования (всего 1 минута 12 секунд на скриншоте с примером).

image::3.2.32.png[]

Кроме того, подробное оповещение будет отправлено на вашу электронную почту и/или в HQbird Control Center:

image::3.2.33.png[]

"`База данных: Бэкап`"  проверяет свободное место на диске с местом назначения резервной копии, и если обнаруживает, что на диске недостаточно свободного места, будет отправлено CRITICAL предупреждение, а текущая резервная копия будет отменена (при необходимости).

[NOTE]
====
Будьте осторожны: по умолчанию время резервного копирования установлено **23-00 Понедельник-Воскресенье*.

По умолчанию резервные копии базы данных будут храниться в выходной папке, указанной вами на этапе установки! По умолчанию это `C:\HQbirdData\output\...`

Очень важно внимательно просмотреть настройки резервного копирования базы данных и настроить их в соответствии с локальной конфигурацией!
====

Рассмотрим диалог настройки резервного копирования подробнее:

* *"`Включить`"* -- включает или отключает задание резервного копирования.
* В поле *"`Расписание`"* вы можете установить время, когда должно запускаться резервное копирование. Планировщик использует выражение CRON (см. <<hqbird-appx-cron-expr,Выражения CRON>>).
* *"`Создавать бакапы в`"* указывает папку для хранения резервных копий. Эта папка должна находиться на том же компьютере, где находится база данных. По умолчанию она расположен в каталоге базы данных по умолчанию. Обычно рекомендуется указать явный путь к папкам с резервными копиями.
* *"`Количество бэкапов`"* указывает, сколько предыдущих резервных копий должно храниться. FBDataGuard хранит резервные копии в револьверном порядке: когда будет достигнуто максимальное количество (т. е. будет создано 5 резервных копий), FBDataGuard удалит самую старую резервную копию и создаст новую резервную копию. В сочетании с выражениями CRON это дает мощную возможность создавать необходимую историю резервных копий.
* *"`Шаблон имени бэкапа`"* определяет, как будут именоваться файлы резервных копий. Кроме того этот шаблон имени позволяет FBDataGuard распознавать старые резервные копии с тем же шаблоном имени.
* *"`Расширение бэкапа`"* -- по умолчанию `.fbk`.
* *"`Сжимать бэкапы`"* указывает, должен ли FBDataGuard архивировать резервные копии после обычного резервного копирования Firebird. По умолчанию эта опция включена, но вы должны знать, что FBDataGuard будет архивировать файлы резервных копий размером менее *100 ГБ*. После достижения этого размера сжатие резервной копии будет автоматически отключено. Мы рекомендуем включать эту функцию только для небольших баз данных.
* *"`Проверить восстановление`"* -- важная опция. Если она включена, то FBDataGuard выполнит тестовое восстановление новой резервной копии, чтобы проверить её. Это гарантирует качество созданной резервной копии и уведомляет администратора в случае возникновения проблем с тестовым восстановлением.
* *"`Удалять тестовый рестор`"* указывает, должен ли FBDataGuard удалить восстановленную базу данных. По умолчанию она ВЫКЛЮЧЕНА, поэтому вы можете ВКЛЮЧИТЬ её, но вам нужно внимательно подумать: действительно ли вам нужно сохранять копию тестовой восстановленной базы данных. При каждом тестовом восстановлении эта копия будет перезаписана.
* *"`Использовать N CPU ядер для бэкапа`"* -- эта функция позволяет выполнять резервное копирование базы данных и восстановление тестовой базы данных с использованием нескольких ядер ЦП, поэтому резервное копирование может выполняться в 3-5 раз быстрее. Мы рекомендуем выделить половину ядер вашего процессора.
* *"`Отчет об успешных бэкапах`"* -- по умолчанию отключено, но настоятельно рекомендуется включить её и начать получать уведомления о успешном резервном копировании. Эта функция будет использовать настройки электронной почты из системы оповещений.

image::3.2.34.png[]

Если вы нажмете кнопку btn:[Раскрыть&gt;&gt;], то появятся расширенные параметры резервного копирования:

image::3.2.35.png[]

* *"`Backup (gbak) timeout, minutes`"* -- максимальное время для выполнения только операции резервного копирования (`gbak -b`), в противном случае будет сгенерировано предупреждение.
* *"`Restore (gbak) timeout, minutes`"* -- максимальное время для завершения тестовой операции восстановления.
* *"`Хранить бэкапы в`"* -- если вам нужно сделать резервные копии в одну папку, а затем переместить созданную резервную копию в другую папку (например, для долговременного хранения), вы можете изменить значение этого параметра с `${backup-directory}` на папку где вы их будете хранить. Файлы резервных копий в обоих местах отслеживаются HQbird FBDataGuard и включаются в счетчик резервных копий, отображаемый в виджете.
* Переключатель *"`Копировать бэкапы`"* и путь. . Если у вас есть сетевое расположение или подключенный USB-накопитель для хранения базы данных, на котором вы хотите хранить копию резервной копии (помимо обычных резервных копий), FBDataGuard может скопировать туда последнюю резервную копию: просто включите переключатель: просто включите переключатель "`Копировать бэкапы`" и задайте путь. Скопированные файлы не отслеживаются и не включаются в число резервных файлов, отображаемых в виджете.
* Переключатель *"`Выполнить скрипт`"* и путь к скрипту. После завершения общей процедуры резервного копирования можно указать собственный сценарий или исполняемый файл. Скрипт получает в качестве параметра путь к новой резервной копии базы данных.
* *"`Optional path to gbak executable`"* -- можно указать другой не стандартный `gbak`.
* *"`Backups option for gbak`"* -- если вам нужно добавить какие-то конкретные опции резервного копирования, добавьте их сюда.
* *"`Restore options for gbak`"* -- если вам нужно добавить какие-то конкретные опции тестового восстановления, добавьте их сюда.


[TIP]
====
Если вы отслеживаете более одной базы данных, настоятельно рекомендуется разделить время выполнения восстановления.
====

==== Важное замечание: резервное копирование на сетевое хранилище

Обратите внимание, что для создания и копирования резервной копии в сетевые хранилища службы Firebird и FBDataGuard должны быть запущены под учетной записью с достаточными правами. По умолчанию Firebird и FBDataGuard запускаются под учетной записью LocalSystem, у которой нет прав доступа к сетевому расположению.

image::3.2.36.png[]

Итак, чтобы хранить резервные копии Firebird в сетевом расположении в Windows, запустите апплет "`Службы`"  (`services.msc`) и на вкладке "`Вход в систему`"  измените "`С учётной записью`" на соответствующую учетную запись (подойдет Администратор домена).

В Linux -- добавьте необходимые права для пользователя `firebird`.

[[hqbird-config-incremental-backup]]
=== База данных: Инкрементальный бэкап

Инкрементальный бэкап -- это задание по планированию и управлению инкрементным резервным копированием в Firebird.

Обратите внимание, что мы рекомендуем использовать инкрементное резервное копирование только в сочетании с проверяемым резервным копированием, поскольку при инкрементальном резервном копировании происходит копирование страниц базы данных, измененных с момента последнего резервного копирования (в случае многоуровневого инкрементного резервного копирования).

HQbird FBDataGuard реализует 2 типа многоуровневого инкрементного резервного копирования: Простое и Расширенное инкрементное копирование, а также полное инкрементное копирование (см. <<hqbird-config-db-dump-backup>>).

Многоуровневое резервное копирование в Firebird должно выполнять следующие шаги:

. Создаётся начальная резервная копия (уровень 0), которая по сути является копией базы данных на момент запуска резервного копирования, и помечает её с помощью GUID резервной копии.
. Поскольку Firebird при каждом изменении помечает каждую страницу данных определенным идентификатором, то можно найти страницы данных, изменившиеся с момента предыдущего резервного копирования, и скопировать только их, чтобы сформировать резервную копию уровня 1.
. Возможно создание нескольких уровней резервных копий -- например, начальная резервная копия (полная копия, уровень 0) создается каждую неделю, каждый день мы создаем копию уровня 1 (отличия от уровня 0), и каждый час мы создаем резервные копии уровня 2 (отличия от ежедневного уровня 1).

Инкрементальное резервное копирование с простым расписанием позволяет планировать 3 уровня резервного копирования: еженедельно, ежедневно и ежечасно.

Вы можете увидеть сводную информацию для такой конфигурации инкрементного резервного копирования на следующем снимке экрана ее виджета:

image::3.2.37.png[]

Чтобы настроить простое инкрементное резервное копирование, нажмите "`шестеренку`" настроек виджета и выберите "`Простая схема бэкапа`" (выбрано по умолчанию). Появится следующий диалог:

image::3.2.38.png[]

В этом диалоговом окне есть 4 основные области, давайте рассмотрим их одну за другой.

Верхняя область отведена под общие настройки инкрементального резервного копирования – они одинаковы для простого и продвинутой схемой бэкапа:

image::3.2.39.png[]

*Макс. длительность (сек)* -- ограничение максимальной продолжительности процесса резервного копирования, по умолчанию составляет 1 день (86400 секунд).

*Минимальное свободное место (байты)* -- минимальный размер свободного места на диске для предотвращения запуска резервного копирования, по умолчанию ~9Мб

**Папка бэкапа** -- где будет храниться инкрементальная резервная копия выбранной базы данных. Необходимо хранить инкрементные резервные копии каждой базы данных отдельно от резервных копий других баз данных: т. е. в отдельной папке для каждой базы данных.

Необходимо указать папку резервных копий с достаточным количеством свободного места на диске для хранения резервных копий всех уровней!

**Имя журнала** -- имя файла, который содержит информацию о файлах инкрементных резервных копий только для внутреннего использования.

*Путь к nbackup.exe* -- можно указать другой инструмент nbackup, кроме стандартного `nbackup` (не рекомендуется).

*Шаблон имени бэкапа* -- шаблон для файлов инкрементного резервного копирования (менять его не нужно).

*Опции* -- дополнительные параметры для инструмента командной строки nbackup (менять их не нужно).

*Не проверять существование бэкапов* -- этот параметр следует выбрать, если вы планируете удалить или создать дополнительные инкрементальные резервные копии в другом месте.

*Не проверять цепочку GUID* -- эту опцию следует выбрать, если вы хотите пропустить проверку существования предыдущих уровней инкрементных резервных копий.

*Сразу же создавать пропущенные уровни инкрементального бэкапа* -- по умолчанию эта опция включена. Это означает, что если вы запланировали начальный момент запуска резервного копирования уровня 1 раньше, чем начальный момент запуска резервного копирования уровня 0, DataGuard автоматически это исправит и создаст резервную копию уровня 0 непосредственно перед уровнем 1. Следующие резервные копии уровня 0 будут выполнены по обычному графику.

*Высылать уведомления для уровней 0,1,2* -- включите эту опцию, чтобы получать уведомления об инкрементальных резервных копиях (__настоятельно рекомендуется__!)

После настройки основного набора параметров необходимо настроить само расписание. Как вы можете видеть на скриншоте ниже, вам необходимо указать день недели и время для резервного копирования уровня 0 (еженедельного), дни недели и время для запуска резервного копирования уровня 1 (ежедневного), а также часы и минуты для резервной копии уровня 3 (ежечасного).

Для каждого уровня резервного копирования вы можете указать, сколько файлов хранить в истории.

image::3.2.40.png[]

По умолчанию настроено сохранение 5 резервных копий еженедельно, 7 ежедневных и 24-часовых резервных копий.

Однако иногда требуется более гибкое расписание, для этого в виджете "`Инкрементальный бэкап`" имеется "`Продвинутая схема бэкапа`":

image::3.2.41.png[]

Как видите, верхняя часть экрана конфигурации такая же, как и в простом расписании, а разница заключается в способе планирования уровней резервного копирования.

Продвинутая схема бэкапа позволяет настроить до 5 уровней резервного копирования и гибко планировать их <<hqbird-appx-cron-expr>>.

Например, вы можете настроить её на создание полной резервной копии (уровень 0) каждые 3 месяца, копии уровня 1 каждый месяц, уровня 2 -- каждую неделю, уровня 3 -- каждый день и уровня 4 -- каждый час.

[TIP]
====
Если вы отслеживаете более одной базы данных, настоятельно рекомендуется разделить время выполнения резервных копий.
====

[[hqbird-config-db-dump-backup]]
=== База данных: Полный Инкрементальный Бэкап

Это задание также использует функцию nbackup в Firebird, но, в отличие от многоуровневого резервного копирования, оно всегда выполняет полную копию (уровень 0) базы данных. Такая работа полезна для быстрого создания копии рабочей базы данных.

Конфигурация "`База данных: Полный Инкрементальный Бэкап`" тривиальна:

image::3.2.42.png[]

Вам просто нужно настроить, когда и куда DataGuard должен копировать полную копию (инкрементная резервная копия уровня 0) и сколько копий он должен хранить.

=== База данных: Рестор БД

Одной из частых задач администраторов баз данных является восстановление базы данных из резервной копии. Причин для восстановления может быть много, наиболее распространенными являются регулярная проверка сохраненных резервных копий и необходимость иметь свежую восстановленную копию для быстрого отката. HQbird FBDataGuard может автоматизировать восстановление резервных копий (которые были созданы с помощью gbak или "`База данных: Бэкап`") с помощью задания *База данных: Рестор БД*. Рассмотрим варианты и параметры данного задания.

image::3.2.43.png[]

По умолчанию восстановление отключено. Поскольку восстановление может оказаться длительным и ресурсоемким, тщательно планируйте время восстановления.

Базу данных можно восстановить из резервных копий разных типов. Чтобы указать, какие типы резервных копий будут использоваться при восстановлении, используйте переключатель *Рестор из*.

Ниже вы можете увидеть диалог настройки *База данных: Рестор БД* в режиме *nbackup*:

image::3.2.44-0.png[]

В режиме *gbak* диалог настройки *База данных: Рестор БД* выглядит так:

image::3.2.44.png[]

* Поле "`*Расписание*`" содержит <<hqbird-appx-cron-expr,выражение CRON>>, которое определяет когда будет запускаться восстановление.
* "`*Взять бэкап из папки*`" -- указывает расположение файлов резервных копий, которые необходимо восстановить. Если вы восстанавливаете резервные копии на том же компьютере, где они были созданы, укажите ту же папку, что и в задании "`База данных: Бэкап`". Если вы восстанавливаете резервные копии с другого компьютера, укажите папку, в которой находятся эти резервные копии.
* "`*Брать бэкап не старше указанного числа часов*`" -- этот параметр определяет максимальный возраст резервной копии, подлежащей восстановлению. Если последний файл резервной копии будет старше указанного количества часов, то задание "`Рестор БД`" отправит предупреждение о том, что резервная копия слишком старая. Это полезно для автоматической проверки резервных копий, созданных на удаленном компьютере.
* "`*Рестор из*`" указывает, какие типы резервных копий будут использоваться для восстановления базы данных.
* "`*Datatime pattern for nbackup*`" содержит шаблон для имен резервных копий, созданных с помощью nbackup.
Оно должно быть таким же, как *Шаблон имени бэкапа* см. <<hqbird-config-incremental-backup>>.
* "`*Шаблон имени gbak бэкапа*`" содержит шаблон для имен резервных копий. Оно должно быть таким же, как *Шаблон имени бэкапа* см. <<hqbird-config-verified-backup>>.
* "`*Расширение файла gbak бэкапа*`" -- по умолчанию `.fbk`.
* "`*Использовать N CPU ядер для рестора*`" -- доступно только в режиме gbak.
* "`*Опции восстановления*`" -- доступно только в режиме gbak.
* "`*Ресторить бэкап в папку*`" -- папка, в которую FBDataGuard будет восстанавливать резервные копии.
* "`*Имя файла для ресторенной БД*`" -- шаблон восстанавливаемого файла базы данных. По умолчанию он содержит следующие части
+
** `${db.id}_{0,date, yyyyMMdd_HH-mm}_testrestore.fdb`
** `db.id` -- внутренний идентификатор базы данных (GUID)
** `0,date, yyyyMMdd_HH-mm` -- дата и время
** `testrestore.fdb` -- описание (Вы можете указать там любое имя файла, которое вам нужно).
* "`*Если найдена существующая БД*`" -- если FBDataGuard обнаружит в папке назначения файл с тем же именем, что и восстанавливаемая база данных, то по умолчанию он переименует существующий файл. Если вы хотите заменить старый восстановленный файл на новый, то выберите "`Заменить существующий файл`".
* "`*И добавить суффикс*`" -- если вы выбрали "`Переименовать существующий файл БД`", то этот суффикс будет использоваться для его переименования.
* "`*Выполнить командный файл после рестора*`" -- в этом поле вы можете указать необязательный путь к командному файлу или другой утилите, которая будет запускаться после восстановления. Будет передано 2 параметра: первый -- путь к только что восстановленной резервной копии, второй -- путь к восстановленному файлу.
* "`*Таймаут для рестора, минуты*`" -- здесь вы можете установить ограничение по времени для операции восстановления. Если этот лимит будет превышен, то будет отправлено предупреждение о том, что восстановление занимает слишком много времени.
* "`*Проверять свободное место перед рестором. Минимальный размер (байты)*`" -- здесь вы можете установить ограничение на минимального доступное свободное места в папке назначения восстановления -- если свободного места меньше, чем указано, то восстановление не начнется, и будет отправлено соответствующее предупреждение.
* "`*Информировать об успешности*`" -- отправить электронное письмо об успешном восстановлении (по умолчанию отключено, будут отправляться только оповещения о проблемах).


[[hqbird-config-cloud-backup]]
=== База данных: Передача сегментов репликации

Целью задания "`Передача сегментов репликации`" является отправка сегментов репликации, созданных в результате асинхронной репликации, с главного сервера на сервер реплики. В случае распределенной среды асинхронной репликации, когда сетевое соединение между главным сервером и сервером-репликой нестабильно, с большой задержкой или когда серверы находятся в разных географических регионах, лучшим способом передачи сегментов репликации будет FTP или FTP через SSH.

Ниже мы рассмотрим, как настроить Cloud Backup для этой задачи.

Во-первых, мастер асинхронной репликации должен быть настроен на сохранение сегментов репликации в какой-нибудь локальной папке -- по умолчанию это будет `${db.path}.LogArch` -- как показано в примере ниже:

image::3.2.45.png[]


.Конфигурация передачи сегментов репликации
image::3.2.46.png[]

Затем мы можем настроить задание *Передача сегментов репликации*, чтобы отслеживать в этой папке новые сегменты репликации и загружать их на удаленный FTP-сервер.

Как вы можете видеть на скриншоте выше, задание *Передача сегментов репликации* проверяет папку, указанную в "`*Проверять папку*`" с интервалом, указанным в "`*Период проверки, секунды*`".

Обратите внимание: *Передача сегментов репликации* отправляет файлы в порядке их имен, а не дат.

Чтобы проверить, что переданные файлы являются действительными сегментами репликации, а также для поддержки автоматической повторной инициализации баз данных реплик, необходимо включить флажок "`*Разрешить/Запретить выполнение задачи*`".

По умолчанию задание сжимает и шифрует сегменты репликации перед их отправкой. Пароль по умолчанию -- "`*zipmasterkey*`" (без кавычек), который можно указать в поле рядом с переключателем "`*Упаковать сегменты*`". FBDataGuard создает сжатую и зашифрованную копию сегмента репликации и загружает ее на указанный целевой сервер.

Чтобы отключить упаковку и шифрование, снимите флажок "`*Упаковать сегменты*`".

Последняя часть параметров в диалоговом окне Cloud Backup позволяет контролировать поведение облачного резервного копирования.

Флажок *Send Ok report* -- включает отправку электронного письма на указанный в оповещениях адрес каждый раз при загрузке сегмента репликации. По умолчанию он выключен.

В результате FBDataGuard загрузит зашифрованные и сжатые сегменты репликации на удаленный сервер. Чтобы распаковать и расшифровать их в обычные сегменты репликации, на сервере реплики должен быть установлен еще один экземпляр HQbird FBDataGuard и настроено задание Cloud Backup Receiver -- подробнее см. в разделе <<hqbird-config-cloud-backup-receiver>>.

Далее рассмотрим настройки каждого из протоколов передачи файлов.

==== FTP/FTPS/FTPS через SSH

Существует несколько типов целевых серверов: FTP, FTP через SSL/TLS, FTP через SSH. При выборе необходимого типа в диалоговом окне отображаются обязательные для заполнения поля.

Вы можете выбрать до 5 одновременных удаленных серверов для загрузки резервных копий. Ниже вы можете увидеть диалог настройки FTP.

image::3.2.47.png[]

[NOTE]
====
Если у вас не установлен FTP на целевом сервере с Windows, установите Filezilla -- это очень популярный быстрый и легкий FTP-сервер для Windows.
====

[NOTE]
====
Сегменты репликации будут загружены в подкаталог, указанный в поле "`Загрузить в папку`". По умолчанию это `/dababase0/${db.id}`, где `db.id` -- это идентификатор базы данных внутри DataGuard. Реплика об этом `db.id` ничего не знает, поэтому нужно прописать её вручную в "`Распаковывать файлы в папку`" (см. <<hqbird-config-cloud-backup-receiver>>).
====

===== FTP через SSL/TLS

image::3.2.48.png[]

Для отправки файлов на FTPS необходимо создать jks-хранилище с файлом закрытого ключа, указать путь к нему в поле "`Key store file`" и пароль к нему в поле "`Key store password`".

Подробности и пример создания файла jks и пароля см. здесь: http://xacmlinfo.org/2014/06/13/how-to-keystore-creating-jks-file-from-existing-private-key-and-certificate/[]

===== FTP через SSH

image::3.2.49.png[]

Чтобы использовать FTP через SSH с аутентификацией по закрытому ключу, укажите полный путь к нему в "`Key store file`", остальные параметры аналогичны обычному FTP.

===== Socket

image::3.2.49-0.png[]

[[hqbird-config-transfer-files]]
=== База данных: Отправка файлов

Целью задания "`Отправка файлов`" является отправка файлов резервных копий с главного сервера на сервер-реплику. В случае распределенной среды, когда сетевое соединение между главным сервером и сервером-репликой нестабильно или имеет высокую задержку, или когда серверы находятся в разных географических регионах, лучшим способом передачи файлов будет через FTP или FTP через SSH.

Ниже мы рассмотрим, как настроить "`Отправка файлов`" для этой задачи.

Во-первых, сервер базы данных должен быть настроен на сохранение файлов резервных копий в какой-либо локальной папке -- по умолчанию это будет `${db.default-directory}/backup` -- как показано в примере ниже:

.Конфигурация отправки файлов
image::3.2.49-1.png[]

Затем мы можем настроить задание *Отправка файлов*, чтобы отслеживать в этой папке новые файлы резервных копий и загружать их на удаленный FTP-сервер.

Как видно на скриншоте выше, задание *Передача файлов* проверяет папку, указанную в "`Проверять папку`", согласно расписанию, указанным в "`Cron-выражение для активации задачи`". Обратите внимание: *Передача файлов* отправляет файлы в порядке их имен, а не дат.

По умолчанию задание *Отправка файлов* сжимает и шифрует файлы резервных копий перед их отправкой. Пароль по умолчанию — "`*zipmasterkey*`" (без кавычек), который можно указать в поле "`*Зашифровывать при упаковке*`". FBDataGuard создает сжатую и зашифрованную копию резервной копии и загружает ее на указанный целевой сервер.

Чтобы отключить шифрование, снимите флажок "`*Зашифровывать при упаковке*`".

В результате FBDataGuard загрузит зашифрованные и сжатые файлы на удаленный сервер. Чтобы распаковать и расшифровать их в обычные файлы, на сервере реплики должен быть установлен еще один экземпляр HQbird FBDataGuard и настроено задание File Receiver -- подробнее см. в разделе <<hqbird-config-cloud-backup-receiver>>.

Далее рассмотрим настройки каждого из протоколов передачи файлов.

==== FTP/FTPS/FTPS через SSH

Существует несколько типов целевых серверов: FTP, FTP через SSL/TLS, FTP через SSH. При выборе необходимого типа в диалоговом окне отображаются обязательные для заполнения поля.

Вы можете выбрать до 5 одновременных удаленных серверов для загрузки резервных копий. Ниже вы можете увидеть диалог настройки FTP.

image::3.2.49-2.png[]

[NOTE]
====
Если у вас не установлен FTP на целевом сервере с Windows, установите Filezilla -- это очень популярный быстрый и легкий FTP-сервер для Windows.
====

[NOTE]
====
Сегменты репликации будут загружены в подкаталог, указанный в поле "`Загрузить в папку`". По умолчанию это `${db.id}/`, где `db.id` -- это идентификатор базы данных внутри DataGuard. Реплика об этом `db.id` ничего не знает, поэтому нужно прописать её вручную в "`Распаковывать файлы в папку`" (см. <<hqbird-config-cloud-backup-receiver>>).
====

===== FTP через SSL/TLS

image::3.2.49-3.png[]

Для отправки файлов на FTPS необходимо создать jks-хранилище с файлом закрытого ключа, указать путь к нему в поле "`Key store file`" и пароль к нему в поле "`Key store password`".

Подробности и пример создания файла jks и пароля см. здесь: http://xacmlinfo.org/2014/06/13/how-to-keystore-creating-jks-file-from-existing-private-key-and-certificate/[]

===== FTP over SSH

image::3.2.49-4.png[]

Чтобы использовать FTP через SSH с аутентификацией по закрытому ключу, укажите полный путь к нему в "`Key store file`", остальные параметры аналогичны обычному FTP.

==== Отправка проверенных и инкрементальных резервных копий через Cloud Backups

Cloud Backup также можно использовать для отправки любых файлов на FTP/FTPS и т. д. Например, вы можете настроить Cloud Backup для поиска файлов FBK, создаваемых проверенным заданием резервного копирования, и запланировать загрузку на удаленный FTP-сервер.

Необходимо помнить, что количество хранимых резервных копий должно быть меньше количества файлов, сохраняемых Cloud Backup (указанного в параметре "`How many files to keep`"). По умолчанию Cloud Backup сохраняет 10 последних отправленных файлов, и "`Проверенная резервная копия`" содержит 5 самых последних файлов резервных копий, поэтому все работает нормально, но если вы уменьшите количество сохраняемых файлов в Cloud Backup, дополнительные файлы будут удалены в соответствии с "`Filename template`".

То же самое можно сделать и для инкрементных резервных копий.

[[hqbird-config-pump-files]]
=== База данных: Выгрузка Файлов

Целью задачи "`Выгрузка Файлов`" является перенос файлов из одной директории, доступной DataGuard, в какое-то другое место, обычно удаленное, с возможностью использования различных методов, которые можно подключить к DataGuard в виде плагинов и выбирается в конфигурации задачи с возможностью установки уникальных для каждого плагина параметров. HQbird включает в себя два плагина для передачи файлов: fpt и sftp. Есть и другие плагины для передачи файлов. Плагины передачи представляют собой файлы `jar` и расположены в папке `Firebird DataGuard/plugins`.

Рассмотрим варианты и параметры данной задачи.

.Опции, доступные для плагина передачи файлов по FTP.
image::3.2.62.png[]

* *Шаблон файлов* -- белый список, по которому выбираются файлы для копирования. Представляют маски имен файлов. Должно быть разделено запятой.
* *Исключить файлы* -- черный список представляет собой маску имен файлов, которые следует исключить из передачи. Черный список имеет приоритет над белым списком.
* *Метод отсылки* -- метод передачи файлов (плагин).

.Опции, доступные для плагина передачи файлов по SFTP.
image::3.2.63.png[]

Алгоритм выполнения этой задачи следующий:

. На каждой итерации задачи формируется список файлов для каталога для отправки файлов мониторинга. Для выбора списка файлов используются маски: "`Шаблон файлов`" и "`Исключить файлы`".
. Для каждого выбранного файла (из списка с шага 1, в порядке возрастания даты последней модификации файла) выполняются следующие действия:
.. Если установлена опция сжатия, файл архивируется (если размер файла не нулевой). Имя сжатого файла формируется путем добавления жестко запрограммированного расширения: `.zipfilepump`. Файл будет архивирован в ту же директорию. Если файл окажется нулевого размера, алгоритм посчитает, что файл еще не завершен и прервет отправку остальных файлов с соответствующим сообщением.
.. Задача отправки файла настраивается на один из нескольких возможных вариантов отправки с помощью дополнительных плагинов (см. ниже). В зависимости от того, включена опция сжатия или нет, исходный или сжатый файл отправляется по заданному алгоритму (в текущей версии это ftp или sftp).
.. После отправки, если был выбран вариант сжатия, архивный файл удаляется.
.. TИсходный файл переименовывается путем добавления расширения `.fuploaded`.
. Алгоритм переходит к отправке следующего файла из списка. Общее количество отправленных за итерацию файлов и их исходный (распакованный) размер суммируются для отображения в виджете.
. По завершении отправки всех файлов из сформированного списка происходит поочередная очистка каталога, из которой файлы удаляются по маске `*.fuploaded`. То есть создается список всех таких файлов, он сортируется по времени последней модификации, а все старые файлы удаляются, кроме последних "`Хранить NN файлы`".
+
По завершении отправки, если установлен флажок "`Отправлять Ok уведомление`", то пользователю будет отправлен отчет о количестве и размере файлов, отправленных на текущей итерации.


[[hqbird-config-cloud-backup-receiver]]
=== База данных: Приемник файлов

В основном "`Приемник файлов`" предназначен для распаковки файлов из zip-архивов и чаще всего используется в паре с "`Передача сегментов репликации`" для передачи заархивированных сегментов репликации.

"`Приемник файлов`" проверяет файлы в папке, указанной в "`*Проверять папку*`", с интервалом, равным "`*Период проверки, секунды*`". Он проверяет только файлы с указанной маской в соответствии с "`*Шаблон имён файлов*`" (`*.journal**` по умолчанию) и указанным расширением (`.replpacked` по умолчанию). Если он встречает такие файлы, то он распаковывает и расшифровывает их с помощью пароля, указанный в "`*Пароль для расшифровки*`", и копирует в папку, указанную в "`*Распаковывать файлы в папку*`".

Если параметр "`*Наблюдать за реинициализацией*`" включен, то "`Приемник файлов`" также будет отслеживать файлы предназначенные для реинициализации реплики, такие файлы имеют префикс указанный в "`Префикс для имён входящих файлов реинициализации`".

image::3.2.50.png[]

Имеются следующие дополнительные параметры:

* *Предупреждать если файлов больше* -- по умолчанию 30. Если существует длинная очередь сегментов репликации, которые необходимо распаковать, то возможно это проблема с репликой базы данных, поэтому HQbird отправляет предупреждение для привлечения внимания администратора.
* *Предупредить если новый файл старше чем (минут)* -- если самый последний файл (обычно сегмент репликации) слишком старый (более 360 минут), процесс репликации может быть прерван, и HQbird отправит соответствующее предупреждение.
* *Send Ok report* -- о умолчанию отключено. Если он включен, HQbird отправляет электронное письмо о каждой успешной распаковке сегмента. Это может быть слишком часто для сегментов репликации, поскольку они поступают каждые 30–180 секунд, и это нормально для обычных файлов, таких как проверенные или инкрементные резервные копии.

После настройки "`Приемник файлов`" настройте реплику на поиск сегментов репликации: задайте в "`Папка архивных логов`" тот же путь, что и в "`Приемник файлов`" -> "`Распаковывать файлы в папку`".

image::3.2.51.png[]

==== Встроенный FTP-сервер

HQbird имеет встроенный FTP-сервер, который по умолчанию отключен. Для получения сегментов репликации удобно использовать встроенный FTP-сервер.

Чтобы включить встроенный FTP-сервер, необходимо отредактировать файл конфигурации `ftpsrv.properties`, который находится в папке `C:\HQbirdData\config` или `/opt/hqbird/ftpsrv.properties`

По умолчанию он содержит следующее:

[listing]
----
#path in ftpsrv.homedir must be escaped "ftpsrv.homedir=c:\\ftp\\pub"

# or backslashed for ex: "ftpsrv.homedir=c:/ftp/pub"

ftpsrv.enable = false

ftpsrv.port = 8721

ftpsrv.defuser=admin2

ftpsrv.defpsw=strong password2

ftpsrv.homedir=
----

Необходимо изменить `ftpsrv.enabled` на `true` и указать домашний каталог для FTP в параметре `ftpsrv.homedir`. Кроме того, рекомендуется использовать имя пользователя и пароль, отличные от заданных по умолчанию.

После этого перезапустите службу FBDataGuard и проверьте доступность FTP.

.Внимание -- пользователи Linux!
[IMPORTANT]
====
В Linux служба FBDataGuard работает под пользователем *firebird*, поэтому домашний каталог FTP также должен иметь разрешения для пользователя *firebird*.
====

[[hqbird-config-low-level-metabackup]]
=== База данных: Сбор метаданных

"`База данных: Сбор метаданных`" -- одна из ключевых задач DataGuard, обеспечивающая защиту базы данных на низком уровне.

Прежде всего, это задание сохраняет "`сырые`" метаданные в специальном репозитории, поэтому в случае серьезного повреждения (например, из-за аппаратного сбоя) базы данных можно использовать этот репозиторий для восстановления базы данных.

Вторая цель этого задания -- постоянная проверка всех важных системных таблиц на целостность. Каждые 20 минут оно просматривает все важные системные таблицы в базе данных и гарантирует отсутствие ошибок на уровне метаданных.

Третья цель -- предупредить администратора о слишком большом количестве форматов для каждой таблицы.

В Firebird существует ограничение на количество форматов (256 на таблицу), однако даже несколько форматов могут значительно увеличить вероятность серьезного повреждения и замедлить производительность. Рекомендуется не изменять структуру таблиц в производственной базе данных и сохранять только один формат для каждой таблицы. Если это невозможно, администратору следует чаще выполнять резервное копирование/восстановление, чтобы преобразовать все форматы в один.

image::3.2.52.png[]


=== База данных: Валидация БД

Проверка базы данных Firebird требует монопольного доступа: т.е. во время проверки ни один пользователь не должен подключаться. Задание "`База данных: Валидация БД`" отключает (shutdown) базу данных и выполняет проверку базы данных, а затем включает (online) ее.

По умолчанию это задание ВЫКЛЮЧЕНО. Пожалуйста, внимательно подумайте, можно ли предоставить эксклюзивный доступ к базе данных. Проверка также может занять значительное время.

image::3.2.53.png[]

Используя диалоговое окно конфигурации, вы можете включить/отключить это задание, установить время выполнения, установить тайм-аут выключения (время ожидания перед запуском проверки), а также режим выключения (FORCE, ATTACH, TRANSNATIONAL). Если у вас нет глубоких знаний о том, что вы делаете, лучше оставить параметры по умолчанию.


Задание "`База данных: Валидация БД`" отправит предупреждение с критическим статусом, если возникнут какие-либо ошибки.

Кроме того, Firebird будет записывать ошибки в `firebird.log`, и они будут появляться в оповещениях, генерируемых заданием <<hqbird-config-serverlog>>.

[[hqbird-config-sweep]]
=== База данных: Sweep

FBDataGuard включает в себя специальное задание для явного запуска sweep в случае, если автоматический sweep отключен. По умолчанию задание отключено.

image::3.2.54.png[]

Рекомендуется запланировать явную запуск sweep с отключением длительных транзакций для всех баз данных, где такие транзакции обнаружены. Рекомендуемый период -- один раз в день (обычно ночью, после завершения резервного копирования).

По умолчанию время запуска sweep установлено на 00-15, что может быть неподходящим временем, поскольку по умолчанию в это же время начинается резервное копирование, поэтому лучше измените его.

image::3.2.55.png[]

Обратите внимание: по умолчанию галочка "`*Отключать соединения с длительными активными транзакциями перед sweep*`" включена. Это означает, что HQbird обнаружит и отключит длительные транзакции (более 30 минут) перед запуском sweep, чтобы сделать sweep эффективным. Если долго выполняющиеся активные транзакции не будут отключены, sweep не сможет очистить старые версии записей.

"`*Не отключать процессы (regexp)*`" -- в этом параметре укажите выражение `SIMILAR TO` для имен процессов, которые не будут отключаться. По умолчанию исключаются процессы `gfix`, `gbak`, `gstat` и `fbsvcmgr`.

"`*Отключить процессы старше указанного времени (в минутах)*`" -- HQbird отключит процессы с длительно выполняемыми активными записываемыми транзакциями, пороговое значение по умолчанию составляет 300 минут. Практический верхний предел для этого параметра составляет 1440 минут (маловероятно, что транзакция будет делать что-то полезное более 1 дня).

"`*Использовать N CPU ядер для sweep*`" -- HQbird Enterprise может использовать несколько ядер для выполнения sweep, чтобы ускорить sweep в 4-6 раз. Мы рекомендуем указывать не более половины ядер ЦП, если на сервере одна база данных, или 1/4 ядер ЦП, если баз данных несколько. Например, если у вас 16 ядер и 1 большая база данных, установите этот параметр равным 8, если несколько больших баз данных, то установите это значение равным 4.

=== База данных: Свободное место

Это задание отслеживает все объекты, связанные с базой данных: файлы базы данных (включая тома многотомной базы данных), дельта-файлы, файлы резервных копий и так далее.

Задание "`База данных: Свободное место`" анализирует рост базы данных и оценивает, будет ли достаточно свободного места для следующей операции, такой как резервное копирование (включая тестовое восстановление), на конкретном жестком диске.

Оно генерирует несколько типов оповещений. Проблемы с дисковым пространством находятся в топе причин повреждения БД, поэтому обращайте внимание на оповещения по этому заданию.

Это задание также предоставляет данные для графика анализа свободного пространства сервера.

По умолчанию это задание включено.

Используя диалог конфигурации, вы можете указать период проверки и пороговые значения свободного места. Предупреждение будет выдано о первом достигнутом пороговом значении. Чтобы установить порог в % дискового пространства, вам необходимо установить явное пространство в байтах равным 0.

image::3.2.57.png[]

Если вы используете инкрементальное резервное копирование (или полное страничное резервное копирование), это задание критически важно. Он следит за временем жизни и размером дельта-файлов и предупреждает, если что-то пойдет не так. Забытые дельта-файлы часто являются причиной повреждений и значительных потерь данных.

Это задание находит все дельта-файлы, связанные с базой данных, и проверяет их возраст и размер. Если один из этих параметров превышает пороговые значения "`Максимальный размер дельты, байты`" или "`Максимальный возраст дельты, минуты`", администратор получит предупреждение, и статус базы данных будет установлен на CRITICAL.

[NOTE]
====
Если дельта-файл защищаемой базы данных был поврежден, то извлечь данные из него можно, используя метаданные из исходного файла базы данных или репозитория из задания <<hqbird-config-low-level-metabackup>>.
====

=== База данных: Сбор статистики

Это задание очень полезно для выявления проблем с производительностью и выполнения общей проверки базы данных на низком уровне без резервного копирования.

image::3.2.58.png[]

Мы рекомендуем запускать это задание каждый день и сохранять историю статистических отчетов.

Тогда с помощью HQbird Database IBAnalyst можно обнаружить проблемы с производительностью базы данных и получить полезные рекомендации по их устранению.

[NOTE]
====
В качестве полезного побочного эффекта `gstat` посещает все страницы базы данных в поисках таблиц и индексов и проверяет их правильность.
====

=== База данных: Replica Check

Эта задача позволяет проверить доступность базы данных-реплики. По истечении заданного периода он меняет значение указанного генератора и сравнивает значение генератора на стороне реплики и главной базы данных.

image::3.2.58-1.png[]

*Min diff to alert* -- разница между значениями генератора на стороне мастера и реплики, при превышении которого будут отсылаться оповещения.

=== База данных: Backup,Restore,Replace

Многие адмнистраторы для решения проблем производительности используют следующий паттерн -- бекап-рестор-замена. Обычно такая необходимость возникает, если приложение плохо управляет транзакциями, что приводит к накоплению мусора. При правильном проектировани приложения нет никакой необходимости постоянно выполнять резервное копирование и восстановление с заменой. Тем не менее HQBird предоставляет возможность автоматизировать этот процесс и запускать его как в ручном режиме (через Web-консоль), так и в автоматическом (по расписанию).

Паттерн бекап-рестор-замена состоит из следующих шагов:

. выполнение команды копирования `gbak -b -g ... database.fdb backup.fbk`
. выполнение команды восстановления в новый файл БД `gbak.exe -c ... backup.fbk  database_new.fdb`
. переименование `database_new.fdb` в исходное имя базы данных

Однако в этом казалось бы простом процессе существует множество ловушек:

. Недостаточно места на диске. Существует риск исчерпания дискового пространства во время операций резервного копирования или восстановления.
. Неожиданные прерывания. Перезагрузка сервера, часто вызванная обновлениями Windows, может в любой момент нарушить выполнение задач резервного копирования или восстановления.
. Повреждение исходной базы данных. Если исходная база данных повреждена, резервная копия может оказаться неполной.
. Повреждение после восстановления. Различные проблемы, такие как нехватка места для сортировки больших индексов, могут привести к повреждению восстановленной базы данных.
. Проблемы с производительностью. Процедуры резервного копирования и восстановления могут сильно замедляться из-за небрежного обслуживания, сбоев оборудования или параллельных задач, таких как полное резервное копирование виртуальных машин.
. Контроль доступа. Крайне важно блокировать операции записи пользователя в исходную базу данных после начала процесса резервного копирования и восстановления, чтобы гарантировать, что изменения после резервного копирования не будут пропущены при восстановлении.

В случае возникновения любой из вышеперечисленных проблем необходимо отменить процесс резервного копирования-восстановления, то есть требуется откат к исходному состоянию базы данных.

HQBird полностью автоматизирует процесс и позволяет избежать большинство проблем. Он контролирует дисковое пространство, отключат активных пользователей перед началом резервного копирования, следит за проиводительностью и целостностью резервной копии и восстановленной базы данных.

==== Запуск Backup/Restore в один клик

Чтобы сразу начать резервное копирование-восстановление, откройте диалог "`Параметры БД`" -- нажмите на соответствующий значок:

image::3.2.64.png[]

После этого появится диалог "`Параметры БД`":

image::3.2.65.png[]

Нажмите кнопку "`Do backup, restore and replace original database`", откроется следующее диалоговое окно.

image::3.2.66.png[]

Все параметры явлются необезательными:

* *Remove fbk file after restore* -- по умолчанию эта опция включена, сохраните ее, если только вы не хотите сохранить промежуточный файл `fbk`.
* *Additional backup options* -- дополнительные параметры резервного копирования, например, чтобы исключить некоторые таблицы из резервной копии.
* *Additional restore options* -- дополнительные параметры восстановления, например, чтобы установить новый размер страницы.
* *Execute before backup* -- позволяет указать исполняемый файл (файл `cmd`, sh-файл, `exe`), который будет выполняться непосредственно перед процессом резервного копирования.
* *Parameters for execute before backup* -- позволяет указать параметры для исполняемого файла выше.
* *Execute after restore* -- позволяет указать исполняемый файл (cmd-файл, sh-файл, exe), который будет выполняться сразу после процесса восстановления. Путь к восстановлению базы данных задан как первый параметр.
* *Parameters for execute after* -- это аргументы или параметры, которые будут переданы исполняемому файлу или сценарию, запуск которого запланирован после завершения процесса восстановления. Они помогают настроить поведение действий после восстановления в соответствии с конкретными потребностями среды или базы данных. Например, у вас может быть скрипт, которому необходимо знать путь к восстанавливаемой базе данных или установить определенные флаги для его работы. 
* *Override login name* -- позволяет использовать другого пользователя Firebird вместо имени пользователя, указанного в HQbird.
* *Override login password* – позволяет использовать другой пароль Firebird вместо пароля, указанного в HQbird.

Вы можете пропустить все эти параметры и просто нажать btn:[Submit], чтобы продолжить. Процесс начнется немедленно. HQbird выполнит все необходимые проверки и запустит процесс. В случае какой-либо ошибки процесс будет остановлен и исходная база данных будет возвращена обратно.

В результате HQbird сгенерирует следующий отчет:

[listing]
----
gbakreplace: backup, restore and replace database is complete
task files are:
Original database file: "C:\HQbird\Firebird40\examples\empbuild\EMPLOYEE.FDB" (2834432)
Replication operational log directory: ""
Replication archive log directory: ""
Temporary renamed original database file: "C:\HQbird\Firebird40\examples\empbuild\EMPLOYEE.FDB.Apr-08--14-32-06.ORIGINAL.FOR_MAINTAIN"
Resulted fbk file: "C:\HQbird\Firebird40\examples\empbuild\EMPLOYEE.FDB.Apr-08--14-32-06.FBK" (80896)
Temporary restored database file: "C:\HQbird\Firebird40\examples\empbuild\EMPLOYEE.FDB.Apr-08--14-32-06.restored" (2834432)
backup log: "C:\HQbird\Firebird40\examples\empbuild\EMPLOYEE.FDB.Apr-08--14-32-06.bkp.log"
restore log: "C:\HQbird\Firebird40\examples\empbuild\EMPLOYEE.FDB.Apr-08--14-32-06.rst.log"
Stage report file: "C:\HQbird\Firebird40\examples\empbuild\EMPLOYEE.FDB.Apr-08--14-32-06.hqbirdgbakreplace.report"
----

==== Задача Backup,Restore,Replace

Кроме того, можно запланировать резервное копирование и восстановление в любое желаемое время и, если это необходимо выполнить инициализацию репликации сразу после этого.
Чтобы запланировать его, нажмите кнопку "`Настройка`" в виджете *Backup, Restore, Replace*.

image::3.2.67.png[]

Появится следующий диалог:

image::3.2.68.png[]

Как видите, этот диалог пости такой же как диалог немедленного резевного копирования и востановления. Тем не менее, он дополнительно включает в себя шаги для автоматической повторной реинициализации реплик после восстановления базы данных. Это важно из-за изменения GUID базе данных после восстановления. При активной репликации HQbird будет беспрепятственно повторно реинициализировать реплику после успешного восстановления.

<<<

== Оповещения по электронной почте в HQbird FBDataGuard

FBDataGuard может отправлять оповещения по электронной почте администратору(ам): такие оповещения содержат информацию об успешном резервном копировании, а также потенциальных и реальных проблемах с базами данных.

Общие свойства уведомлений можно настроить, нажав на имя сервера (или имя компьютера) вверху веб-консоли:

image::3.1.9.png[]

После этого вы увидите диалог общих настроек оповещений:

image::3.1.10.png[]

Описания некоторых свойств, которые вы можете установить здесь:

* "`*Имя экземпляра FBDataGuard*`" -- какое-нибудь читаемое имя для вашего удобства; оно будет упоминаться в электронных письмах и оповещениях.
* "`*GUID экземпляра*`" -- служебное поле; нет необходимости менять его.
* "`*Цвет фона веб-консоли*`" -- часто полезно настроить цвет веб-интерфейса HQbird.

Рекомендуется включить настройку оповещений по электронной почте. Для этого вам нужно нажать на кнопку конверта вверху веб-консоли:

image::3.1.11.png[]

После этого вы увидите диалог настройки оповещений:

.Диалог настройки оповещений по электронной почте в FBDataGuard.
image::3.1.12.png[]

Прежде всего, вам необходимо включить отправку оповещений, установив флажок "`Отправлять предупреждения по email`".

* "`*Отправлять предупреждения по email*`" — включает оповещения по электронной почте и отображает настройки параметров электронной почты ниже.
* "`*Кому отправлять*`" -- указывает куда отправлять электронные письма.
* "`*Поле 'От'*`" -- это то, что будет установлено в качестве отправителя в электронном письме.
* "`Адрес SMTP сервера`", "`Порт SMTP сервера`", "`Логин на SMTP`" и "`Пароль на SMTP`" -- это данные, которые будут использоваться для отправки электронных писем.

Перед сохранением настроек вы можете нажать кнопку "`Отослать тестовое сообщение`", если настройки верны, вам должно прийти письмо на указанный адрес.

Чтобы ограничить количество писем, вы можете собирать сообщения в группы и отправлять их пакетами. Для этого установите флажок "`Group notifications in emails`". Это также поможет обойти некоторые анти спам-системы, которые могут внести вас в черный список из-за слишком частой отправки электронных писем.

Нажмите "`Сохранить`", чтобы сохранить настройки оповещений по электронной почте.

<<<

== Советы и рекомендации FBDataGuard

FBDataGuard позволяет менять его настройки не только через веб-консоль, но и путем прямого изменения файлов конфигурации. Это может быть полезно, когда вам нужно установить FBDataGuard в автоматическом режиме (без взаимодействия с пользователем), связать его со сторонним программным обеспечением или выполнить некоторые тонкие настройки конфигурации.

=== Путь к конфигурации FBDataGuard

При запуске FBDataGuard ищет в реестре пути конфигурации и вывода:

image::3.2.61.png[]

Эти значения указывают пути к конфигурации FBDataGuard и выходной папке. Они выбираются во время установки.

[[hqbird-config-fbdataguard-port]]
=== Настройка порта веб-консоли

Один из наиболее часто задаваемых вопросов -- как настроить порт для приложения веб-консоли (по умолчанию это 8082). Это можно сделать, изменив настройку порта в файле `%config%\agent\agent.properties` (`%config %` -- это `C:\HQbirdData\config` или `/opt/hqbird/conf`).

[listing]
----
server.port = 8082  #change it
----

`%config%` -- папка для хранения информации о конфигурации, в которой она указана.

=== Как изменить пароль администратора

Вы можете указать этот пароль в файле `access.properties` (в `C:\HQbirdData\config` или `/opt/hqbird/conf`)

[listing]
----
access.login=admin

access.password=youradminpasswordforhqbird
----

После установки пароля перезапустите FBDataGuard, и новый пароль будет зашифрован и применен.

=== Гостевой пользователь HQbird FBDataGuard

Для доступа к HQbird FBDataGuard существует пользователь только для чтения с именем `guest`.

[listing]
----
access.guest-login=guest

access.guest-password=yournewpassword
----
