[[hqbird-encryption]]
= Поддержка шифрования

HQbird включает плагин шифрования и обеспечивает поддержку работы с базами данных шифрования в веб-интерфейсе. Эта функция поддерживается только в HQBird с Firebird 3.0 и выше.

.Обратите внимание!
[NOTE]
====
Плагин шифрования требует отдельного файла лицензии, он отправляется в электронном письме о покупке.

Плагин шифрования можно приобрести отдельно и использовать с community версией Firebird: https://ib-aid.com/download-demo-firebird-encryption-plugin[]
====

== Файлы OpenSSL

Этот продукт включает программное обеспечение, разработанное OpenSSL Project использующееся в OpenSSL Toolkit (http://www.openssl.org/[]).

HQbird для Windows уже включает в себя необходимые двоичные файлы OpenSSL 1.1. Чтобы использовать функции шифрования в Linux, необходимо установить **OpenSSL 1.1**.

== Как зашифровать и дешифровать базу данных Firebird

В этом кратком руководстве ниже мы продемонстрируем ключевые особенности шифрования: как зашифровать базу данных Firebird на сервере, как реализовать зашифрованное клиентское соединение и выполнить резервное копирование/восстановление зашифрованной базы данных. Демо-версия FEPF полностью функциональна, за единственным исключением -- она ограничена до 30 декабря 2019 года.

=== Демо-пакет с примерами клиентских приложений

Загрузите демо-пакет с примерами клиентских приложений по ссылке https://ib-aid.com/download/crypt/CryptTest.zip[]

=== Этап 1. Первоначальное шифрование базы данных.

На данный момент мы предполагаем, что у вас есть некоторая база данных, которую нужно зашифровать.
Поместите незашифрованную базу данных по какому-нибудь пути, например, в `c:\temp\employee30\employee.fdb`

Мы предполагаем, что все действия производятся с 64-битной версией Firebird 3.0.3+, в случае 32-битной версии просто используйте файлы из папки `WinSrv32bit_ServerPart`.

. Создайте следующий псевдоним в `databases.conf`
+
[listing]
----
crypt = C:\Temp\EMPLOYEE30\EMPLOYEE30.FDB
{
   KeyHolderPlugin = KeyHolder
}
----
+
Также вы можете объявить плагин `KeyHolder` для всех баз на сервере, для этого добавьте в `firebird.conf` следующий параметр:
+
[listing]
----
KeyHolderPlugin = KeyHolder
----
+
или просто скопируйте `firebird.conf` на шаге 2 (см. ниже).

. Убедитесь, что в `server/plugins` скопированы следующие файлы из папки `WinSrv64Bit_ServerPart\plugins`
+
* `DbCrypt.dll`
* `DbCrypt.conf`
* `KeyHolder.dll`
* `KeyHolder.conf` -- этот текстовый файл с ключами предназначен только для использования разработчиками, его нельзя отправлять конечным пользователям!

. Поместите следующие файлы в корень Firebird из папки `WinSrv64Bit_ServerPart`
+
* `fbcrypt.dll`
* `libcrypto-1_1-x64.dll`
* `libssl-1_1-x64.dll`
* `gbak.exe`
* `firebird.msg`
* `firebird.conf` (необязательно, может использоваться в качестве примера)

. Подключитесь к незашифрованной базе данных с помощью `isql` и зашифруйте базу данных:
+
[listing]
----
isql localhost:C:\Temp\EMPLOYEE30\EMPLOYEE30.FDB -user SYSDBA -pass masterkey
SQL>alter database encrypt with dbcrypt key red;
SQL> show database;
Database: localhost:C:\Temp\EMPLOYEE30\EMPLOYEE30.FDB
        Owner: ADMINISTRATOR
PAGE_SIZE 8192
Number of DB pages allocated = 326
Number of DB pages used = 301
Number of DB pages free = 25
Sweep interval = 20000
Forced Writes are OFF
Transaction - oldest = 2881
Transaction - oldest active = 2905
Transaction - oldest snapshot = 2905
Transaction - Next = 2909
ODS = 12.0
Database encrypted
Default Character set: NONE
----
+
Давайте рассмотрим команду шифрования:
+
[source,sql]
----
alter database encrypt with dbcrypt key red;
----
+
Здесь `dbcrypt` -- это имя плагина шифрования, а `red` -- имя используемого ключа. Ключи определяются в файле `KeyHolder.conf`.
+
Обратите внимание: в Linux необходимо использовать кавычки и имя плагина с учетом регистра:
+
[source,sql]
----
alter database encrypt with "DbCrypt" key Red;
----

После этого база данных шифруется с аутентификацией на стороне сервера: ключи находятся в файле `KeyHolder.conf`.

На рисунке ниже вы можете увидеть файлы, которые необходимы на сервере для включения шифрования, и файлы, которые необходимы на стороне клиента:

[cols="1,1", options="header"]
|===
| На серверной стороне:
| На стороне клиента (Демо - `CryptTest.exe`) - 32bit

|**Обязательные файлы:**
|**Обязательные файлы:**

|`plugins/dbcrypt.dll`
|`fbclient.dll`

|`plugins/keyholder.dll`
|`fbcrypt.dll`

|`DbCrypt.conf`
|`libcrypto-1_1.dll`

|`libssl-1_1-x64.dll`
|**Необязательные файлы:**

|`libcrypto-1_1-x64.dll`
|`firebird.conf`

|`fbcrypt.dll`
|

|**Файлы для gbak с шифрованием:**
|

|`gbak.exe`
|

|`firebird.msg`
|

|**Необязательные файлы:**
|

|`plugins/KeyHolder.conf` (для первоначального шифрования в режиме разработки)
|

|`firebird.conf` (содержит параметр для установки плагина шифрования)
|
|===

=== Этап 2. Подключение к зашифрованной базе данных с помощью клиентского приложения.

Предполагаем, что после первоначального шифрования база данных будет скопирована в среду заказчика, где доступ к ней будет осуществляться только через авторизованное приложение.

Чтобы имитировать такую среду, нам нужно удалить (или просто переименовать) файл с ключами (`KeyHolder.conf`) из папки плагинов.

Без `KeyHolder.conf` плагин шифрования потребует получения ключа от подключенного приложения. Пример такого приложения включен в архив с демонстрационным плагином -- для него есть скомпилированная версия и полные исходники на Delphi XE8.

Код инициализации зашифрованного соединения очень прост -- перед обычным соединением необходимо выполнить несколько вызовов для отправки соответствующего ключа. После этого клиентское приложение работает с Firebird в обычном режиме.

Запустите демо-приложение для проверки работы с зашифрованной базой данных, оно находится в папке `CryptTest\EnhancedCryptTestClient\Win32\Debug`.

Выполните следующие шаги:

. Укажите путь к базе данных или псевдоним в "`1. Setup Login`". Эта база данных будет использоваться на следующих этапах.
. Укажите имя и значение ключа, которые будут использоваться. +
Если вы ранее использовали ключ RED, установите `Key Name = RED` и скопируйте значение ключа из файла `KeyHolder.conf`.
. Вы можете зашифровать и расшифровать базу данных с помощью указанного ключа. Обратите внимание: шифрование требует времени и активного подключения к базе данных.
. Нажмите Execute query, чтобы проверить соединение с зашифрованной базой данных

image::8.1.png[]


.Обратите внимание!
[NOTE]
====
Тестовое приложение может подключаться к зашифрованной базе данных только через TCP/IP, xnet не поддерживается.
====

В примере клиентского приложения все операции с базой данных (подключение, запуск транзакции, подтверждение транзакции, запуск запроса и т. д.) выполняются очень простым способом, чтобы продемонстрировать все этапы операций с зашифрованной базой данных. Вы можете использовать этот код в качестве примера реализации шифрования в ваших приложениях.

image::8.2.png[]

=== Этап 3 — резервное копирование и восстановление зашифрованной базы данных.

Полная проверенная резервная копия сделанная с помощью `gbak.exe` является основным методом резервного копирования баз данных Firebird. В стандартный дистрибутив Firebird входит инструмент командной строки `gbak.exe` для её выполнения, однако он не будет работать с зашифрованной базой данных в рабочем режиме (без ключей на сервере). После шифрования только авторизованные приложения могут получить доступ к зашифрованной базе данных, а стандартный `gbak` не является авторизованным приложением.

Мы все знаем, насколько важно резервное копирование и восстановление для работоспособности и производительности базы данных, поэтому для выполнения резервного копирования и восстановления зашифрованных баз данных мы разработали `gbak.exe` с поддержкой шифрования и включили его в FEPF.

Важно отметить, что этот `gbak.exe` создает зашифрованный файл резервной копии: он шифрует резервную копию тем же ключом, что и для шифрования базы данных.

Если вы запустите `gbak.exe` из файлов плагина с ключом `-?`, вы увидите новые параметры `gbak.exe`, которые используются для работы с зашифрованными базами данных:

[listing]
----
  -KEYFILE              name of a file with DB and backup crypt key(s)
  -KEYNAME              name of a key to be used for encryption
  -KEY                  key value in "0x5A," notation
----

Давайте рассмотрим, как использовать `gbak.exe` с зашифрованными базами данных и резервными копиями.

==== Резервное копирование зашифрованной базы данных Firebird

Для резервного копирования зашифрованной базы данных Firebird `gbak.exe` должен предоставить ключ для сервера. Этот ключ будет использоваться для подключения и чтения базы данных, а также для шифрования файла резервной копии.

Есть два способа предоставить ключ для `gbak.exe`: сохранить ключ в файле ключей или явно указать его в командной строке:

.Пример создания резервной копии с ключом шифрования в файле ключей
[example]
====
[listing]
----
gbak.exe -b -KEYFILE h:\Firebird\Firebird-3.0.3.32900-0_Win32\examplekeyfile.txt
  -KEYNAME RED localhost:h:\employee_30.fdb h:\testenc4.fbk -user SYSDBA
  -pass masterkey
----

Здесь в параметре `-KEYFILE` мы указываем расположение файлов с ключами, а в `-KEYNAME` -- имя используемого ключа. Обратите внимание, что файл `examplekeyfile.txt` имеет ту же структуру, что и `KeyHolder.conf`.

Если вы запустите создание резервной копии с шифрованием (`gbak -b -keyfile ... -keyname ...`) к незашифрованной базе данных, то резервная копия будет зашифрована.
====

.Пример резервного копирования с явным ключом
[example]
====
[listing]
----
gbak -b -KEY 0xec,0xa1,0x52,0xf6,0x4d,0x27,0xda,0x93,0x53,0xe5,0x48,0x86,0xb9,
  0x7d,0xe2,0x8f,0x3b,0xfa,0xb7,0x91,0x22,0x5b,0x59,0x15,0x82,0x35,0xf5,0x30,
  0x1f,0x04,0xdc,0x75, -keyname RED localhost:h:\employee30\employee30.fdb
  h:\testenc303.fbk -user SYSDBA -pass masterkey
----

Здесь мы указываем значение ключа в параметре `-KEY` и имя ключа в параметре `-KEYNAME`. Необходимо указать имя ключа, даже если мы указываем явное значение ключа.
====

==== Восстановление резервной копии зашифрованной базы данных Firebird.

`gbak` также может восстанавливать данные из файлов резервных копий в зашифрованные базы данных. Подход тот же: нам нужно указать имя ключа и значение ключа для восстановления файла резервной копии.

Ниже приведены примеры команд восстановления:

.Пример восстановления с использованием ключа шифрования в файле ключа
[example]
====
[listing]
----
gbak -c -v -keyfile h:\Firebird\Firebird-3.0.3.32900-0_Win32\examplekeyfile.txt
  -keyname white  h:\testenc4.fbk localhost:h:\employeeenc4.fdb  -user SYSDBA
  -pass masterkey
----
====

.Пример восстановления с явным ключом
[example]
====
[listing]
----
gbak -c -v -key 0xec,0xa1,0x52,0xf6,0x4d,0x27,0xda,0x93,0x53,0xe5,0x48,0x86,
  0xb9,0x7d,0xe2,0x8f,0x3b,0xfa,0xb7,0x91,0x22,0x5b,0x59,0x15,0x82,0x35,0xf5,
  0x30,0x1f,0x04,0xdc,0x75, -keyname RED  h:\testenc4.fbk
  localhost:h:\employeeenc4.fdb  -user SYSDBA -pass masterkey
----

Если вы выполняете восстановление из незашифрованного файла резервной копии с ключами шифрования (`gbak -c -keyfile ... -keyname ...`), то восстановленная база данных будет зашифрована.
====
