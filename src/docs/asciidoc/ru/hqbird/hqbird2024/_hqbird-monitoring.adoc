[[hqbird-monitoring]]
= Мониторинг

== Мониторинг с помощью HQbird FBDataGuard

=== Обзор

HQbird контролирует все аспекты функционирования сервера и базы данных Firebird, включая непрерывный и детальный мониторинг.

Непрерывный мониторинг осуществляет HQbird FBDataGuard. Это малоинвазивный, но очень эффективный мониторинг, который может помочь найти и устранить большинство проблем с производительностью и стабильностью баз данных.

FBDataGuard выполняет следующие действия по мониторингу:

* Дополнительный мониторинг производительности с помощью TraceAPI и MON$
* Мониторинг динамики маркеров транзакций (Next, OAT, OIT, OST, активные транзакции)
* Мониторинг активности таблицы блокировок (queues, deadlocks, mutexes)
* Мониторинг журнала Firebird (errors, warnings, messages)
* Количество подключенных пользователей
* Мониторинг свободного места для сервера, баз данных и их резервных копий
* Мониторинг работоспособности посредством анализа метаданных базы данных и общей доступности сервера и баз данных.
* Количество и размер временных файлов Firebird (сортировка и т. д.)
* Мониторинг индексов: целостность и активность
* Общая проверка базы данных Firebird
* Мониторинг статусов резервных копий
* Мониторинг доступности реплик

FBDataGuard может графически представлять информацию, собранную в ходе мониторинга, например о транзакциях и количестве пользователей:

.Динамика транзакций в FBDataGuard.
image::4.1.1.png[]


.Количество пользователей.
image::4.1.2.png[]


=== Автоматический мониторинг с помощью FBDataGuard (Trace API)

В HQBird 2020 представляет новый подход к автоматическому мониторингу производительности с помощью таблиц Firebird TraceAPI.

Теперь регулярную проверку работоспособности базы данных можно запланировать менее чем за 1 минуту.

Для этого просто откройте вкладку "`Производительность`" и настройте мониторинг транзакций и запросов:

image::4.1.3.png[]

Чтобы настроить Мониторинг производительности, укажите в диалоге его обязательные параметры:

image::4.1.4.png[]

Первый обязательный параметр -- "`*Включить мониторинг производительности*`" -- его необходимо включить для запуска трассировок по расписанию.

Следующие важные параметры -- "`Запустить трассировку в`"  и "`Остановить трассировку в`"
Они содержат выражения CRON, которые определяют, когда начинается и заканчивается трассировка.

*По умолчанию трассировка начинается в 10:30 и заканчивается в 11:00*. Рекомендуется принять график отслеживания в соответствии с вашими потребностями. Ниже вы можете увидеть таблицу с некоторыми популярными вариантами.

[cols="1,1,3"]
|===
2+h| Выражения CRON
.2+h| Описание

h| Старт
h| Завершение

|0 0 * ? * *
|0 10 * ?* *
|Запускать трассировку каждый час с 0 до 10 минут

|0 0 8 ? * *
|0 0 17 ?* *
|Запускать трассировку каждый день с 8:00 до 17:00

|0 30 10,13,15 ? * *
|0 0 11,14,16 ? * *
|Запускать трассировку каждый день с 10:30 до 11:00, с 13:30 до 14:00 и с 15:30 до 16:00

|===

Следующий важный параметр -- порог времени для медленных запросов, он задается в поле "`Логировать SQL-запросы с временем выполнения более чем (ms)`". В этом поле необходимо установить порог времени выполнения запросов (в миллисекундах), после его превышения запросы будут сохраняться и анализироваться.

По умолчанию время установлено на 1000 миллисекунд или 1 секунду. Это означает, что будут регистрироваться и анализироваться только запросы, которые выполняются более 1 секунды.

Мы рекомендуем использовать базовое значение 1000 мс, пока ваша база данных не станет очень медленной: в этом случае 3000-5000 мс могут быть хорошим началом.

Флажок "`Отправить e-mail`" указывает на необходимость отправки отчета о производительности. Настройки электронной почты из конфигурации оповещений будут использоваться для отправки отчета о производительности.

Для более сложных настроек в диалоговом окне "`Мониторинг производительности`" есть дополнительные параметры (обычно их настраивать не требуется).

image::4.1.5.png[]

* "`*Образец имени файла конфигурации*`" -- имя файла шаблона конфигурации, который следует использовать для настроек трассировки.
* "`*Фильтр выбора БД*`" -- как должна идентифицироваться база данных. Обычно "`АВТО`" достаточно, он отслеживает указанную базу данных. В случае "`ИМЯ_БД`" или "`ПСЕВДОНИМ`" для фильтрации событий базы данных будет использоваться имя файла или псевдоним. "`ВРУЧНУЮ`" предоставляет возможность задать любое регулярное выражение, например, для трассировки нескольких баз данных или более одного псевдонима для одной базы данных.
* "`*Database name filter*`" -- используется если выбран фильтр "`MANUAL`".
* "`*Сохранять N последних отчетов*`" -- указывает, сколько отчетов должно храниться в "`Каталог для хранения отчета`" для возможного ретроспективного использования.

В результате этого задания HQbird сформирует отчет о производительности, который будет сохранен в папке "`Каталог для хранения отчета`" в виде файла с расширением **html** и отправлен по электронной почте (в случае, если "`Отправить e-mail`" включен). Также самые последние отчёты доступны для просмотра и скачивания в интерфейсе HQBird.

image::4.1.6.png[]

=== Что показывает отчёт о производительности?

Анализ производительности HQbird FBDataGuard предоставляет 3 типа отчетов:

. список запросов, отсортированный по времени -- "`Sort by duration`";
. список запросов, отсортированный по частоте -- "`Sort by frequency`";
. список запросов, отсортированный по общему времени (т. е. суммарное время выполнения запросов с одинаковым текстом и различными параметрами) -- "`Sort by summary`".

В начале отчета вы увидите графическое представление наиболее проблемных SQL-запросов:

image::4.1.7.png[]

image::4.1.7-1.png[]

Когда вы нажмете "`Sort by duration`" (это опция по умолчанию), вы увидите SQL-запросы и хранимые процедуры, выполнение которых в первую очередь заняло больше всего времени.

Обычно они возникают на длительных отчетах и других больших SQL-запросов.

image::4.1.8.png[]

При нажатии на ссылку "`Sort by frequency`" в шапке отчета вы увидите наиболее частые запросы: т.е. те запросы, которые запускались часто (среди зарегистрированных запросов).

image::4.1.9.png[]

Например, если процедура `SP_GET_INVOICE_REPORT` (или другой запрос) была выполнена 46 раз, то это означает, что данный запрос сильно влияет на общую производительность, и его следует оптимизировать в первую очередь.

При нажатии на "`Sort by summary`" вы увидите запросы, которые заняли большую часть времени (среди зарегистрированных запросов). Эти запросы обычно являются лучшими кандидатами на оптимизацию.

image::4.1.10.png[]

==== Подробная информация по проблемным SQL-запросам.

Чтобы просмотреть детали наиболее частого запроса, нажмите ссылку "`View details`" внизу текста запроса:

image::4.1.11.png[]

В результате вы увидите самый длинный запрос среди запросов с одинаковым текстом SQL, с его планом выполнения, статистикой выполнения и входными параметрами.

Этой информации достаточно для анализа и оптимизации SQL-запроса в Firebird SQL Studio или другой IDE для разработчиков.

=== Как выбрать инструмент для детального мониторинга

FBDataGuard -- это первая линия защиты базы данных Firebird; как только FBDataGuard обнаруживает что-то подозрительное внутри контролируемых областей, он отправляет предупреждение с описанием проблемы.

[IMPORTANT]
====
Если у вас есть несколько серверов Firebird, мы предлагаем приложение HQbird Control Center, которое собирает данные оповещений с серверов и баз данных Firebird и отображает их на одном экране. Свяжитесь с нами для получения более подробной информации.
====

После получения такого предупреждения от FBDataGuard администратор базы данных должен приступить к детальному изучению проблемы.

Выбор инструмента для детального мониторинга зависит от типа обнаруженной проблемы.

Если FBDataGuard сообщает о длительно выполняемой активной транзакции (Next-OAT), необходимо использовать *HQbird Mon$Logger* для обнаружения источника текущей активной транзакции.

Если сообщается о зависании oldest interesting транзакции, администратор базы данных должен запланировать явный sweep для очистки несобранного мусора с помощью задания Sweep FBDataGuard (если это необходимо), а затем запланировать отслеживание принудительных откатов с помощью Мониторинга производительности в FBDataGuard.

Если пользователи сообщают о проблеме медленности выполнения некоторых запросов, следует настроить Performance Monitoring или использовать Advanced Performance Monitoring.

Проблемы с общей производительностью базы данных и периодические или периодические замедления требуют анализа структуры базы данных, который можно выполнить только с помощью HQbird Database Analyst.

Ниже мы рассмотрим более подробно, как работать с инструментами мониторинга HQbird.

<<<

== Мониторинг с помощью MON$ таблиц: HQbird MonLogger

HQbird MonLogger -- это инструмент для анализа вывода таблиц мониторинга в Firebird, поиска проблем с медленными SQL-запросами, неправильно спроектированных транзакций (длительно выполняемых транзакций, транзакций с неправильным уровнем изоляции и т. д.), а также выявления проблемных приложений.

MonLogger может подключиться к базе данных Firebird с проблемами производительности и определить причину медленности: какое пользовательское подключение, медленный SQL-запрос или длительная транзакция?

MonLogger поддерживает Firebird 2.1, 2.5, 3.0, 4.0 и 5.0 -- для более старых версий Firebird или InterBase используйте FBScanner (не входит в состав HQbird, приобретается отдельно).

MonLogger может показать вам:

* Топ соединений с наибольшим количеством операций ввода-вывода, не индексированных и индексированных чтений
* Топ SQL запросов с наибольшим количеством операций ввода-вывода, не индексированных и индексированных чтений
* Проблемные транзакции: длительные транзакции, транзакции с ошибочным уровнем изоляции, транзакции чтения/записи и сопутствующая информация: когда они начались, какие приложения запустили эти транзакции, с какого IP-адреса и т. д.
* Соединения и запросы с наиболее интенсивными действиями по сборке мусора
* Соотношение Read/write, соотношение INSERT/UPDATE/DELETE и другое.

После подключения к базе данных, в которой вы хотите обнаружить проблемы с производительностью, необходимо сделать несколько снимков таблиц мониторинга -- нажмите "`Get Snapshot`", чтобы сделать снимок

=== Агрегированная статистика производительности для пользовательских соединений

На первом экране мы можем увидеть агрегированную статистику подключений к базе данных и выявить соединения с наибольшими проблемами:

image::4.2.1.png[]

==== Sequential reads / Indexed reads

"`Sequential reads / Indexed reads`" показывает нам общее соотношение между последовательными (неиндексированными) чтениями и индексированными чтениями в приложении. Обычно количество неиндексированных чтений должно быть небольшим, поэтому большой процент последовательных чтений является признаком того, что многие SQL-запросы имею план выполнения `NATURAL`, и они могут быть причиной медленного времени ответа.

Щелкните на записи в разделе "`TOP attachments: sequential/indexed reads`", чтобы перейти на вкладку "`Attachments`", где можно просмотреть более подробную информацию о соединениях с БД, а затем перейти на вкладку  "`Transactions`" или "`Statements`", где вы увидите транзакции и запросы, связанные с выбранным соединением (если установлен флажок "`Link to selected attachment`", в противном случае будут показаны все транзакции/запросы для всех соединений).

==== Write details

"`Write details`" дает вам обзор операций записи: соотношение между INSERT/UPDATE/DELETE среди всех соединений базы данных. В таблице top writes вы можете увидеть соединения с наибольшим количеством операций записи. Полезно выявить приложения или программные модули, которые выполняют чрезмерное количество обновлений или удалений (они являются наиболее опасными операциями с точки зрения сборки мусора).

==== Garbage collection details

Что означают операции по сборке мусора?

* Purge -- движок удаляет бэк-версии, в базе данных находится только основная версия.
* Expunge -- как основная версия, так и все бэк-версии были удалены.
* Back-out -- удалена только основную версию (из-за rollback).

Обычно мы можем связать Purge с операцией `UPDATE`, Expunge с `DELETE`, и Backout с откатом `INSERT` или `UPDATE`. Множество backouts могут означать, что в приложении возникла проблема с управлением транзакциями.

==== Memory usage

График "`Memory usage`" показывает общий объем памяти, используемый всеми активными соединениями сейчас, и пик выделенной памяти для них в прошлом.

Топ соединений по объему использования памяти показывает, какие ваши соединения больше всего потребляют память. Полезно найти приложения или программные модули с чрезмерным использованием памяти.

=== Aggregated performance statistics for statements

На второй вкладке вы можете найти агрегированную статистику производительности SQL запросов.

image::4.2.2.png[]

Эта статистика лучше отражает текущую ситуацию в базе данных -- поскольку таблицы мониторинга собирают информацию с начала жизни каждого объекта, здесь вы можете увидеть операторы, которые выполнялись в момент создания моментального снимка.

==== Sequential reads / Indexed reads

В этом списке мы видим топ запросов, которые выполняют множество операций последовательного чтения из базы данных. Обычно такие запросы требуют настройки SQL -- либо путем создания индексов индексов, либо путем изменения конструкции SQL-запроса.

Чтобы настроить запрос, проверьте план его выполнения: обычно можно повысить скорость запроса, исключив из планов `NATURAL` с помощью новых индексов или переписывания запроса. Щёлкните по запросу в этом списке, чтобы открыть вкладку "`Statements`", где вы сможете найти более подробную информацию о выбранном запросе и перейти к соответствующей транзакции или соединению.

==== Page reads/page writes

На этих графиках и в списке представлена краткая информация о топе SQL запросов, которые выполняют много операций чтения -- это означает, что они потребляют значительный объем операций ввода-вывода и могут повлиять на производительность других запросов. SQL запросы с пиковыми значениями следует тщательно проверять на предмет оптимальной производительности.

==== Write details для запросов

На этом графике вы можете увидеть, что записывали SQL операторы в момент создания снимка таблиц мониторинга, а также определить UPDATEs и DELETEs, которые внесли много изменений в базу данных.

==== Garbage collection details для запросов

На этом графике мы видим, сколько операций по сборке мусора было выполнено SQL запросами, выполнявшимися в момент создания снимка.

==== Memory usage для запросов

В отличие от агрегированной статистики использования памяти для соединений, использование памяти SQL запросами может показать нам список точных операторов, которые в данный момент потребляют много памяти.

=== Attachments

Третья вкладка -- "`Attachments`". Вы можете открыть эту вкладку и перейти туда, щелкнув одну из записей в разделе "`Aggregated performance statistics`".

image::4.2.3.png[]

"`Attachments`" показывает список пользователей, подключенных к базе данных Firebird, со многими полезными подробностями: `USER` и `ROLE` для соединения, время начала и идентификатор соединения, включена ли сборка мусора для соединения, имя удаленного процесса, установившего соединение, и несколько накопленных счетчиков производительности для соединения: количество последовательных чтений (выполненных соединений с момента его запуска), количество индексированных чтений, количество вставок, обновлений и удалений, а также количество backouts, purges и expunges.

По умолчанию некоторые столбцы соединения отключены, чтобы отображалась только самая важная информация.

Конечно, каждый раз, когда вы щёлкаете по соединению, вы можете перейти к транзакциям, выполняемым внутри него, а затем к запросам. В левом верхнем углу вкладок "`Transactions`" и "`Statements`" есть флажок, который управляет поведением: если этот флажок установлен, будут отображаться только транзакции и запросы, по выделенному идентификатору соединения.

=== Transactions

Закладка "`Transactions`" показывает активные транзакции на момент создания снимка.

image::4.2.4.png[]

Если установлен флажок "`Link to selected attachment`" будут показаны только транзакции для выбранного соединения, в противном случае показаны все транзакции.

Одной из наиболее важных характеристик является время жизни транзакций: поскольку Firebird предназначен для работы с короткими пишущими транзакциями, важно сделать их как можно более короткими. MonLogger выделяет транзакции с режимами изоляции и read-write настройками, которые содержат Oldest Active транзакцию и, следовательно, приводят к тому, что они накапливают чрезмерное количество версий записей. Если вы видите такую транзакцию и она началась некоторое время назад, это означает, что она может быть ответственна за чрезмерное накопление версий записей.

Выполните сортировку по столбцу "`started at`" и найдите старые транзакции, отмеченные красным: все транзакции, доступные для записи, и snapshot транзакции, доступные только для чтения, приводят к застреванию в Oldest Active Transaction и вызывают удержание чрезмерного количества версий записей. Определите, где начались эти транзакции (щелкните правой кнопкой мыши и выберите "`View parent attachment`") и исправьте свой код, чтобы фиксировать эту транзакцию раньше.

=== Statements

image::4.2.5.png[]

На вкладке "`Statements`" показаны SQL операторы, активные на момент создания снимка: если вам нужно перехватить все операторы, то следует настроить Performance Monitoring или использовать Advanced Performance Monitoring.

Если включена опция "`Link to selected attachment`", то будут показаны только SQL запросы для конкретного соединения, в противном случае в списке будут все активные запросы.

Некоторые операторы не имеют связанного идентификатора транзакции (=0): эти запросы подготавливаются, но не выполняются.

<<<

[[hqbird-advanced-monitor-viewer]]
== Advanced Monitor Viewer

Advanced Monitor Viewer позволяет графически отображать дополнительные счетчики производительности. Они основаны как на данных трассировки, так и на данных таблиц мониторинга, плюс используются дополнительные системные утилиты, такие как wmic (Windows).

Для запуска "`Advanced Monitor Viewer`" нажмите на соответствующий пункт меню "`Пуск`" menu:IBSurgeon[HQbird Server Side 2024 > Advanced Monitor Viewer] или запустите скрипт `AVM/quick_start.cmd`.

После успешного запуска в браузере по умолчанию откроется страница `http://127.0.0.1:8083`.

Вам будет предложено войти в систему:

image::4.4.1.png[]

Логин и пароль по умолчанию такие же, как и для DataGuard: "admin / strong password".

После успешной аутентификации откроется страница с панелью, на которой расположены различные графики, отображающие загрузку системы в разные моменты времени.

В левой части страницы вы увидите две кнопки: "`Properties`" и "`Databases`". Первая открывает контекстное меню для выбора счетчиков, которые будут отображаться на графиках. Вторая, открывает контекстное меню, в котором можно выбрать базу данных, для которой отображаются эти счетчики. База данных должна быть зарегистрирована для мониторинга с помощью DataGuard.

image::4.4.1-1.png[]

Вверху страницы отображается название базы данных, закладки с датами, а также интервал времени, за который отображаются счетчики производительности. Вы можете изменить дату просмотра и выбрать нужный интервал.

image::4.4.2.png[]

Следующие счетчики могут быть отображены графически:

=== Fetches, Reads, Writes, Marks

На графике отображаются счетчики производительности Fetches, Reads, Writes, Marks на основе таблиц мониторинга. Вы можете перейти к каждому моменту времени, щелкнув по нему или выбрав "`Data for time`" из списка.

image::4.4.3.png[]

=== Users

На графике отображается количество активных пользователей и запросов, а также время пинга. Вы можете перейти к каждому моменту времени, щелкнув по нему или выбрав "`Data for time`" из списка.

image::4.4.4.png[]

=== Traces

На графике отображаются счетчики производительности:  Fetches, Reads, Writes, Marks и время выполнения запроса на основе данных из журналов трассировки. Вы можете перейти к каждому моменту времени, щелкнув по нему или выбрав "`Data for time`" из списка.

image::4.4.5.png[]

=== RAM and CPU Windows

На графике отображается потребляемая память, а также загрузка процессора на основе отслеживания утилитой wmic.

image::4.4.6.png[]

=== RAM and LoadAvg Linux

То же, что "`RAM and CPU Windows`", только в Linux.

=== Transactions

На графике отображается количество активных транзакций и разрыв между счетчиками OST-OIT, Next-OAT.

image::4.4.7.png[]

=== Lock Table Info

На графике отображаются данные по нагрузке на менеджер блокировок (актуально в Classic и SuperClassic).

image::4.4.8.png[]
