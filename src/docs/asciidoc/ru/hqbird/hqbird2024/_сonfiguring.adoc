[[_hqbird_config]]
= Настройка заданий, мониторинга и обслуживания в FBDataGuard

Пожалуйста, выполните следующие шаги:

. Убедитесь что у вас установлен Firebird 2.5.5 или новее, и он работает;
. Служба HQbird FBDataGuard установлена и запущена
+
.. Проверить это можно с помощью апплета "`Службы`" в Панели управления (щелкните правой кнопкой мыши "`Мой компьютер`", выберите "`Управление`", затем "`Службы и приложения`", "`Службы`" и найдите в списке "`Agent FBDataGuard`"
.. В Linux вы можете проверить это с помощью команды `ps aux | grep dataguard`.
. Убедитесь, что порт FBDataGuard доступен (8082) и не заблокирован брандмауэром или другими антивирусными инструментами. При необходимости настройте порт в файле конфигурации FBDataGuard (см. <<_hqbird_config_fbdataguard_port,Web-console port>>).


== Запуск веб-консоли

Чтобы открыть веб-консоль, введите в браузере `http://localhost:8082` или используйте IP-адрес вашего сервера с установленным HQbird ServerSide.

Или вы можете выбрать в меню "`Пуск`" menu:IBSurgeon[FBDataGuard].

=== Поддерживаемые браузеры

Веб-интерфейс FBDataGuard корректно работает с Firefox, Chrome, Safari, Microsoft Edge и Internet Explorer 11.

=== Сообщение об ошибке сертификата веб-сайта

Если вы настроили FBDataGuard на использование https, браузер укажет, что этот сайт небезопасен, и предложит покинуть сайт. Это сообщение вызвано сертификатом безопасности по умолчанию для веб-консоли FBDataGuard.

Пожалуйста, проигнорируйте это сообщение и нажмите открыть веб-консоль FBDataGuard.

Он запросит у вас имя пользователя и пароль (диалог входа в систему может отличаться для Firefox, Safari или Chrome).

.Ввод логина и пароля для веб-консоли FBDataGuard.
image::3.1.1.png[]


.Внимание!
[IMPORTANT]
====
По умолчанию пользователь/пароль для HQbird FBDataGuard -- "**admin"/"strong password**" (без кавычек).
====

=== Функция автоматического обнаружения FBDataGuard

При первом запуске FBDataGuard проверит компьютер на наличие установленных серверов Firebird. FBDataGuard для Windows ищет в реестре записи Firebird, FBDataGuard для Linux проверяет местоположения по умолчанию для установок Firebird.

FBDataGuard покажет список всех установленных копий Firebird, но FBDataGuard может отслеживать только один экземпляр Firebird.
Выберите его, нажав btn:[Добавить в мониторинг >>]

Если вы не видите экземпляр Firebird в списке автоматического обнаружения, вы можете выбрать btn:[Добавить сервер вручную >>] и настроить параметры экземпляра вручную.

.Функция автоматического обнаружения HQbird.
image::3.1.2.png[]

<<<

== Обзор веб-консоли.

=== Части веб-консоли.

image::3.2.1.png[]

Веб-консоль FBDataGuard содержит 7 вкладок (в левой части экрана, обычно они свернуты):

* _Dashboard_ -- это основная вкладка, где администратор может настроить HQbird FBDataGuard и просмотреть статусы сервера и баз данных.
* _Alerts_ -- содержит полный список оповещений, созданных FBDataGuard.
* _FTP active sessions_ -- отображать информацию об активных FTP-сессиях.
* _Registration_ -- информация о лицензии и регистрации/активации.
* _Graphs gallery_ -- графики производительности.
* _Performance_ -- настройки мониторинга производительности и отчеты о производительности.
* _Speed test_ -- тест скорости

=== Задачи

Веб-консоль предназначена для удобной настройки действий (называемых **"`задачи`"**), которые выполняет HQbird FBDataGuard.

Почти все задания FBDataGuard имеют две цели: первая — отслеживать некоторые значения и при необходимости выдавать оповещения, а вторая — сохранять исторические значения в журналах, чтобы позже можно было увидеть динамику важных параметров сервера Firebird и базы данных.

В этом разделе мы рассмотрим общую настройку параметров заданий, а не анализ собранных логов.

=== Виджет задачи

Общий подход следующий: каждое действие представляется "`виджетом`", который состоит из следующих частей:

.Элементы виджета веб-консоли FBDataGuard.
image::3.2.2.png[]

Статус -- обозначается цветным значком и названием.
Статус базы данных представляет собой сводку всех включенных заданий уровня сервера и статусов баз данных, и, соответственно, статус базы данных представляет собой сводку всех заданий уровня базы данных.

=== Типы статусов

*CRITICAL* означает проблемы, *OK* означает "`Все в порядке`", *WARNING* означает некоторые проблемы, требующие внимания, *MAJOR* означает серьезную проблему, *MINOR* – незначительная проблема, *MALFUNCTION* означает, что задание не удалось выполнить (что-то препятствует его выполнению), *NOT_AVAILABLE* означает, что задание недоступно в этой версии сервера или базы данных.

*OFF* означает, что задание не активно, *UNKNOWN* означает, что задание активно, но еще не запущено, поэтому фактические результаты неизвестны.

*Job name* -- имя задачи.

* image:3.2.3.png[] Кнопка конфигурации открывает диалог настройки, индивидуальный для каждого задачи.
* image:3.2.4.png[] Запускает задачу немедленно.
* image:3.2.5.png[] Resolved -- это ссылка для сброса статуса на UNKNOWN и забывания ошибок, которые были обнаружены ранее. Статус будет обновлен в соответствии с текущей ситуацией после следующего выполнения задания.

*Last run* показывает время после последнего запуска этого задания.

*Period/Schedule to run* показывает, как часто и когда будет запускаться задание.

*More>>* -- это ссылка, которая открывает виджет и показывает более подробную информацию и предлагаемые действия администратору для разрешения ситуации.

Все задания в FBDataGuard имеют настройки по умолчанию, которые очень близки к рекомендуемым значениям для 80% установок Firebird, поэтому после первоначальной настройки сервер и база данных будут защищены на довольно хорошем уровне по сравнению с установкой по умолчанию, однако мы рекомендуем дополнительную настройку для каждой задачи. В следующих разделах мы рассмотрим каждое задание и его настройку.

<<<

== Конфигурация сервера Firebird в FBDataGuard

=== Регистрация сервера Firebird

Чтобы зарегистрировать автоматически обнаруживаемый сервер, вам нужно нажать btn:[Add Firebird engine to monitoring>>] aа затем настроить параметры автоматического обнаружения.

[NOTE]
====
Примечание. Чтобы использовать доверенную аутентификацию Windows (по умолчанию она отключена), вам необходимо быть уверенным, что библиотеки `jaybird30.dll` и `fbclient.dll` (из соответствующей версии Firebird) находятся в доступных для поиска путях Windows.
====

При установке под Windows, если выбрана опция автоматической регистрации master/replica, то сервер будет добавлен автоматически. В этом случае этот шаг можно пропустить. Если выбран вариант автоматической регистрации реплики, то база данных будет добавлена дополнительно.

Давайте рассмотрим, что вы можете увидеть в диалоге Server (как правило, вам не нужно ничего менять):

Установлен в папке:: Папка установки Firebird
Папка Bin для Firebird:: Папка исполняемых файлов Firebird (для Firebird 3 и выше в Windows она совпадает с папкой установки)
Log:: расположение `firebird.log`
Configuration file:: расположение `firebird.conf`
Aliases:: расположение `aliases.conf` или для Firebird 3 и старше `databases.conf` ( *пожалуйста, измените его вручную, если необходимо* )
Хост:: имя или IP-адрес сервера, обычно `localhost`
Порт:: порт для Firebird, согласно настройке `firebird.conf`
Использовать trusted auth:: use trusted authentication, by default it is off
Логин:: имя пользователя (администратора), обычно это SYSDBA
Пароль:: пароль пользователя (пароль SYSDBA)
User for Services API:: имя пользователя для служб Firebird. Обычно совпадает с *Логин*.
Password for Services API user:: пароль пользователя для служб Firebird.
Server authentication plugin list:: список плагинов аутентификации.
Папка результатов:: Папка, в которой будут храниться резервные копии, статистика и собранные журналы.

.Регистрация сервера в HQbird FBDataGuard.
image::3.1.3.png[]

По умолчанию "`Папка результатов`" для сервера Firebird -- `${agent.default-directory}/${server.id}`, она соответствует `C:\HQbirdData` в случае установки по умолчанию.

Это может быть не очень удобно, поэтому мы рекомендуем указать выходной каталог FBDataGuard по более простому пути, обычно расположенному на диске, где предполагается хранить резервные копии, например `F:\myserverdata`.

После нажатия кнопки "`Сохранить`" FBDataGuard заполнит файлы конфигурации по умолчанию и немедленно начнет анализ `firebird.log`. Это может занять некоторое время (например, 1 минута для `firebird.log` размером 100 МБ). После этого вы увидите начальную веб-консоль с зарегистрированным сервером Firebird:

.HQbird FBDataGuard с зарегистрированным сервером Firebird.
image::3.1.4.png[]

FBDataGuard показывает оповещения и статусы контролируемых объектов: если все в порядке, он показывает зеленые знаки, в противном случае будут желтые или красные уведомления.

Ниже мы подробно рассмотрим каждый контролируемый объект и его настройки.

[NOTE]
====
Примечание: вы не можете удалить зарегистрированный сервер Firebird в веб-консоли FBDataGuard.
Единственный способ отменить регистрацию сервера -- удалить его файлы конфигурации.
В общем, нет смысла удалять зарегистрированный сервер, пока вы не захотите полностью удалить FBDataGuard.
====

=== Сервер: Active server

Сервер: Виджет Active server отображает сводный статус всех заданий уровня сервера и статусы отслеживаемых баз данных.

image::3.2.6.png[]

**Сервер: Active server** также указывает, работает ли Firebird в данный момент или нет, и показывает подробную версию Firebird и HQbird.

Если вы нажмете ссылку *Настройка*, то увидите тот же диалог, который мы использовали для регистрации экземпляра Firebird в FBDataGuard, и теперь его можно использовать для изменения свойств экземпляра Firebird:

image::3.2.7.png[]

В общем, нет необходимости редактировать данные сервера Firebird после регистрации, пока вы не переустановите Firebird -- но в этом случае мы рекомендуем также переустановить HQBird.

=== Сервер: Лог репликации

image::3.2.11.png[]

FBDataGuard проверяет `replication.log` на наличие ошибок.
В случае ошибки он отправляет соответствующее предупреждение (по электронной почте) администратору.

Чтобы включить это задание, установите флажок "`Включить`".

image::3.2.12.png[]

* Период проверки, в минутах -- как часто проверять файл `replication.log` на наличие изменений.
* Размер для переименования, в байтах -- если `replication.log` превысит значение, он будет переименован в соответствии с шаблоном даты и времени.
* Шаблон имени для переименования -- как переименовать `replication.log`
* Keep N rolled old log files -- сколько ошибок будет храниться в списке последних ошибок.


=== Сервер: Лог Firebird

image::3.2.13.png[]

Задание "`Лог Firebird`" периодически проверяет `firebird.log`, и если обнаруживает, что файл был изменен, начинается анализ журнала. Встроенный аналитический механизм проверяет каждую запись в файле `firebird.log` и классифицирует их по нескольким категориям с разными уровнями серьезности. В зависимости от серьезности сообщений назначается статус задания и генерируются соответствующие оповещения.

После того, как администратор просмотрит ошибки и предупреждения (и выполнит необходимые действия для устранения причины ошибки), ему необходимо нажать на ссылку *"`Исправлено`"*, и FBDataGuard забудет старые сообщения об ошибках в `firebird.log`.

В диалоге настройки "`Лог Firebird`" вы можете включить/отключить это задание и установить период проверки (в минутах).

image::3.2.14.png[]

Также это задание отслеживает размер `firebird.log`, и если его размер превышает "Размер для переименования", FBDataGuard разделит `firebird.log` и переименует его в соответствии с шаблоном даты и времени.

=== Сервер: Временные файлы

image::3.2.15.png[]

Задание "`Server: Temp files`" полезно для обнаружения и решения проблем с производительностью базы данных Firebird.

При выполнении SQL-запросов Firebird сохраняет промежуточные результаты сортировки и объединения потоков данных во временных файлах, которые размещаются в папках `TEMP`. FBDataGuard показывает в виджете "`Сервер: Временные файлы`" информацию о количестве и размере временных файлов.

FBDataGuard распознает расположение папок `TEMP` и отслеживает количество и размер временных файлов. Нехватка места может привести к проблемам с производительностью или более серьезным ошибкам, слишком большое количество (или слишком большие) временных файлов может указывать на проблемы с качеством SQL-запросов.

image::3.2.16.png[]

Используя диалог конфигурации, вы можете включить/отключить это задание, установить период проверки и пороговые значения для максимального размера временных файлов (размера всех файлов) и количества.

Если вы видите, что размер временных файлов слишком велик и на сервере достаточно оперативной памяти, увеличьте параметр `TempCacheLimit` в `firebird.conf`, чтобы все временные таблицы поместились в оперативную память.

Кроме того, HQbird проверяет другие временные файлы, используемые Firebird -- если вы видите экстремальные значения (несколько ГБайт) для трассировки или мониторинга, хорошей идеей будет проверить папку `FIREBIRD_TMP` на наличие устаревших файлов (со старыми метками времени модификации). Обратите внимание: снимок экрана ниже не является настоящим предупреждением (т. е. значение ОК), он был создан для демонстрации вывода в случае больших временных файлов.

image::3.2.17.png[]

=== Сервер: Размер каталога Firebird

Задание "`Размер каталога Firebird`"  отслеживает размер, занимаемый установкой Firebird. Оно включен по умолчанию.

image::3.2.18.png[]

Это задание предотвращает несколько угроз: проблемы неправильного администрирования при создании томов базы данных или внешних таблиц в папке `%Firebird%\Bin`, очень большой файл `firebird.log`, который может исчерпать все места на диске с установленным Firebird, и некоторые другие проблемы.

Также это задание отслеживает и анализирует информацию, собранную всеми заданиями, связанными со свободным пространством (включая задания на уровне базы данных). На рисунке ниже вы можете увидеть краткое представление анализа пространства для всех дисков, на которых хранятся базы данных Firebird и резервные копии.

С помощью диалога конфигурации вы можете включить/отключить это задание, установить период проверки и пороговые значения размера папки сервера.

image::3.2.19.png[]

По умолчанию мы используем 1 Гб -- это стандартная настройка для установки Firebird.

Если размер вашего Firebird больше, рассмотрите возможность очистки старых журналов и других нежелательных артефактов или увеличьте параметр *Максимум занято* (в байтах), чтобы предотвратить ложные оповещения.

**Примечание для пользователей Linux**: если вы видите красное предупреждение с противоречивой информации о свободном пространстве, добавьте каталоги с базой данных и резервными копиями в виджете "`Место на диске`":

image::3.2.20.png[]

Вы можете получить представление о том, где находится ваша база данных и резервная копия, с помощью команды `df -h`.

=== Сервер: Размер каталога данных HQbird

image::3.2.8.png[]

Мониторинг "`Размер каталога данных HQbird`"  предназначен для наблюдения за пространством, занимаемым отчетами, журналами, статистикой, хранилищем метаданных и другими данными, собранными и сгенерированными HQbird -- по умолчанию это папка `C:\HQbirdData\output`.

Для баз данных, находящихся без присмотра в течение длительного времени (1-2 года), возможно, что журналы FBDataGuard займут слишком много места, а нехватка места может привести к сбою базы данных. Чтобы наверняка это предотвратить, задание "`Размер каталога данных HQbird`" отслеживает занятое место.

По умолчанию задание "`Размер каталога данных HQbird`" включено.

Кроме того, если кто-то проигнорировал рекомендации по размещению папок резервных копий в определенных местах, вполне возможно, что резервная копия базы данных будет создана внутри папки Агента. В этом случае вы сразу увидите CRITICAL статус -- FBDataGuard распознает это и предупредит вас о неправильной конфигурации.

Это задание полезно для связок FBDataGuard и сторонних приложений.

В диалоге конфигурации вы можете включить/отключить это задание, установить период проверки (по умолчанию 10 минут) и установить пороговые значения для оповещений.

Пороговые значения могут быть установлены в % от максимального размера, занимаемого журналом, или с указанием явного размера в байтах.

FBDataGuard проверяет оба значения и выдает предупреждение для первого порога. Если вы хотите установить только %, вам нужно установить -1 в качестве значения «Максимум занято, байт».

image::3.2.10.png[]


== Конфигурация базы данных в FBDataGuard

=== Регистрация базы данных Firebird

Список баз данных, отслеживаемых FBDataGuard, находится в разделе "`Базы данных`".

image::3.1.5-0.png[]

Чтобы зарегистрировать базу данных в FBDataGuard, необходимо нажать на символ "`Плюс`" в правом углу "`Базы данных`" (появится подсказка "`Добавить БД`") и заполнить следующую форму:

.Добавление базы данных в мониторинг.
image::3.1.5.png[]

* "`*Название БД*`"  предназначен для вашего удобства и используется для ссылки на эту базу данных в оповещениях и сообщениях электронной почты.
* "`*Алиас БД*`" -- это псевдоним базы данных из `aliases.conf` или `databases.conf`. Если вы укажете и "`Алиас БД`", и "`Путь к БД`", то будет использоваться "`Алиас БД`".
* "`*Путь к базе данных*`" -- это локальный путь к базе данных (помните, что FBDataGuard должен работать на одном компьютере с Firebird). Если вы помещаете базу данных на внешний диск, может возникнуть ошибка "`File... has unknown partition`". Чтобы это исправить, вам нужно нажать "`Настроить`" в виджете "`Сервер`" и нажать "`Сохранить`", чтобы FBDataGuard перечитал разделы.
* "`*Папка логов и бэкапов*`" -- это папка, в которой FBDataGuard будет хранить резервные копии, журналы и статистику для этой базы данных. Если вы не выбрали папку HQbirdData во время установки и не указали выходную папку для сервера, рекомендуется указать "`Папка логов и бэкапов`" в каком-то явном месте, например `F:\mydatabasedata`.
* "`*Enable advanced monitoring*`" -- см. <<_hqbird_advanced_monitor_viewer>>


[NOTE]
====
Вы можете указать точные абсолютные местоположения для резервных копий и статистики позже в соответствующих диалоговых окнах.
====

Список доступных для регистрации баз данных или их псевдонимов вы можете просмотреть, нажав на ссылку **Показать список базы данных**.

.Available database aliases.
image::3.1.5-1.png[]

После регистрации FBDataGuard заполнит конфигурацию базы данных значениями по умолчанию, а затем отобразит веб-консоль с зарегистрированной базой данных:

.HQbird FBDataGuard веб консоль после регистрации базы данных.
image::3.1.6.png[]

Вы можете изменить настройки базы данных позже; теперь приступим к настройке оповещений.

=== База данных: Общие настройки

FBDataGuard может контролировать несколько баз данных на одном сервере (до 80 баз данных). Для каждой базы данных создается отдельный виджет. Вверху виджета отображается состояние базы данных, никнейм базы данных (задается при добавлении базы данных и может быть изменен). Также виджет базы данных показывает полный путь к базе данных, ее размер, состояние резервных копий и количество подключенных в данный момент пользователей.

image::3.2.21.png[]

Используя диалог конфигурации, вы можете установить имя базы данных, путь к базе данных и папку вывода для базы данных (для хранения журналов и результатов заданий).

image::3.2.22.png[]

FBDataGuard проверяет корректность пути к базе данных и не позволяет указать неправильный путь.

Также для HQbird в виджете базы данных можно увидеть статус репликации и настроить репликацию, нажав на иконку. Подробности читайте в разделе конфигурации репликации.

Виджет базы данных в HQbird также показывает статус шифрования базы данных.

=== База данных: Транзакции

Задание "`База данных: Транзакции`" предназначено для регистрации активности транзакций. Оно отслеживает два важных интервала: разницу между Oldest Active Transaction и Next transaction, а также разрыв между Oldest Snapshot и Oldest Interesting.

Если эти интервалы выходят за рамки указанного порога, то это означает проблемы с управлением транзакциями.

image::3.2.23.png[]

Эти журналы можно проанализировать, чтобы получить полезную информацию о производительности базы данных и качестве приложений (дополнительную информацию см. здесь http://ib-aid.com/en/articles/ibanalyst-what-you-can-see-at-summary-view/[]).

Это задание также отслеживает ограничение реализации в Firebird: максимальное количество транзакций в версиях Firebird до 3.0 должно быть меньше 2^31^-1. При приближении к этому значению необходимо выполнить резервное копирование и восстановление базы данных. Оно выдаст предупреждение, если номер транзакции будет близок к ограничениям. 

Также динамика транзакций отображается на вкладке "`Graphs gallery`":

image::3.2.24.png[]

=== База данных: Lockprint

Задание "`Lockprint`" отслеживает информацию из таблицы блокировок Firebird. Это очень важно для архитектур Classic/SuperClassic и полезно для SuperServer.

Таблица блокировок -- это внутренний механизм Firebird для организации доступа к объектам внутри движка Firebird. HQbird отслеживает важные параметры таблицы блокировок:

image::3.2.25.png[]


* **Период проверки, минуты** -- как часто HQbird анализирует таблицу блокировок. 3 минуты -- оптимальный интервал.
* *Лимит изменения Deadlock Scans* -- сканирование взаимоблокировок -- это процесс, запускаемый движком Firebird в случае длительной задержки ответа от одного из потоков. Если количество взаимоблокировок велико, это означает, что Firebird сильно загружен. Значение накапливается с момента запуска движка Firebird. Значение по умолчанию довольно велико -- 12345, поэтому его превышение означает низкую производительность базы данных.
* *Лимит Deadlocks* -- если движок Firebird обнаруживает истинную взаимоблокировку во время сканирования взаимоблокировок, он увеличивает это значение. Обратите внимание: настоящие взаимоблокировки случаются очень редко. Не путайте их с конфликтами транзакций  ("`deadlock. Lock conflict on nowait transaction`" и другое).
* *Лимит Mutex Wait*. Mutex Wait -- это параметр таблицы блокировок, который неявно указывает на конфликты ресурсов. Чем выше время ожидания мьютекса, тем выше конкуренция внутри движка за ресурсы. По умолчанию порог ожидания мьютекса установлен на 18%, но это значение не является универсальным для всех баз данных. Хороший подход -- следить за значениями мьютексов в течение 1–2 недель, а затем устанавливать самое высокое значение, наблюдаемое за этот период. График ожидания мьютекса доступен в галерее Mutex Wait.
+
image::3.2.26.png[]
* **Проверять значение Hash Slots**. В заголовке таблицы блокировок есть параметр "`Hash lengths (min/avg/max): 0/0/4`", он отображает длины цепочек коллизий в хеш-таблице блокировок. Важно сохранять эти значения как можно меньшими, поэтому HQbird отслеживает их и подсказывает, как улучшить ситуацию, если длина цепочки коллизий в хеш таблице больше, чем указано в этом задании.
* *Лимит активных соединений* "`Owners`" -- количество подключений, установленных к указанной базе данных. Фактически, это самый быстрый способ получить фактическое количество подключений к базе данных с минимальной нагрузкой на базу данных -- другие способы, такие как запрос к `MON$ATTACHMENTS` или `isc_tpb_database`, имеют различные недостатки. Ограничение здесь должно быть установлено в соответствии с фактическим пиковым количеством подключений. Например, если вы уверены, что пиковое количество подключений к вашей базе данных составляет 500, установите в качестве лимита 550, и если в какой-то момент нагрузка увеличится, вы не пропустите этот момент.
+
image::3.2.27.png[]
* **Лимит закрытых соединений**. "`Free owners`" -- это соотношение между пиковым количеством соединений и текущим количеством соединений. Если вы видите `Free owners = 0`,  то это означает, что количество подключений постоянно растет с момента запуска Firebird. Если вы видите большое количество Free owners, то это может означать, что многие соединения недавно были отключены.
* **Размер таблицы блокировок**. Размер таблицы блокировок является неявным индикатором нагрузки на систему. Обычно размер таблицы блокировок должен быть стабильным. Кроме того, рекомендуется установить первоначальный размер таблицы блокировок равным значению, которое она имеет после некоторого периода активной работы -- хотя таблица блокировок увеличивается по требованию, процесс перераспределения является тяжелой операцией и может привести к микрозависаниям в ответах базы данных. График таблицы блокировки полезен для определения правильного начального значения.
+
image::3.2.28.png[]
* **Очередь к таблице блокировок**. Очередь таблиц блокировки не имеет явного порога в задании Lockprint, но ее значения собираются и отображаются в "`Graphs gallery`". Очередь таблицы блокировок является индикатором общей загрузки.

image::3.2.29.png[]


=== База данных: Пересчет статистики индексов

"`База данных: Пересчет статистики индексов`" -- важная задача, которая помогает поддерживать производительность индексов на оптимальном уровне, а также выполняет дополнительную проверку работоспособности базы данных.

"`Пересчет статистики индексов`"  позволяет запустить пересчет значений селективности индексов. Во время этой процедуры Firebird быстро просматривает листовые страницы индексов и обновляет статистику избирательности. Посещая эти страницы, Firebird также проверяет их целостность, и если индекс поврежден, то будет выдано предупреждение.

Кроме того, это задание проверяет, активны ли все индексы в базе данных. Неактивные или неактивированные индексы обычно указывают на повреждения и приводят к снижению производительности.

По умолчанию это задание отключено, но мы рекомендуем включить его после тщательного выбора показателей для пересчета.

В этом задании есть три режима: AUTO, ALL, SELECTED.

ALL -- режим, в котором будут проверены все индексы.

AUTO -- режим по умолчанию. Он очень похож на ALL, но также проверяет размер базы данных и не трогает индексы, если база данных больше 3,6 ГБ.

image::3.2.30.png[]

SELECTED -- рекомендуемый режим. Это позволяет выбрать индексы, которые следует пересчитывать, или те, которых следует избегать.

Для включения индексов в список пересчитываемых необходимо указать названия индексов (через запятую), а для исключения – выполнить то же самое в соответствующем поле.

Как вы можете видеть на снимке экрана диалогового окна конфигурации, здесь есть поля для включения/отключения задания, установки режима обновления, а также включения или исключения индексов. "`Размер БД для переключения, байты`" -- устанавливает предел, при котором работает режим AUTO. Переключатель "`Проверять активность индексов`" должен быть включен всегда, пока вы не проведете специальные манипуляции с неактивными индексами.


[[_hqbird_config_verified_backup]]
=== База данных: Бэкап

"`База данных: Бэкап`" -- одно из ключевых заданий, гарантирующих сохранность данных, хранящихся в защищенной базе данных. При разработке HQbird мы учитывали определенный сценарий восстановления, и этот сценарий подразумевает, что ключевой целью защиты базы данных является минимизация потенциальных потерь данных. Если у нас есть работоспособная резервная копия, восстановление может быть сконцентрировано на сохранении самых последних данных (только что введенных в базу данных), и это значительно сокращает время общего простоя.

Как вы увидите ниже, "`База данных: Бэкап`" -- это не просто оболочка для стандартных функций `gbak` и планировщика, это умное задание, в котором есть множество встроенных правил для предотвращения проблем с резервным копированием и предоставления подходящего интерфейса для управление резервными копиями.

[IMPORTANT]
====
Задание "`База данных: Бэкап`" отключено **по умолчанию**, но мы настоятельно рекомендуем изменить его настройки сразу после установки HQbird.
====

image::3.2.31.png[]

Первоначально задание "`База данных: Бэкап`" отображается как ОК, хотя попытка резервного копирования не выполнялась. В этом случае ОК означает, что резервное копирование как минимум запланировано.

Также это задание распознает файлы по шаблону имен (см. ниже информацию о конфигурации) и показывает общее количество резервных копий.

После завершения резервного копирования информация в виджете изменится: будет показано время создания последней успешной резервной копии, а также время, затраченное на фактическое выполнение резервного копирования (всего 1 минута 12 секунд на скриншоте с примером).

image::3.2.32.png[]

Кроме того, подробное оповещение будет отправлено на вашу электронную почту и/или в HQbird Control Center:

image::3.2.33.png[]

"`База данных: Бэкап`"  проверяет свободное место на диске с местом назначения резервной копии, и если обнаруживает, что на диске недостаточно свободного места, будет отправлено CRITICAL предупреждение, а текущая резервная копия будет отменена (при необходимости).

[NOTE]
====
Будьте осторожны: по умолчанию время резервного копирования установлено **23-00 Понедельник-Воскресенье*.

По умолчанию резервные копии базы данных будут храниться в выходной папке, указанной вами на этапе установки! По умолчанию это `C:\HQbirdData\output\...`

Очень важно внимательно просмотреть настройки резервного копирования базы данных и настроить их в соответствии с локальной конфигурацией!
====

Рассмотрим диалог настройки резервного копирования подробнее:

* *"`Включить`"* -- включает или отключает задание резервного копирования.
* В поле *"`Расписание`"* вы можете установить время, когда должно запускаться резервное копирование. Планировщик использует выражение CRON (см. <<_hqbird_config_cron_expr,Выражения CRON>>).
* *"`Создавать бакапы в`"* указывает папку для хранения резервных копий. Эта папка должна находиться на том же компьютере, где находится база данных. По умолчанию она расположен в каталоге базы данных по умолчанию. Обычно рекомендуется указать явный путь к папкам с резервными копиями.
* *"`Количество бэкапов`"* указывает, сколько предыдущих резервных копий должно храниться. FBDataGuard хранит резервные копии в револьверном порядке: когда будет достигнуто максимальное количество (т. е. будет создано 5 резервных копий), FBDataGuard удалит самую старую резервную копию и создаст новую резервную копию. В сочетании с выражениями CRON это дает мощную возможность создавать необходимую историю резервных копий.
* *"`Шаблон имени бэкапа`"* определяет, как будут именоваться файлы резервных копий. Кроме того этот шаблон имени позволяет FBDataGuard распознавать старые резервные копии с тем же шаблоном имени.
* *"`Расширение бэкапа`"* -- по умолчанию `.fbk`.
* *"`Сжимать бэкапы`"* указывает, должен ли FBDataGuard архивировать резервные копии после обычного резервного копирования Firebird. По умолчанию эта опция включена, но вы должны знать, что FBDataGuard будет архивировать файлы резервных копий размером менее *100 ГБ*. После достижения этого размера сжатие резервной копии будет автоматически отключено. Мы рекомендуем включать эту функцию только для небольших баз данных.
* *"`Проверить восстановление`"* -- важная опция. Если она включена, то FBDataGuard выполнит тестовое восстановление новой резервной копии, чтобы проверить её. Это гарантирует качество созданной резервной копии и уведомляет администратора в случае возникновения проблем с тестовым восстановлением.
* *"`Удалять тестовый рестор`"* указывает, должен ли FBDataGuard удалить восстановленную базу данных. По умолчанию она ВЫКЛЮЧЕНА, поэтому вы можете ВКЛЮЧИТЬ её, но вам нужно внимательно подумать: действительно ли вам нужно сохранять копию тестовой восстановленной базы данных. При каждом тестовом восстановлении эта копия будет перезаписана.
* *"`Использовать N CPU ядер для бэкапа`"* -- эта функция позволяет выполнять резервное копирование базы данных и восстановление тестовой базы данных с использованием нескольких ядер ЦП, поэтому резервное копирование может выполняться в 3-5 раз быстрее. Мы рекомендуем выделить половину ядер вашего процессора.
* *"`Отчет об успешных бэкапах`"* -- по умолчанию отключено, но настоятельно рекомендуется включить её и начать получать уведомления о успешном резервном копировании. Эта функция будет использовать настройки электронной почты из системы оповещений.

image::3.2.34.png[]

Если вы нажмете кнопку btn:[Раскрыть>>], то появятся расширенные параметры резервного копирования:

image::3.2.35.png[]

* *"`Backup (gbak) timeout, minutes`"* -- максимальное время для выполнения только операции резервного копирования (`gbak -b`), в противном случае будет сгенерировано предупреждение.
* *"`Restore (gbak) timeout, minutes`"* -- максимальное время для завершения тестовой операции восстановления.
* *"`Хранить бэкапы в`"* -- если вам нужно сделать резервные копии в одну папку, а затем переместить созданную резервную копию в другую папку (например, для долговременного хранения), вы можете изменить значение этого параметра с `${backup-directory}` на папку где вы их будете хранить. Файлы резервных копий в обоих местах отслеживаются HQbird FBDataGuard и включаются в счетчик резервных копий, отображаемый в виджете.
* Переключатель *"`Копировать бэкапы`"* и путь. . Если у вас есть сетевое расположение или подключенный USB-накопитель для хранения базы данных, на котором вы хотите хранить копию резервной копии (помимо обычных резервных копий), FBDataGuard может скопировать туда последнюю резервную копию: просто включите переключатель: просто включите переключатель "`Копировать бэкапы`" и задайте путь. Скопированные файлы не отслеживаются и не включаются в число резервных файлов, отображаемых в виджете.
* Переключатель *"`Выполнить скрипт`"* и путь к скрипту. После завершения общей процедуры резервного копирования можно указать собственный сценарий или исполняемый файл. Скрипт получает в качестве параметра путь к новой резервной копии базы данных.
* *"`Optional path to gbak executable`"* -- можно указать другой не стандартный `gbak`.
* *"`Backups option for gbak`"* -- если вам нужно добавить какие-то конкретные опции резервного копирования, добавьте их сюда.
* *"`Restore options for gbak`"* -- если вам нужно добавить какие-то конкретные опции тестового восстановления, добавьте их сюда.


[TIP]
====
Если вы отслеживаете более одной базы данных, настоятельно рекомендуется разделить время выполнения восстановления.
====

==== Важное замечание: резервное копирование на сетевое хранилище

Обратите внимание, что для создания и копирования резервной копии в сетевые хранилища службы Firebird и FBDataGuard должны быть запущены под учетной записью с достаточными правами. По умолчанию Firebird и FBDataGuard запускаются под учетной записью LocalSystem, у которой нет прав доступа к сетевому расположению.

image::3.2.36.png[]

Итак, чтобы хранить резервные копии Firebird в сетевом расположении в Windows, запустите апплет "`Службы`"  (`services.msc`) и на вкладке "`Вход в систему`"  измените "`С учётной записью`" на соответствующую учетную запись (подойдет Администратор домена).

В Linux -- добавьте необходимые права для пользователя `firebird`.

[[_hqbird_config_incremental_backup]]
=== База данных: Инкрементальный бэкап

Инкрементальный бэкап -- это задание по планированию и управлению инкрементным резервным копированием в Firebird.

Обратите внимание, что мы рекомендуем использовать инкрементное резервное копирование только в сочетании с проверяемым резервным копированием, поскольку при инкрементальном резервном копировании происходит копирование страниц базы данных, измененных с момента последнего резервного копирования (в случае многоуровневого инкрементного резервного копирования).

HQbird FBDataGuard реализует 2 типа многоуровневого инкрементного резервного копирования: Простое и Расширенное инкрементное копирование, а также полное инкрементное копирование (см. <<_hqbird_config_db_dump_backup>>).

Многоуровневое резервное копирование в Firebird должно выполнять следующие шаги:

. Создаётся начальная резервная копия (уровень 0), которая по сути является копией базы данных на момент запуска резервного копирования, и помечает её с помощью GUID резервной копии.
. Поскольку Firebird при каждом изменении помечает каждую страницу данных определенным идентификатором, то можно найти страницы данных, изменившиеся с момента предыдущего резервного копирования, и скопировать только их, чтобы сформировать резервную копию уровня 1.
. Возможно создание нескольких уровней резервных копий -- например, начальная резервная копия (полная копия, уровень 0) создается каждую неделю, каждый день мы создаем копию уровня 1 (отличия от уровня 0), и каждый час мы создаем резервные копии уровня 2 (отличия от ежедневного уровня 1).

Инкрементальное резервное копирование с простым расписанием позволяет планировать 3 уровня резервного копирования: еженедельно, ежедневно и ежечасно.

Вы можете увидеть сводную информацию для такой конфигурации инкрементного резервного копирования на следующем снимке экрана ее виджета:

image::3.2.37.png[]

Чтобы настроить простое инкрементное резервное копирование, нажмите "`шестеренку`" настроек виджета и выберите "`Простая схема бэкапа`" (выбрано по умолчанию). Появится следующий диалог:

image::3.2.38.png[]

В этом диалоговом окне есть 4 основные области, давайте рассмотрим их одну за другой.

Верхняя область отведена под общие настройки инкрементального резервного копирования – они одинаковы для простого и продвинутой схемой бэкапа:

image::3.2.39.png[]

*Макс. длительность (сек)* -- ограничение максимальной продолжительности процесса резервного копирования, по умолчанию составляет 1 день (86400 секунд).

*Минимальное свободное место (байты)* -- минимальный размер свободного места на диске для предотвращения запуска резервного копирования, по умолчанию ~9Мб

**Папка бэкапа** -- где будет храниться инкрементальная резервная копия выбранной базы данных. Необходимо хранить инкрементные резервные копии каждой базы данных отдельно от резервных копий других баз данных: т. е. в отдельной папке для каждой базы данных.

Необходимо указать папку резервных копий с достаточным количеством свободного места на диске для хранения резервных копий всех уровней!

**Имя журнала** -- имя файла, который содержит информацию о файлах инкрементных резервных копий только для внутреннего использования.

*Путь к nbackup.exe* -- можно указать другой инструмент nbackup, кроме стандартного `nbackup` (не рекомендуется).

*Шаблон имени бэкапа* -- шаблон для файлов инкрементного резервного копирования (менять его не нужно).

*Опции* -- дополнительные параметры для инструмента командной строки nbackup (менять их не нужно).

*Не проверять существование бэкапов* -- этот параметр следует выбрать, если вы планируете удалить или создать дополнительные инкрементальные резервные копии в другом месте.

*Не проверять цепочку GUID* -- эту опцию следует выбрать, если вы хотите пропустить проверку существования предыдущих уровней инкрементных резервных копий.

*Сразу же создавать пропущенные уровни инкрементального бэкапа* -- по умолчанию эта опция включена. Это означает, что если вы запланировали начальный момент запуска резервного копирования уровня 1 раньше, чем начальный момент запуска резервного копирования уровня 0, DataGuard автоматически это исправит и создаст резервную копию уровня 0 непосредственно перед уровнем 1. Следующие резервные копии уровня 0 будут выполнены по обычному графику.

*Высылать уведомления для уровней 0,1,2* -- включите эту опцию, чтобы получать уведомления об инкрементальных резервных копиях (__настоятельно рекомендуется__!)

После настройки основного набора параметров необходимо настроить само расписание. Как вы можете видеть на скриншоте ниже, вам необходимо указать день недели и время для резервного копирования уровня 0 (еженедельного), дни недели и время для запуска резервного копирования уровня 1 (ежедневного), а также часы и минуты для резервной копии уровня 3 (ежечасного).

Для каждого уровня резервного копирования вы можете указать, сколько файлов хранить в истории.

image::3.2.40.png[]

По умолчанию настроено сохранение 5 резервных копий еженедельно, 7 ежедневных и 24-часовых резервных копий.

Однако иногда требуется более гибкое расписание, для этого в виджете "`Инкрементальный бэкап`" имеется "`Продвинутая схема бэкапа`":

image::3.2.41.png[]

Как видите, верхняя часть экрана конфигурации такая же, как и в простом расписании, а разница заключается в способе планирования уровней резервного копирования.

Продвинутая схема бэкапа позволяет настроить до 5 уровней резервного копирования и гибко планировать их <<_hqbird_config_cron_expr>>.

Например, вы можете настроить её на создание полной резервной копии (уровень 0) каждые 3 месяца, копии уровня 1 каждый месяц, уровня 2 -- каждую неделю, уровня 3 -- каждый день и уровня 4 -- каждый час.

[TIP]
====
Если вы отслеживаете более одной базы данных, настоятельно рекомендуется разделить время выполнения резервных копий.
====

[[_hqbird_config_db_dump_backup]]
=== База данных: Полный Инкрементальный Бэкап

Это задание также использует функцию nbackup в Firebird, но, в отличие от многоуровневого резервного копирования, оно всегда выполняет полную копию (уровень 0) базы данных. Такая работа полезна для быстрого создания копии рабочей базы данных.

Конфигурация "`База данных: Полный Инкрементальный Бэкап`" тривиальна:

image::3.2.42.png[]

Вам просто нужно настроить, когда и куда DataGuard должен копировать полную копию (инкрементная резервная копия уровня 0) и сколько копий он должен хранить.

=== Database: Delta

If you are using incremental backups (or Dump backup), this job is critically important. It watches for delta-files lifetime and size, and warns if something goes wrong. Forgotten delta-files are the often reason of corruptions and significant losses of data.

This jobs finds all delta files associated with database and check their age and size. If one of these parameters exceeds thresholds "`Maximum delta
size`" or "`Maximum delta age`", administrator will receive the alert and database status will be set to CRITICAL.

[NOTE]
====
If delta file of the protected database was corrupted, it is possible to extract data from it using metadata from the original database file or repository from "`Low-level metadata backup`" job.
====

image::3.2.56.png[]

=== Database: RestoreDB

One of the often tasks of the database administrators is restoring database from the backup. There could be many reason to do restore, the most popular reasons are regular check of the stored backups and necessity to have fresh restored copy for quick rollback. HQbird FBDataGuard can automate restoring of backups (which were created with gbak or Database: Verified backup) with *Database: RestoreDB* job. Let's consider the options and parameters of this job.

image::3.2.43.png[]

By default, restore is disabled – and, since restoring can be long and resource-consuming job, please plan when to restore carefully.

The database can be restored from different types of backups. To specify which types of backups are used during recovery, use the *Restore Source* switch.

Below you can see the configuration dialog for **Database: RestoreDB** in **nbackup** mode:

image::3.2.44-0.png[]

In **gbak** mode, the configuration dialog for **Database: RestoreDB** looks like this:

image::3.2.44.png[]

* "`*Scheduled*`" field contains <<_hqbird_config_cron_expr,CRON expression>> which defines when to run restore.
* "`*Get backup from folder*`" - specify the location of backup file(s) to be restored. If you are restoring backups at the same computer where they have been created, specify the same folder as it is in Database: Verified backup job. If you are restoring backups from the another computer, specify the folder where those backups are located.
* "`*Take backup not older than, hours*`" - this parameter specifies the maximum age of backup to be restored. If the latest backup file will be older than specified number of hours, RestoreDB job will send the alert with warning that backup is too old. This is useful for automatic checking of backups created on the remote computer.
* "`*Restore source*`" specifies what types of backups will be used to restore the database .
* "`*Datatime pattern for nbackup*`" contains the template for backup names made with nbackup.
It should be the same as *Backup name pattern* see <<_hqbird_config_incremental_backup,Database: Incremental Backup>>.
* "`*Template for gbak backup file name*`" contains the template for backup names. It should be the same as *Backup name pattern* see <<_hqbird_config_verified_backup, Verified backup>>.
* "`*Backup gbak file extension*`" - by default it is fbk
* "`*Use NN CPU cores to restore*`" - only available in gbak mode.
* "`*Restore options*`" - only available in gbak mode.
* "`*Restore to directory*`" - folder where FBDataGuard will restore backups.
* "`*Restore with filename*`" - template for the restored database file. By default it contains the following parts
+
** ${db.id}_{0,date, yyyyMMdd_HH-mm}_testrestore.fdb
** Db.id – internal identifier of the database (GUID)
** 0,date, yyyyMMdd_HH-mm – timestamp
** testrestore.fdb – description (You can set there any filename you need).
* "`*When existing database found*`" - if FBDataGuard will encounter a file with the same name as restored database in the destination folder, by default it will rename the existing file. If you want to replace old restored file with new one, choose "`Replace existing file`".
* "`*Append suffix to filename when rename*`" - if you have chosen "`Rename existing file`", this suffix will be used to rename it. If you have chosen "`Replace existing file`", this suffix also will be used to rename, but after that the old file will be deleted.
* "`*Execute command after restore*`" - in this field you can specify an optional path to the command file or another utility to be started after the restore. There will be 2 parameters passed: the first is the path to the backup which was just restored, and the second is the path to the restored file.
* "`*Restore timeout, minutes*`" - here you can set the time limit for restore operation. If this limit will be exceeded, the warning will be sent, saying that restore takes too long.
* "`*Check available space before restore (bytes)*`" - here you can set the limit for the minimal free space in the restore destination – if there is less free space than specified, restore will not start, and associated warning will be sent.
* "`*Notify on successful restore*`" - send email about successful restore (by default it is off, only alerts about problems will be sent).


[[_hqbird_config_cloud_backup]]
=== Database: Transfer Replication Segments

The purpose of "Transfer Replication Segments" job is to send replication segments produced by async replication from master to replica server. In the case of distributed environment of the asynchronous replication, when the network connection between master and replica server is unstable, or with high latency, or when servers are in the different geographical regions, the best way to transfer replication segments will be through FTP or FTP over SSH.

Below we will consider how to setup Cloud Backup for this task.

First, the asynchronous replication master should be configured to save replication segments into the some local folder – by default, it will be `${db.path}.LogArch` – as it is shown in the example below:

image::3.2.45.png[]


.Transfer Replication Segments configuration
image::3.2.46.png[]

Then we can setup *Transfer Replication Segments* job to monitor this folder for the new replication segments and upload them to the remote FTP server.

As you can see at the screenshot above, Cloud backup job checks folder, specified in "`*Monitor this folder*`" with an interval, specified in "`*Check period, seconds*`".

Please note – Cloud Backup sends files in the order of their names, not dates.

To check that transferred files are valid replication segments, and to support automatic re-initialization of the replica databases, the checkmark "`*Enable/disable replication cloud backup job*`" must be enabled.

By default, Cloud Backup compresses and encrypts replication segments before send them. The default password is "`*zipmasterkey*`" (without quotes), which can be specified in the field "`*Compress with optional password*`". FBDataGuard creates the compressed and encrypted copy of the replication segment and upload it to the specified target server.

To disable packing and encryption, uncheck the "`*Compress with optional password*`" checkmark.

==== FTP/FTPS/FTPS over SSH

There are several types of target servers: FTP, FTP over SSL/TLS, FTP over SSH. When you select the necessary type, dialog shows mandatory fields to be completed.

You can select up to 5 simultaneous remote servers to upload backups. Below you can see the configuration dialog for FTP.

image::3.2.47.png[]


[NOTE]
====
If you don't have FTP installed on the target server with Windows, install Filezilla – it is very popular fast and lightweight FTP-server for Windows.
====

[NOTE]
====
Replication segments will be uploaded to the subdirectory specified in the "`Upload to folder`". By default, this is `/dababase0/${db.id}`, where `db.id` is the identifier of the database inside the DataGuard. The replica about this `db.id` does not know anything, so you need to register it manually in "`Unpack to directory`" (see <<_hqbird_config_cloud_backup_receiver,File  Receiver>>).
====

===== FTP over SSL/TLS

image::3.2.48.png[]

In order to send files to FTPS, it is necessary to create jks storage with private key file, and specify path to it in the field "`Key store file`" and password for it in "`Key store password`".

See details and example how to create jks file and password here: http://xacmlinfo.org/2014/06/13/how-to-keystore-creating-jks-file-from-existing-private-key-and-certificate/

The last part of parameters in Cloud Backup dialog allows controlling the behavior of Cloud backup.

* *Delete local prepared copy* – by default it is On. This parameter specify that Cloud backup job deletes compressed copy of the replication segment after the successful upload to the target server. If you don't want to keep these copies on the master server, keep the parameter enabled.
* *Delete local prepared file copy* – by default is Off. It means status means that replication segment will be not deleted by FBDataGuard after uploading. It can be useful if you want to keep the full history of changes in replication segments, but, be careful; in case of an intensive write activity replication segments can occupy a lot of space (Terabytes).
* *Send Ok report* – send email to the specified in Alerts address every time when replication segment is uploaded. By default it is off.

As a result, FBDataGuard will upload encrypted and compressed replication segments to the remote server. To decompress and decrypt them into the regular replication segments, another instance of HQbird FBDataGuard should be installed on the replica server, and Cloud Backup Receiver job should be configured – see more details in the section <<_hqbird_config_cloud_backup_receiver,Database: File Receiver>>.

===== FTP over SSH

image::3.2.49.png[]

To use FTP over SSH with private key authentication, please specify the full path to it in "`Key store file`", other parameters are similar to usual FTP.

[[_hqbird_config_transfer_files]]
=== Database: Transfer Files

The purpose of "Transfer Files" job is to send backup files from master to replica server. In the case of distributed environment, when the network connection between master and replica server is unstable, or with high latency, or when servers are in the different geographical regions, the best way to transfer files will be through FTP or FTP over SSH.

Below we will consider how to setup "Transfer Files" for this task.

First, the database server should be configured to save backup files into the some local folder — by default, it will be `${db.default-directory}/backup` — as it is shown in the example below:

.Transfer File configuration
image::3.2.49-1.png[]

Then we can setup *Transfer Files* job to monitor this folder for the new backup files and upload them to the remote FTP server.

As you can see at the screenshot above, *Transfer Files* job checks folder, specified in “Monitor this folder” with an interval, specified in **“Check period, seconds”**. Please note – Transfer Files sends files in the order of their names, not dates.

By default, Transfer Files compresses and encrypts backup files before send them. The default password is “**zipmasterkey**” (without quotes), which can be specified in the field “**Encrypt when compressing**”. FBDataGuard creates the compressed and encrypted copy of the backup and upload it to the specified target server.

To disable encryption, uncheck the “**Encrypt when compressing**” checkmark.


==== FTP/FTPS/FTPS over SSH

There are several types of target servers: FTP, FTP over SSL/TLS, FTP over SSH. When you select the necessary type, dialog shows mandatory fields to be completed.

You can select up to 5 simultaneous remote servers to upload backups. Below you can see the configuration dialog for FTP.

image::3.2.49-2.png[]


[NOTE]
====
If you don't have FTP installed on the target server with Windows, install Filezilla – it is very popular fast and lightweight FTP-server for Windows.
====

[NOTE]
====
Replication segments will be uploaded to the subdirectory specified in the "`Upload to folder`". By default, this is `/database0/${db.id}`, where `db.id` is the identifier of the database inside the DataGuard. The replica about this `db.id` does not know anything, so you need to register it manually in "`Unpack to directory`" (see <<_hqbird_config_cloud_backup_receiver,File  Receiver>>).
====

===== FTP over SSL/TLS

image::3.2.49-2.png[]

In order to send files to FTPS, it is necessary to create jks storage with private key file, and specify path to it in the field "`Key store file`" and password for it in "`Key store password`".

See details and example how to create jks file and password here: http://xacmlinfo.org/2014/06/13/how-to-keystore-creating-jks-file-from-existing-private-key-and-certificate/

The last part of parameters in Cloud Backup dialog allows controlling the behavior of Cloud backup.

* *Delete local prepared copy* -- by default it is On. This parameter specifies that Transfer Files job deletes compressed copy of the file after the successful upload to the target server. If you don't want to keep these copies on the master server, keep the parameter enabled.
* *Delete local prepared file copy* -- by default is Off. It means status means that file will be not deleted by FBDataGuard after uploading. It can be useful if you want to keep the full history of changes in files, but, be careful; in case of an intensive write activity such files can occupy a lot of space (Terabytes).
* *Send Ok report* -- send email to the specified in Alerts address every time when replication segment is uploaded. By default, it is off.
* *Perform fresh backup* -- disabled by default. Transfer Files remembers the last number of file it sends. If you need to start again from scratch, from file 1, enable this parameter. Please note that it will automatically become disabled after the resetting of the counter.

As a result, FBDataGuard will upload encrypted and compressed files to the remote server. To decompress and decrypt them into the regular files, another instance of HQbird FBDataGuard should be installed on the replica server, and File Receiver job should be configured -- see more details in the section <<_hqbird_config_cloud_backup_receiver,Database: File Receiver>>.

===== FTP over SSH

image::3.2.49-4.png[]

To use FTP over SSH with private key authentication, please specify the full path to it in "`Key store file`", other parameters are similar to usual FTP.

==== Sending verified and incremental backups through Cloud Backups

Cloud Backup also can be used to send any files to FTP/FTPS/etc. For example, you can setup Cloud Backup to look for FBK files, produces by Verified Backup Job, and schedule to upload to the remote FTP server.

It is necessary to remember that number of stored backups should be less than the number of files to be preserved by Cloud Backup (specified in the parameter "`How many files to keep`". By default, Cloud Backup keeps 10 last sent files, and Verified backup has 5 most recent backup files, so it work Ok, but if you will reduce the number of kept files in Cloud Backup, it will delete extra files according "`Filename template`".

The same can be done for incremental backups.

[[_hqbird_config_pump_files]]
=== Database: Pump Files

The purpose of the "Pump Files" task is to transfer files from one directory accessible to the DataGuard to some other location, usually remote, with the possibility of using various methods that can be connected to the DataGuard in the form of plugins and selectable in the task configuration with the ability to set unique for each plugin parameters. HQbird includes two file transfer plugins: fpt and sftp. There are other file transfer plugins. Transfer plugins are jar files and are located in the `Firebird DataGuard/plugins` folder.

Let's consider the options and parameters of this job.

.Options available for the ftp file transfer plugin.
image::3.2.62.png[]

* *Filemask to pump* -- whitelist, according to which files are selected for copying. Represent masks of file names. Must be separated by comma.
* *Exclude file-mask* -- blacklist is a mask of file names that should be excluded from the transfer. The blacklist takes precedence over the whitelist.
* *Pump method* -- file transfer method (plugin).

.Options available for the sftp file transfer plugin.
image::3.2.63.png[]

The algorithm of this task is as follows:

. At each iteration of the task, a list of files is generated for the directory for monitoring files to be sent. Masks are used to select the list of files: "Filemask to pump" and "Exclude file-mask".
. For each selected file (from the list from step 1, in ascending date order from the lastModified file), the following is performed:
.. If the packing option is set, the file is packed (if the file is not of zero size).
The name of the packed file is formed by adding a hardcoded extension: `.zipfilepump`. The file is packed in the same directory.
If the file turns out to be of zero size, the algorithm will consider that the file has not been completed yet and will interrupt sending the rest of the files with a corresponding message.
.. The file sending task is configured for one of several possible sending options using optional plugins (see below).
Depending on whether the packing option was enabled or not, the original or packed file is sent using the specified algorithm (in the current version it is ftp or sftp).
.. After sending, if the packing option was selected, the packed file is deleted.
.. The original file is renamed by adding the extension `.fuploaded`.
. The algorithm proceeds to send the next file from the list. The total number of files sent during the iteration and their original (unpacked) size are summed up for display in the widget
. Upon completion of sending all files from the generated list, the directory is revolving cleaned, from which files are deleted by mask `*.fuploaded`.
That is, a list of all such files is created, it is sorted by the time of the last modification, and all old ones are deleted, except for the last "Keep NN files".
+
Upon completion of sending, if the "Send OK-report on every pump" checkbox is checked, then the user will be sent a report on the number and size of files sent at the current iteration.


[[_hqbird_config_cloud_backup_receiver]]
=== Database: File Receiver

In general, Cloud Backup Receiver is designed to decompress files from zip archives, and the most often it is used in the pair with Cloud Backup to transfer archived replication segments.

Cloud Backup Receiver checks files in the folder specified in "`*Monitor directory*`", with interval equal to "`*Check periods, minutes*`".
Its checks only files with specified mask according "`*Filename template*`" (*arch* by default) and specified extension (`.replpacked` by default), and if it encounters such files, it decompresses and decrypts them with the password, specified in "`*Decrypt password*`", and copies to the folder, specified in "`*Unpack to directory*`".

If parameter "`*Monitor for replication*`" is enabled, Cloud Backup Receiver also will check that received file is actually a replication segment (it has specific header), and if it is not, it will raise an appropriate warning.

image::3.2.50.png[]

There are the following additional parameters:

* *Alert if number of unpacked files more than* – by default is 30. If there is a long queue of replication segments to be unpacked, it can be a problem with a replica database, so HQbird sends alert to attract administrator`'s attention.
* *Warn if the newest file in unpack folder is older than (minutes)* – if the most recent file (usually, replication segment) is too old (more than 360 minutes), the replication process can be broken, and HQbird sends an appropriate alert.
* *Send Ok report* – by default it is Off. If it is On, HQbird sends an email about each successful unpacking of the segment. It can be too often for replication segments, because they are arriving every 30-180 seconds, and Ok for normal files like verified or incremental backups.
* *Perform fresh unpack* – disabled by default. Cloud Backup Receiver remembers the last number of replication segment it unpacked. If you need to start unpacking from scratch, from segment 1 (for example, after re-initialization of replication), enable this parameter. Please note that it will automatically become disabled after the resetting of the counter.

After setup of Cloud Backup Receiver, configure the replica to look for replication segments: set in the "`Log archive directory`" the same path as in "`Cloud Backup Receiver`" -> "`Unpack to directory`".

image::3.2.51.png[]

==== Embedded FTP server

HQbird has embedded FTP server, which is off by default. It is suitable to use embedded FTP server to receive replication segments.

In order to enable embedded FTP server, it is necessary to edit the `ftpsrv.properties` configuration file, which is located in `C:\HQbirdData\config` or `/opt/hqbird/ftpsrv.properties`

By default, it contains the following:

[source]
----
#path in ftpsrv.homedir must be escaped "ftpsrv.homedir=c:\\ftp\\pub"

# or backslashed for ex: "ftpsrv.homedir=c:/ftp/pub"

ftpsrv.enable = false

ftpsrv.port = 8721

ftpsrv.defuser=admin2

ftpsrv.defpsw=strong password2

ftpsrv.homedir=
----

It is necessary to change **ftpsrv.enabled **to *true* and specify the home directory for FTP in *ftpsrv.homedir* parameter. Also, it is recommended to use non-default username and password.

After that, restart FBDataGuard service, and check availability of the FTP.

.Attention -- Linux users!
[IMPORTANT]
====
On the Linux, FBDataGuard service runs under *firebird* user, so FTP home directory also should have permission for user **firebird**.
====

=== Database: Low-level metadata backup

"`Database: Low level metadata backup`" is one of the key jobs of DataGuard, it ensures database protection at low level.

First of all, this job stores raw metadata in special repository, so in case of heavy corruption (due to hardware failure, for example) of database it is possible to use this repository to recover database.

The second purpose of this job is to constantly check all important system tables for consistency. Every 20 minutes it walks through all important system tables in the database and ensures that there are no errors at metadata level.

The third purpose is to warn administrator about too many formats for each tables.

There is an implementation limit in Firebird to have 256 formats per table, however even several formats can greatly increase a chance of hard corruption and can slow down the performance. It is recommended do not change tables structure at production database and keep only one format per each table.
If it`'s not possible, administrator should try to perform backup/restore more often to transform all formats into the single one.

image::3.2.52.png[]


=== Database: Validate DB

Validation of Firebird database requires exclusive access: i.e., no users should be connected during validation. "`Database: Validate DB`" job shuts down the database and performs validation of database, and then turns it on.

By default, this job is OFF. Please consider carefully, is it possible to provide exclusive access for database. Validation can also take significant time.

image::3.2.53.png[]

Using configuration dialog, you can enable/disable this job, set time to run, set the shutdown timeout (time to wait before launch validation), and also shutdown mode (FORCE, ATTACH, TRANSNATIONAL). If you have no deep knowledge n what you are doing, it's better to keep default parameters.

"`Database: Validate DB`" will send alert with critical status if there will be any errors.

Also, Firebird will write errors into `firebird.log`, and they will appear in the alerts generated by "`Server log`" job.

=== Database: Sweep Schedule

FBDataGuard includes special job to run an explicit sweep, in case if automatic sweep was disabled. By default, job is disabled.

image::3.2.54.png[]

The recommendation is to schedule explicit sweep with disconnection of long-running transactions for all databases where such transactions are detected. The recommended period is once per day (usually during the night, after backup's completing).

By default, sweep is set to 23-00, which can be not a good time, because default verified backup starts at the same time, so better change it.

image::3.2.55.png[]

Please note: by default, check mark "`*Disconnect all connections with long-running active transactions before sweep*`" is enabled. It means that HQbird will find and disconnect long-running transactions (more than 30 minutes) before sweep -- in order to make sweep efficient. If long-running active transactions will be not disconnected, sweep cannot clean old records versions.

"`*Do not disconnect processes with name pattern*`" -- in this parameter specify SIMILAR TO expression for processes names which will be not disconnected.
By default, we exclude `gbak`, `gstat` and `fbsvcmgr` processes.

"`*Disconnect all processes older than (minutes)*`" -- HQbird will disconnect processes which have long-running active writeable transactions, by default threshold is 30 minutes. The practical upper limit for this parameter is 1440 minutes (it is highly unlikely that transaction does something useful more than 1 day).

"`*Use multiple cores to sweep*`" -- HQbird Enterprise can use multiple cores to perform sweep operation, in order to make sweep 4-6 times faster. We recommend to specify no more than 1/2 CPU cores in case of the single database on the server, or 1/4 of CPU cores if there are several databases. For example, if you have 16 cores and 1 big database, set this parameter to 8, if there are several big databases, set 4.

=== Database: Disk space

This job watches for all objects related with database: database files (including volumes of multi-volume database), delta-files, backup files and so on.

"`Database: Disk space`" job analyzes the growth of database and estimate will there be enough free space for the next operation like backup (including test restore) on the specific hard drive.

It generates several types of alerts. Problems with disk space are in the top list of corruption reasons, so please pay attention to the alerts from this job.

This job also contributes data to the server space analysis graph ().

By default, this job is enabled.

Using configuration dialog, you can specify check period and thresholds for free space. The first reached threshold will be alerted. To set threshold only in % of disk space, you need to set explicit space in bytes to 0.

image::3.2.57.png[]

=== Database: Database statistics

This job is very useful to capture performance problems and perform overall check of database at low-level without making backup.

image::3.2.58.png[]

We recommend running this job every day and storing a history of statistics report.

Then, with HQbird Database IBAnalyst it is possible to find problems with database performance and get useful recommendations how to fix them.

[NOTE]
====
As a useful side effect, `gstat` visits all database pages for tables and indices, and ensures that all of them are correct.
====

=== Database: Replica Check

This task allows you to check the availability of the replica database. After a specified period, it changes the value of the specified generator and compares the value of the generator on the replica side and the master database.

image::3.2.58-1.png[]

*Min diff to alert* -- the difference between the values of the generator on the master and replica side, after which alter are sent.

<<<

== Email alerts in HQbird FBDataGuard

FBDataGuard can send alerts by email to administrator(s): such alerts contain information about successful backups and potential and real problems with databases.

General properties for notifications can be set by clicking on the server name (or computer name) at the top of the web-console:

image::3.1.7-0.png[]

After that you will see the configuration dialog for common alerts settings:

image::3.1.7-1.png[]

Descriptions of some of the properties you can set here:

* "`*Installation name*`" is some readable name for your convenience; it will be referred in emails and alerts.
* "`*Installation GUID*`" is a service field; there is no need to change it.
* "`*Web console background color*`" – often it is useful to adjust the color of HQbird web interface to distinguish them easily.

It's a good idea to enable setup email alerts. To do this you need to click on the envelope button in the top of the web-console:

image::3.1.7.png[]

After that you will see the configuration dialog for alerts:

.Email alerts configuration dialog in FBDataGuard.
image::3.1.8.png[]

First of all, you need to enable alerts sending by enabling checkbox "`Send alerts by e-mail`".

* "`*Send alerts by email*`" - enable email alerts and configure email settings below.
* "`*Send alerts to*`" specify where to send emails.
* "`*From field*`" is what will be set as sender in the email.
* "`SMTP server address`", "`SMTP server port`", "`SMTP server login`" and "`SMTP server password`" are data which will be used to send emails.

Before saving the settings, you can click the "Send Test Message" button, if the settings are correct, you should receive a letter to the specified address.

In order to limit the number of letters, you can collect messages into groups and send them in batches. To do this, set "Group notifications in emails" checkbox. It will also help bypass some of the atni-spam systems that can blacklist you due to too frequent send emails.

Click "`Save`" to save email alerts settings.

<<<

== Советы и рекомендации FBDataGuard

FBDataGuard позволяет менять его настройки не только через веб-консоль, но и путем прямого изменения файлов конфигурации. Это может быть полезно, когда вам нужно установить FBDataGuard в автоматическом режиме (без взаимодействия с пользователем), связать его со сторонним программным обеспечением или выполнить некоторые тонкие настройки конфигурации.

=== Путь к конфигурации FBDataGuard

При запуске FBDataGuard ищет в реестре пути конфигурации и вывода:

image::3.2.61.png[]

Эти значения указывают пути к конфигурации FBDataGuard и выходной папке. Они выбираются во время установки.

[[_hqbird_config_fbdataguard_port]]
=== Настройка порта веб-консоли

Один из наиболее часто задаваемых вопросов -- как настроить порт для приложения веб-консоли (по умолчанию это 8082). Это можно сделать, изменив настройку порта в файле `%config%\agent\agent.properties` (`%config %` -- это `C:\HQbirdData\config` или `/opt/hqbird/conf`).

[listing]
----
server.port = 8082  #change it
----

`%config%` -- папка для хранения информации о конфигурации, в которой она указана.

=== Как изменить пароль администратора

Вы можете указать этот пароль в файле `access.properties` (в `C:\HQbirdData\config` или `/opt/hqbird/conf`)

[listing]
----
access.login=admin

access.password=youradminpasswordforhqbird
----

После установки пароля перезапустите FBDataGuard, и новый пароль будет зашифрован и применен.

=== Гостевой пользователь HQbird FBDataGuard

Для доступа к HQbird FBDataGuard существует пользователь только для чтения с именем `guest`.

[listing]
----
access.guest-login=guest

access.guest-password=yournewpassword
----

<<<

[[_hqbird_config_cron_expr]]
== Приложение: Выражения CRON

Все задания в FBDataGuard имеют настройки времени в формате CRON. CRON -- очень простой и мощный формат для планирования времени выполнения.

=== Формат CRON

Выражение CRON представляет собой строку, состоящую из 6 или 7 полей, разделенных пробелами. Поля могут содержать любые разрешенные значения, а также различные комбинации разрешенных специальных символов для этого поля. Поля следующие:

[cols="1,1,1,1", frame="topbot", options="header"]
|===
| Имя поля
| Обязательное
| Допустимые значения
| Допустимые специальные символы


|Секунды
|Да
|0-59
|, - * /

|Минуты
|Да
|0-59
|, - * /

|Часы
|Да
|0-23
|, - * /

|День месяца
|Да
|1-31
|, - * / L W

|Месяц
|Да
|1-12 или JAN-DEC
|, - * /

|День недели
|Да
|1-7 или SUN-SAT
|, - * / L #

|Год
|Нет
|empty, 1970-2099
|, - * /
|===

Таким образом, выражения cron могут быть такими простыми: `\* * * * ? *` или более сложными, например: `0 0/5 14,18,3-39,52 ? JAN,MAR,SEP MON-FRI 2002-2010`

=== Специальные символы

* `{asterisk}` ("`все значения`") -- используется для выбора всех значений в поле.
Например, "`{asterisk}`" в поле минуты обозначает "`каждую минуту`".

* `?` ("`нет конкретного значения`") -- полезно, когда вам нужно указать что-то в одном из двух полей, в котором разрешен символ, но не в другом.
Например, если я хочу, чтобы мой триггер сработал в определенный день месяца (скажем, 10-го числа), но меня не волнует, какой это будет день недели. Тогда необходимо поместить "`10`" в поле день месяца и "`?`" в поле день недели. См. пояснительные примеры ниже.

* `-` -- используется для указания диапазонов.
Например, "`10-12`" в поле часы обозначает "`10, 11 и 12 час`".

* `,` -- используется для указания дополнительных значений.
Например, `MON,WED,FRI` в поле день недели обозначает "`Понедельник, Среда и Пятница`".

* `/` -- используется для указания приращений.
Например, "`0/15`" в поле секунды обозначает "`0, 15, 30, и 45 секунду`".
А "`5/15`" в поле секунды обозначает "`5, 20, 35, и 50 секунду`".
Вы также можете указать "`/`" после символа "`{asterisk}`" -- в этом случае "`{asterisk}`" эквивалентна наличию "`0`" до "`/`". "`1/3`" в поле день месяца обозначает "`срабатывать каждые 3 дня начиная с первого дня месяца`".

* `L` ("`last`") -- имеет разное значение в каждом из двух полей, в которых оно разрешено.
Например, значение "`L`" в поле день месяца обозначает "`последний день месяца`" -- 31 января, 28 день Февраля в невисокосные годы.
Если оно используется в поле день недели, то это просто обозначает "`7`" или "`SAT`".
Но если оно используется в поле дня недели после другого значения, то оно означает "`последний xxx день месяца`" -- например "`6L`" обозначает "`последняя Пятница месяца`".
При использовании опции "`L`" важно не указывать списки или диапазоны значений, так как вы получите запутанные результаты.

* `W` ("`weekday`") -- используется для указания дня недели (Понедельник-Пятница) ближайшего к данному дню. (Дня рабочей недели).
Например, если вы указали "`15W`" в качестве значения в поле день месяца, то это обозначает: "`ближайший день недели к 15 числу месяца`".
Таким образом, если 15-е число -- суббота, то триггер сработает в пятницу 14-го.
Если 15-е число выпадает на воскресенье, триггер сработает в понедельник 16-го числа.
Если 15-е число -- вторник, то сработает во вторник 15-го.
Однако если вы укажете "`1W`" в качестве значения для дня месяца, а 1-е число -- суббота, то триггер сработает в понедельник, 3-го числа, так как он не будет "`перепрыгивать`" через границу дня месяца.
Символ "`W`" можно указать только в том случае, если день месяца представляет собой один день, а не диапазон или список.
+
[NOTE]
====
Символы "`L`" и "`W`" также можно объединить в поле день месяца, чтобы получить "`LW`", что переводится как "`последний день недели месяца`".
====

* `#` -- используется для указания "`n-ого`" XXX дня месяца.
Например, значение "`6#3`" в поле дня недели означает "`третью пятницу месяца`" (день 6 = Пятница и "`#3`" = третья пятница месяца). Другие примеры: "`2#1`" = первый понедельник месяца, "`4#5`" = пятая среда месяца.
Обратите внимание, что если вы укажете "`#5`" и в месяце нет пяти заданных дней недели, то в этом месяце триггер не сработает.

[NOTE]
====
Специальные символы и названия дней и месяцев не чувствительны к регистру символов. "`MON`" -- то же самое, что и "`mon`".
====

=== Примеры CRON

Вот несколько полных примеров:

[cols="1,1", frame="topbot", options="header"]
|===
| Выражение
| Значение


|`0 0 12 * * ?`
|Запуск в 12:00 (полдень) каждый день.

|`0 15 10 ? * *`
|Запуск в 10:15 каждый день.

|`0 15 10 * * ?`
|Запуск в 10:15 каждый день.

|`0 15 10 * * ? *`
|Запуск в 10:15 каждый день.

|`0 15 10 * * ? 2005`
|Запуск в 10:15 каждый день в течении 2005 года.

|`0 * 14 * * ?`
|Запуск каждую минуту, начиная с 14:00 и заканчивая 14:59, каждый день.

|`0 0/5 14 * * ?`
|Запуск каждые 5 минут, начиная с 14:00 и заканчивая 14:55, каждый день.

|`0 0/5 14,18 * * ?`
|Запуск каждые 5 минут, начиная с 14:00 и заканчивая 14:55, и запуск каждые 5 минут, начиная с 18:00 и заканчивая 18:55, каждый день.

|`0 0-5 14 * * ?`
|Запуск каждую минуту, начиная с 14:00 и заканчивая 14:05, каждый день.

|`0 10,44 14 ? 3 WED`
|Запуск в 14:10 и в 14:44 каждую среду в марте.

|`0 15 10 ? * MON-FRI`
|Запуск в 10:15 каждый понедельник, вторник, среду, четверг и пятницу.

|`0 15 10 15 * ?`
|Запуск в 10:15 15-го числа каждого месяца.

|`0 15 10 L * ?`
|Запуск в 10:15 в последний день каждого месяца.

|`0 15 10 ? * 6L`
|Запуск в 10:15 в последнюю пятницу каждого месяца.

|`0 15 10 ? * 6L 2002-2005`
|Запуск в 10:15 каждую последнюю пятницу каждого месяца в 2002, 2003, 2004 и 2005 годах.

|`0 15 10 ? * 6#3`
|Запуск в 10:15 в третью пятницу каждого месяца.

|`0 0 12 1/5 * ?`
|Запуск в 12:00 (полдень) каждые 5 дней каждого месяца, начиная с первого числа месяца.

|`0 11 11 11 11 ?`
|Запуск каждое 11 ноября в 11:11.
|===

[IMPORTANT]
====
Обратите внимание на эффекты '?' и '*' в полях дня недели и дня месяца!
====

=== Замечания

Поддержка указания значения дня недели и дня месяца не является полной (в настоящее время необходимо использовать символ '?' в одном из этих полей).

Будьте осторожны, устанавливая время пожара между полуночью и 1:00 ночи — "`переход на летнее время`" может привести к пропуску или повторению в зависимости от того, перемещается ли время назад или вперед.

Больше информации читайте http://www.quartz-scheduler.org/docs/tutorials/crontrigger.html[]
